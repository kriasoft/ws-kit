# .codecov.yml â€” Coverage configuration for WS-Kit
# Optimized for a public TypeScript monorepo with multiple platform/validator adapters

codecov:
  require_ci_to_pass: yes
  notify:
    after_n_builds: 1

coverage:
  precision: 2
  round: down
  range: "70...100"

  status:
    project:
      default:
        target: auto
        threshold: 2%
        base: auto
    patch:
      default:
        target: 77%
        threshold: 1%

comment:
  layout: "reach, diff, flags, files"
  behavior: default
  require_changes: no

# Exclude test, build, and documentation artifacts from coverage calculations
ignore:
  - "dist"
  - "build"
  - "**/node_modules"
  - "**/test/"
  - "**/test-utils/"
  - "**/__tests__/"
  - "**/__mocks__/"
  - "**/*.test.ts"
  - "**/*.spec.ts"
  - "**/test/**/*.ts"
  - "examples/"
  - "docs/"
  - "posts/"
  # Platform-specific integration code not covered by unit tests
  - "packages/bun/src/serve.ts" # Bun server initialization and HTTP integration
  - "packages/bun/src/websocket.ts" # Bun WebSocket platform bindings
  # Utilities and infrastructure not critical to core business logic
  - "packages/core/src/logger.ts" # Logging infrastructure
  - "packages/core/src/throttle.ts" # Throttling utilities (not currently in use)
  - "packages/core/src/utils.ts" # Helper utilities with limited usage

# Track coverage separately per package for visibility in the Codecov UI
flags:
  # Core router (foundation for all packages)
  core:
    paths:
      - "packages/core/src/"
    carryforward: yes

  # Platform adapters
  bun:
    paths:
      - "packages/bun/src/"
  cloudflare-do:
    paths:
      - "packages/cloudflare-do/src/"

  # Client SDK
  client:
    paths:
      - "packages/client/src/"

  # Middleware utilities
  middleware:
    paths:
      - "packages/middleware/src/"

  # PubSub adapters
  redis-pubsub:
    paths:
      - "packages/redis-pubsub/src/"

  # Validator adapters
  zod:
    paths:
      - "packages/zod/src/"
  valibot:
    paths:
      - "packages/valibot/src/"

  # Shared adapter contracts
  adapters:
    paths:
      - "packages/adapters/src/"

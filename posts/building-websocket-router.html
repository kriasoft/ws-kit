<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>‚ö° WS-Kit</title>
    <meta name="description" content="Schema-first WebSocket message router for Bun with TypeScript validation">
    <meta name="generator" content="VitePress v2.0.0-alpha.12">
    <link rel="preload stylesheet" href="/ws-kit/assets/style.BWtmscew.css" as="style">
    <link rel="preload stylesheet" href="/ws-kit/vp-icons.css" as="style">
    
    <script type="module" src="/ws-kit/assets/app.CEi3ZQfk.js"></script>
    <link rel="preload" href="/ws-kit/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/theme.BZPPR5VJ.js">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/framework.xlyBlKIJ.js">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/posts.data.D-4OZZJY.js">
    <link rel="modulepreload" href="/ws-kit/assets/posts_building-websocket-router.md.DCfNLFPT.lean.js">
    <link rel="icon" href="/ws-kit/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="Bun WebSocket Router | Schema-First WebSocket Routing">
    <meta property="og:site_name" content="Bun WebSocket Router">
    <meta property="og:url" content="https://kriasoft.com/ws-kit/">
    <meta property="og:image" content="https://kriasoft.com/ws-kit/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="canonical" href="https://medium.com/gitconnected/building-type-safe-websocket-applications-with-bun-and-zod-f0aef259a53e">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-7763c96d data-v-c8fbc71f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-b6c575da></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-b6c575da>Skip to content</a><!--]--><!----><header class="VPNav" data-v-c8fbc71f data-v-7a51ad0f><div class="VPNavBar" data-v-7a51ad0f data-v-7e8f2234><div class="wrapper" data-v-7e8f2234><div class="container" data-v-7e8f2234><div class="title" data-v-7e8f2234><div class="VPNavBarTitle" data-v-7e8f2234 data-v-d1c1f9aa><a class="title" href="/ws-kit/" data-v-d1c1f9aa><!--[--><!--]--><!----><span data-v-d1c1f9aa>‚ö° WS-Kit</span><!--[--><!--]--></a></div></div><div class="content" data-v-7e8f2234><div class="content-body" data-v-7e8f2234><!--[--><!--]--><div class="VPNavBarSearch search" data-v-7e8f2234><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-7e8f2234 data-v-57459af6><span id="main-nav-aria-label" class="visually-hidden" data-v-57459af6> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/" tabindex="0" data-v-57459af6 data-v-a53e5e26><!--[--><span data-v-a53e5e26>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/getting-started" tabindex="0" data-v-57459af6 data-v-a53e5e26><!--[--><span data-v-a53e5e26>Docs</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/posts/" tabindex="0" data-v-57459af6 data-v-a53e5e26><!--[--><span data-v-a53e5e26>Blog</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-7e8f2234 data-v-644e7d92><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-644e7d92 data-v-10ed865e data-v-b647622f><span class="check" data-v-b647622f><span class="icon" data-v-b647622f><!--[--><span class="vpi-sun sun" data-v-10ed865e></span><span class="vpi-moon moon" data-v-10ed865e></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-7e8f2234 data-v-75fcd270 data-v-b4c0469c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-bluesky"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-7e8f2234 data-v-798876bf data-v-37c4b66b><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-37c4b66b><span class="vpi-more-horizontal icon" data-v-37c4b66b></span></button><div class="menu" data-v-37c4b66b><div class="VPMenu" data-v-37c4b66b data-v-35c86a22><!----><!--[--><!--[--><!----><div class="group" data-v-798876bf><div class="item appearance" data-v-798876bf><p class="label" data-v-798876bf>Appearance</p><div class="appearance-action" data-v-798876bf><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-798876bf data-v-10ed865e data-v-b647622f><span class="check" data-v-b647622f><span class="icon" data-v-b647622f><!--[--><span class="vpi-sun sun" data-v-10ed865e></span><span class="vpi-moon moon" data-v-10ed865e></span><!--]--></span></span></button></div></div></div><div class="group" data-v-798876bf><div class="item social-links" data-v-798876bf><div class="VPSocialLinks social-links-list" data-v-798876bf data-v-b4c0469c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-b4c0469c data-v-ebe90296><span class="vpi-social-bluesky"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-7e8f2234 data-v-5b112d40><span class="container" data-v-5b112d40><span class="top" data-v-5b112d40></span><span class="middle" data-v-5b112d40></span><span class="bottom" data-v-5b112d40></span></span></button></div></div></div></div><div class="divider" data-v-7e8f2234><div class="divider-line" data-v-7e8f2234></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-c8fbc71f data-v-bb952666><div class="container" data-v-bb952666><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-bb952666 data-v-2a193549><button data-v-2a193549>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-c8fbc71f data-v-868b4d77><div class="VPDoc has-aside" data-v-868b4d77 data-v-7886d922><!--[--><!--]--><div class="container" data-v-7886d922><div class="aside" data-v-7886d922><div class="aside-curtain" data-v-7886d922></div><div class="aside-container" data-v-7886d922><div class="aside-content" data-v-7886d922><div class="VPDocAside" data-v-7886d922 data-v-61feb31b><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-61feb31b data-v-f1cd88a2><div class="content" data-v-f1cd88a2><div class="outline-marker" data-v-f1cd88a2></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f1cd88a2>On this page</div><ul class="VPDocOutlineItem root" data-v-f1cd88a2 data-v-22610897><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-61feb31b></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7886d922><div class="content-container" data-v-7886d922><!--[--><!--[--><!--[--><h1 data-v-7763c96d>Building Type-Safe WebSocket Applications with Bun and WS-Kit</h1><!----><!--]--><!--]--><!--]--><main class="main" data-v-7886d922><div style="position:relative;" class="vp-doc _ws-kit_posts_building-websocket-router" data-v-7886d922><div data-v-c6285ced><!----><blockquote data-v-c6285ced><p data-v-c6285ced>üöÄ Type-safe WebSockets for Bun! WS-Kit combines pluggable validators with clean routing, replacing messy switch statements with validated, maintainable real-time handlers.</p></blockquote><h2 id="introduction" tabindex="-1" data-v-c6285ced>Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to ‚ÄúIntroduction‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>In the ever-evolving world of web development, real-time interactions have become less of a luxury and more of an expectation. Whether you‚Äôre building a chat application, a collaborative document editor, or a multiplayer game, the need for bidirectional communication is clear, and WebSockets are often the technology of choice.</p><p data-v-c6285ced>But let‚Äôs be honest: working with WebSockets can sometimes feel like trying to organize a party where guests randomly shout things at each other across the room. Messages fly back and forth, payload structures are inconsistent, and before you know it, your elegant application architecture looks more like a tangled ball of holiday lights that you‚Äôve promised yourself you‚Äôll sort out ‚Äúnext year.‚Äù</p><h3 id="enter-bun-and-zod" tabindex="-1" data-v-c6285ced>Enter Bun and Zod <a class="header-anchor" href="#enter-bun-and-zod" aria-label="Permalink to ‚ÄúEnter Bun and Zod‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced><a href="https://bun.sh/" target="_blank" rel="noreferrer" data-v-c6285ced>Bun</a> has been making waves as a fast JavaScript runtime with built-in WebSocket support that‚Äôs both performant and easy to work with. Its native WebSocket implementation (based on uWebSockets) outperforms many alternatives, making it an excellent foundation for real-time applications.</p><p data-v-c6285ced>Meanwhile, <a href="https://zod.dev/" target="_blank" rel="noreferrer" data-v-c6285ced>Zod</a> has revolutionized runtime type validation in the JavaScript ecosystem. It provides a way to define schemas that guarantee the shape and type of your data, catching errors before they wreak havoc in your application.</p><h3 id="the-challenge-of-websocket-communication" tabindex="-1" data-v-c6285ced>The Challenge of WebSocket Communication <a class="header-anchor" href="#the-challenge-of-websocket-communication" aria-label="Permalink to ‚ÄúThe Challenge of WebSocket Communication‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>When building applications with WebSockets, several challenges typically arise:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Type safety across the wire</strong>: Unlike HTTP requests with well-defined endpoints and schemas, WebSocket messages can be a wild west of untyped JSON.</li><li data-v-c6285ced><strong data-v-c6285ced>Message routing complexity</strong>: As your application grows, so does the variety of messages you need to handle. Without a structured system, this often results in sprawling switch statements or complex conditionals.</li><li data-v-c6285ced><strong data-v-c6285ced>Error handling</strong>: When a message doesn‚Äôt match your expectations, how do you gracefully handle it and provide meaningful feedback?</li><li data-v-c6285ced><strong data-v-c6285ced>Connection lifecycle management</strong>: Who‚Äôs connected? What rooms are they in? How do you manage authentication state across a persistent connection?</li></ol><h3 id="introducing-ws-kit" tabindex="-1" data-v-c6285ced>Introducing WS-Kit <a class="header-anchor" href="#introducing-ws-kit" aria-label="Permalink to ‚ÄúIntroducing WS-Kit‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>To address these challenges, we&#39;ve created <strong data-v-c6285ced>WS-Kit</strong> ‚Äî a type-safe WebSocket router for Bun and other platforms. It combines pluggable validators (Zod, Valibot, custom) with Bun&#39;s WebSocket implementation to create a structured, maintainable approach to real-time messaging.</p><p data-v-c6285ced>At its core, <strong data-v-c6285ced>WS-Kit</strong> gives you:</p><ul data-v-c6285ced><li data-v-c6285ced>A way to define message types with Zod schemas</li><li data-v-c6285ced>A router that automatically validates incoming messages against these schemas</li><li data-v-c6285ced>Handlers that receive only properly typed message payloads</li><li data-v-c6285ced>Built-in support for broadcasting and room-based communication</li><li data-v-c6285ced>Clean error handling patterns</li></ul><p data-v-c6285ced>Instead of wrestling with raw WebSocket messages, you can think in terms of typed routes, similar to how you&#39;d structure a REST API. This approach brings clarity and maintainability to what would otherwise be chaotic message passing.</p><p data-v-c6285ced>In this tutorial, we&#39;ll build a real-time application from the ground up using Bun and <strong data-v-c6285ced>WS-Kit</strong>. We&#39;ll start with the basics of WebSocket communication in Bun, then gradually introduce type safety with Zod, and finally implement more advanced patterns like authentication and room-based messaging.</p><p data-v-c6285ced>By the end, you‚Äôll have a solid foundation for building robust, type-safe real-time applications that can scale with your needs. No more digging through message payloads with <code data-v-c6285ced>console.log</code> at 2 AM, wondering why your users are seeing gibberish on their screens instead of the latest game state.</p><p data-v-c6285ced>So grab your favorite beverage, fire up your code editor, and let‚Äôs bring some order to the WebSocket chaos. Your future self ‚Äî the one who has to maintain this code six months from now ‚Äî will thank you.</p><h2 id="part-1-websockets-fundamentals-in-bun" tabindex="-1" data-v-c6285ced>Part 1: WebSockets Fundamentals in Bun <a class="header-anchor" href="#part-1-websockets-fundamentals-in-bun" aria-label="Permalink to ‚ÄúPart 1: WebSockets Fundamentals in Bun‚Äù" data-v-c6285ced>‚Äã</a></h2><h3 id="what-are-websockets-and-why-use-them" tabindex="-1" data-v-c6285ced>What Are WebSockets and Why Use Them? <a class="header-anchor" href="#what-are-websockets-and-why-use-them" aria-label="Permalink to ‚ÄúWhat Are WebSockets and Why Use Them?‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Remember the days of polling a server every few seconds to check for updates? Like repeatedly asking ‚ÄúAre we there yet?‚Äù on a road trip, except the server is the increasingly annoyed parent. That‚Äôs the world WebSockets were designed to rescue us from.</p><p data-v-c6285ced>Unlike traditional HTTP connections that follow a request-response pattern, WebSockets establish a persistent, two-way communication channel between clients and servers. Once established, both sides can send messages to each other at any time without the overhead of creating new connections. This makes WebSockets perfect for:</p><ul data-v-c6285ced><li data-v-c6285ced>Real-time chat applications</li><li data-v-c6285ced>Live dashboards and data visualizations</li><li data-v-c6285ced>Multiplayer games</li><li data-v-c6285ced>Collaborative editing tools</li><li data-v-c6285ced>Notification systems</li><li data-v-c6285ced>Stock tickers and sports scores</li></ul><p data-v-c6285ced>In essence, anywhere you need low-latency, bidirectional communication, WebSockets are your friend.</p><h3 id="bun-s-native-websocket-implementation" tabindex="-1" data-v-c6285ced>Bun‚Äôs Native WebSocket Implementation <a class="header-anchor" href="#bun-s-native-websocket-implementation" aria-label="Permalink to ‚ÄúBun‚Äôs Native WebSocket Implementation‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced><a href="https://bun.sh/" target="_blank" rel="noreferrer" data-v-c6285ced>Bun</a> comes with a blazing-fast, native WebSocket implementation built right in. No need to reach for additional packages like <code data-v-c6285ced>ws</code> or <code data-v-c6285ced>socket.io</code> (though they&#39;re excellent tools in their own right). Bun&#39;s implementation is:</p><ul data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Fast</strong>: Built on top of Bun‚Äôs optimized JavaScript runtime</li><li data-v-c6285ced><strong data-v-c6285ced>Memory-efficient</strong>: Uses less memory than Node.js alternatives</li><li data-v-c6285ced><strong data-v-c6285ced>Standards-compliant</strong>: Follows the WebSocket protocol (RFC 6455)</li><li data-v-c6285ced><strong data-v-c6285ced>Feature-rich</strong>: Includes built-in support for the PubSub pattern</li></ul><p data-v-c6285ced>This native implementation means you can start building real-time applications immediately without any external dependencies for the WebSocket functionality itself.</p><h3 id="setting-up-a-basic-websocket-server-in-bun" tabindex="-1" data-v-c6285ced>Setting Up a Basic WebSocket Server in Bun <a class="header-anchor" href="#setting-up-a-basic-websocket-server-in-bun" aria-label="Permalink to ‚ÄúSetting Up a Basic WebSocket Server in Bun‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Let‚Äôs create a simple WebSocket echo server to demonstrate how easy it is to get started with Bun. Create a new file called <code data-v-c6285ced>server.ts</code>:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Extract URL from the request</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req.url);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Handle WebSocket upgrade requests</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (url.pathname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Upgrade HTTP request to WebSocket connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> server.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>upgrade</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Return a fallback response if upgrade fails</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>success) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket upgrade failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // The connection is handled by the websocket handlers</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Handle regular HTTP requests</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;Hello from Bun! Try connecting to /ws with a WebSocket client.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Define what happens when a WebSocket connects</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  websocket: {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Called when a WebSocket connection is established</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket connection opened&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &quot;Welcome to the echo server! Send me a message and I&#39;ll send it right back.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Called when a message is received</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Received: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Echo the message back</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`You said: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Called when the connection closes</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`WebSocket closed with code ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>code</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} and reason: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>reason</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Called when there&#39;s an error</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`WebSocket error: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>error</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket echo server listening on ws://localhost:3000/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span></code></pre></div><p data-v-c6285ced>To run this example:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> server.ts</span></span></code></pre></div><h2 id="connecting-from-a-browser-client" tabindex="-1" data-v-c6285ced>Connecting from a Browser Client <a class="header-anchor" href="#connecting-from-a-browser-client" aria-label="Permalink to ‚ÄúConnecting from a Browser Client‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>Now let‚Äôs create a simple HTML client to connect to our WebSocket server:</p><div class="language-html" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>html</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;!</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>DOCTYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>html</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> lang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;en&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> charset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;WebSocket Test&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>      body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        font-family</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>system-ui</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>sans-serif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        max-width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>800</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      #messages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>300</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        border</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> solid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> #ccc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        margin-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        overflow-y</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      #messageForm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        gap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      #messageInput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        flex-grow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>h1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Bun WebSocket Echo Test&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>h1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Disconnected&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>form</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messageForm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>input</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;text&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messageInput&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> placeholder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Type a message...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;submit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Send&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>form</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> statusEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messagesEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageFormEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messageForm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageInputEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messageInput&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Create a WebSocket connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> socket</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;ws://localhost:3000/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Connection opened</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;open&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Connected&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.style.color </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;green&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>        addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;System&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connected to server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Listen for messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>        addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, event.data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Connection closed</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Disconnected&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.style.color </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;red&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>        addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;System&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Disconnected: Code ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>code</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Connection error</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        statusEl.style.color </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;red&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>        addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;System&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connection error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, event);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      messageFormEl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;submit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>preventDefault</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> messageInputEl.value;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> socket.readyState </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> WebSocket.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>OPEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>          addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;You&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          messageInputEl.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Helper to add message to the UI</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> addMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>sender</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;div&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        messageEl.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `&lt;strong&gt;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>sender</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}:&lt;/strong&gt; ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>content</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        messagesEl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(messageEl);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        messagesEl.scrollTop </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> messagesEl.scrollHeight;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span></code></pre></div><p data-v-c6285ced>Open this HTML file in a browser, and you should be able to send messages to your Bun WebSocket server and see the echoed responses.</p><h2 id="understanding-the-websocket-lifecycle" tabindex="-1" data-v-c6285ced>Understanding the WebSocket Lifecycle <a class="header-anchor" href="#understanding-the-websocket-lifecycle" aria-label="Permalink to ‚ÄúUnderstanding the WebSocket Lifecycle‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>WebSockets follow a specific lifecycle:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Connection</strong> ‚Äî The client initiates a handshake by sending an HTTP request with an <code data-v-c6285ced>Upgrade: websocket</code> header. If the server accepts, it responds with a <code data-v-c6285ced>101 Switching Protocols</code> status.</li><li data-v-c6285ced><strong data-v-c6285ced>Open</strong> ‚Äî After a successful handshake, the WebSocket connection is established and the <code data-v-c6285ced>open</code> event fires.</li><li data-v-c6285ced><strong data-v-c6285ced>Message Exchange</strong> ‚Äî Both client and server can send messages at any time.</li><li data-v-c6285ced><strong data-v-c6285ced>Closing</strong> ‚Äî Either side can initiate closing the connection with a close code and reason.</li><li data-v-c6285ced><strong data-v-c6285ced>Closed</strong> ‚Äî The connection is terminated. No more messages can be sent.</li></ol><h2 id="the-challenge-of-raw-websocket-messages" tabindex="-1" data-v-c6285ced>The Challenge of Raw WebSocket Messages <a class="header-anchor" href="#the-challenge-of-raw-websocket-messages" aria-label="Permalink to ‚ÄúThe Challenge of Raw WebSocket Messages‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>While our echo server is simple, real applications quickly become more complex. As soon as you start building a non-trivial application, you‚Äôll encounter challenges:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Message Format</strong>: Should you use JSON? Binary? Some custom format?</li><li data-v-c6285ced><strong data-v-c6285ced>Message Types</strong>: How do you distinguish between different kinds of messages?</li><li data-v-c6285ced><strong data-v-c6285ced>Routing Logic</strong>: How do you direct messages to the appropriate handlers?</li><li data-v-c6285ced><strong data-v-c6285ced>Error Handling</strong>: What happens when a message isn‚Äôt formatted correctly?</li></ol><p data-v-c6285ced>Let‚Äôs upgrade our example to handle JSON messages with a <code data-v-c6285ced>type</code> field:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  content</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req.url);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (url.pathname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> server.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>upgrade</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> success</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        :</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket upgrade failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { status: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>400</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Hello from Bun!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  websocket: {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connection opened&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Parse the incoming message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Handle different message types</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (message.type) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;CHAT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Chat message: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>content</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>            // Echo back with a timestamp</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>              JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;CHAT_ECHO&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                content: {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                  original: message.content.text,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                  timestamp: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toISOString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;PING&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>              JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;PONG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                content: { timestamp: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toISOString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>              JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>                content: { message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Unknown message type: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>            break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Error processing message:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>          JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            content: { message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Could not parse message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>code</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Connection closed: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>code</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>reason</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Improved WebSocket server running on ws://localhost:3000/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span></code></pre></div><h3 id="the-problem-with-this-approach" tabindex="-1" data-v-c6285ced>The Problem with This Approach <a class="header-anchor" href="#the-problem-with-this-approach" aria-label="Permalink to ‚ÄúThe Problem with This Approach‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Even in this simple example, we‚Äôre already seeing issues:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Type Safety</strong>: The <code data-v-c6285ced>as ChatMessage</code> cast doesn&#39;t guarantee the message actually has the right structure.</li><li data-v-c6285ced><strong data-v-c6285ced>Error Prone</strong>: It‚Äôs easy to typo a message type or forget a field.</li><li data-v-c6285ced><strong data-v-c6285ced>Scaling Issues</strong>: As you add more message types, the switch statement becomes unwieldy.</li><li data-v-c6285ced><strong data-v-c6285ced>Maintenance Burden</strong>: There‚Äôs no centralized definition of message structures.</li></ol><p data-v-c6285ced>This is where <strong data-v-c6285ced>WS-Kit</strong> comes in, providing a structured approach to handling WebSocket messages with pluggable validators. It turns our messy switch statement into clear, type-safe routes with validation baked in.</p><p data-v-c6285ced>In the next section, we&#39;ll explore how to solve these problems using <strong data-v-c6285ced>WS-Kit</strong> with Zod schemas for type-safety.</p><h2 id="part-2-the-type-safety-challenge" tabindex="-1" data-v-c6285ced>Part 2: The Type-Safety Challenge <a class="header-anchor" href="#part-2-the-type-safety-challenge" aria-label="Permalink to ‚ÄúPart 2: The Type-Safety Challenge‚Äù" data-v-c6285ced>‚Äã</a></h2><h3 id="the-wild-west-of-websocket-messages" tabindex="-1" data-v-c6285ced>The Wild West of WebSocket Messages <a class="header-anchor" href="#the-wild-west-of-websocket-messages" aria-label="Permalink to ‚ÄúThe Wild West of WebSocket Messages‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>If you‚Äôve been following along, you now have a basic WebSocket server running in Bun. Messages are flying back and forth, connections are being established and closed ‚Äî everything seems great! But then you try to build something real, and suddenly it feels like you‚Äôre trying to herd cats in the dark. With a blindfold on. While riding a unicycle.</p><p data-v-c6285ced>The challenge with WebSocket communication is that, unlike REST APIs with their well-defined endpoints and request/response structures, WebSockets are essentially a continuous stream of messages. There‚Äôs no built-in mechanism to ensure that:</p><ol data-v-c6285ced><li data-v-c6285ced>Messages have the right structure</li><li data-v-c6285ced>Required fields are present</li><li data-v-c6285ced>Values have the correct types</li><li data-v-c6285ced>Handlers receive only messages they‚Äôre designed to process</li></ol><p data-v-c6285ced>This is where many WebSocket applications start to crumble under their own complexity. Let‚Äôs explore the key challenges in detail.</p><h3 id="the-what-did-i-just-receive-problem" tabindex="-1" data-v-c6285ced>The ‚ÄúWhat Did I Just Receive?‚Äù Problem <a class="header-anchor" href="#the-what-did-i-just-receive-problem" aria-label="Permalink to ‚ÄúThe ‚ÄúWhat Did I Just Receive?‚Äù Problem‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Take a look at this common WebSocket message handler pattern:</p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;chat_message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Is data.content defined? Is it a string? Who knows!</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    chatSystem.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>processMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.content);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user_joined&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Does data.userId exist? Is it a number or string?</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    notifyUserJoined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;typing_indicator&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Is data.isTyping a boolean or something else?</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    updateTypingStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.userId, data.isTyping);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // And so on...</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>This approach has several issues:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>No guarantee of structure</strong>: Just because <code data-v-c6285ced>data.type</code> is <code data-v-c6285ced>&#39;chat_message&#39;</code> doesn&#39;t mean <code data-v-c6285ced>data.content</code> exists.</li><li data-v-c6285ced><strong data-v-c6285ced>Type coercion traps</strong>: JavaScript‚Äôs loose typing means <code data-v-c6285ced>data.isTyping</code> could be the string <code data-v-c6285ced>&quot;false&quot;</code> instead of the boolean <code data-v-c6285ced>false</code>.</li><li data-v-c6285ced><strong data-v-c6285ced>Typo landmines</strong>: Mistype <code data-v-c6285ced>&#39;chat_message&#39;</code> as <code data-v-c6285ced>&#39;chat_mesage&#39;</code> and your handler won&#39;t trigger.</li><li data-v-c6285ced><strong data-v-c6285ced>Implicit dependencies</strong>: It‚Äôs not clear what fields each message type requires.</li></ol><h3 id="the-evolution-of-error-messages" tabindex="-1" data-v-c6285ced>The Evolution of Error Messages <a class="header-anchor" href="#the-evolution-of-error-messages" aria-label="Permalink to ‚ÄúThe Evolution of Error Messages‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>As your application grows, so does the sophistication (or desperation) of your error handling:</p><p data-v-c6285ced><strong data-v-c6285ced>Stage 1: Blissful Ignorance</strong></p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  processChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.room, data.text); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// What could go wrong?</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced><strong data-v-c6285ced>Stage 2: The Console.log Debugging Phase</strong></p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Received:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, data); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Let me see what I&#39;m dealing with</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> data.text) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    processChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.room, data.text);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced><strong data-v-c6285ced>Stage 3: Trust Issues</strong></p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;object&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Invalid message format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Missing or invalid type field&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;chat_message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data.room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> data.room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Missing or invalid room field&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data.text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> data.text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Missing or invalid text field&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      processChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.room, data.text);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // And so on for EVERY message type...</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Error processing message:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        message: error.message,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>By Stage 3, a third of your codebase is dedicated to validation, and you‚Äôre seriously considering a career change to something less frustrating‚Ä¶ like herding actual cats.</p><h3 id="the-typescript-mirage" tabindex="-1" data-v-c6285ced>The TypeScript Mirage <a class="header-anchor" href="#the-typescript-mirage" aria-label="Permalink to ‚ÄúThe TypeScript Mirage‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>‚ÄúBut wait,‚Äù you might say, ‚ÄúI‚Äôm using TypeScript! I‚Äôve defined interfaces for all my message types!‚Äù</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> BaseChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> BaseChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &#39;chat_message&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> UserJoinedMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> BaseChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &#39;user_joined&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// More message types...</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> AllMessageTypes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> UserJoinedMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced> /* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&#39;message&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> AllMessageTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// The infamous &quot;trust me&quot; cast</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &#39;chat_message&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // TypeScript now thinks data is ChatMessage</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      processChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.room, data.text);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &#39;user_joined&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // TypeScript now thinks data is UserJoinedMessage</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      notifyUserJoined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.userId, data.username);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>This looks better! TypeScript gives you nice autocomplete and seems to understand your message structure. But there‚Äôs an illusion at play here: that <code data-v-c6285ced>as AllMessageTypes</code> cast is basically you telling TypeScript, &quot;Trust me, this JSON is properly formatted.&quot; But at runtime, all those lovely types disappear, and you&#39;re back to the Wild West.</p><p data-v-c6285ced>What if someone sends this?</p><div class="language-json" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>{</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  &quot;type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chat_message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  &quot;rum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;general&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Typo: &quot;rum&quot; instead of &quot;room&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  &quot;text&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Hello world!&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>TypeScript won‚Äôt save you. Your code will try to process <code data-v-c6285ced>data.room</code>, which is <code data-v-c6285ced>undefined</code>, potentially causing errors downstream.</p><h3 id="the-runtime-validation-gap" tabindex="-1" data-v-c6285ced>The Runtime Validation Gap <a class="header-anchor" href="#the-runtime-validation-gap" aria-label="Permalink to ‚ÄúThe Runtime Validation Gap‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>The core issue is the gap between compile-time types (what TypeScript checks) and runtime values (what actually arrives over the wire). This is where validation libraries like Zod come in.</p><p data-v-c6285ced>Zod lets you define schemas that serve as both TypeScript types AND runtime validators:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define message schemas</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ChatMessageSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chat_message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  room: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  text: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> UserJoinedSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;user_joined&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Infer TypeScript types from schemas</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>infer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ChatMessageSchema&gt;;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> UserJoinedMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>infer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> UserJoinedSchema&gt;;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Use in handler</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;chat_message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> validatedData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ChatMessageSchema.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      processChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(validatedData.room, validatedData.text);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user_joined&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> validatedData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> UserJoinedSchema.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      notifyUserJoined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(validatedData.userId, validatedData.username);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Validation error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Send error back to client</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>This is much more robust! Now if someone sends a malformed message, Zod will catch it and provide detailed error information.</p><h3 id="the-routing-challenge" tabindex="-1" data-v-c6285ced>The Routing Challenge <a class="header-anchor" href="#the-routing-challenge" aria-label="Permalink to ‚ÄúThe Routing Challenge‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>But we still have another problem: as your application grows, this giant message handler becomes unmaintainable. You need a way to:</p><ol data-v-c6285ced><li data-v-c6285ced>Define message types and their validation schemas in one place</li><li data-v-c6285ced>Route incoming messages to the appropriate handlers</li><li data-v-c6285ced>Handle error cases consistently</li><li data-v-c6285ced>Provide type safety throughout the process</li></ol><p data-v-c6285ced>This is where <strong data-v-c6285ced>WS-Kit</strong> comes in. It combines message type definition, validation, and routing into a clean, type-safe API.</p><h2 id="enter-ws-kit" tabindex="-1" data-v-c6285ced>Enter WS-Kit <a class="header-anchor" href="#enter-ws-kit" aria-label="Permalink to ‚ÄúEnter WS-Kit‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced><strong data-v-c6285ced>WS-Kit</strong> is designed to solve these challenges by providing:</p><ol data-v-c6285ced><li data-v-c6285ced>A way to define message types with Zod schemas</li><li data-v-c6285ced>Automatic validation of incoming messages</li><li data-v-c6285ced>Routing to type-specific handlers</li><li data-v-c6285ced>Clean error handling patterns</li></ol><p data-v-c6285ced>All code examples in this guide use <code data-v-c6285ced>createRouter</code> imported from <code data-v-c6285ced>@ws-kit/zod</code>, which automatically configures the router with Zod validation. This is the recommended way to set up WS-Kit.</p><p data-v-c6285ced>Instead of a giant switch statement or if/else chain, you can write code like this:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, message, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define message types with schemas</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;CHAT_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  room: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  text: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JoinRoom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;JOIN_ROOM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  room: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create router</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define handlers for each message type</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ChatMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // ctx.payload is fully typed and validated!</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Do something with the message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Message in ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Send response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ChatMessage, { room, text: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Echo: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> text });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(room); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Subscribe to room using Bun&#39;s built-in PubSub</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Client joined room: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Start server with router</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>With this approach:</p><ol data-v-c6285ced><li data-v-c6285ced>Message schemas are defined clearly in one place</li><li data-v-c6285ced>Incoming messages are automatically validated</li><li data-v-c6285ced>Handlers only receive messages they‚Äôre supposed to handle</li><li data-v-c6285ced>TypeScript provides full type safety at every step</li><li data-v-c6285ced>Invalid messages generate helpful error responses</li></ol><h3 id="the-benefits-of-type-safe-websockets" tabindex="-1" data-v-c6285ced>The Benefits of Type-Safe WebSockets <a class="header-anchor" href="#the-benefits-of-type-safe-websockets" aria-label="Permalink to ‚ÄúThe Benefits of Type-Safe WebSockets‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Using a typed approach with validation provides several key benefits:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Robust error handling</strong>: Catch malformed messages early with detailed error information</li><li data-v-c6285ced><strong data-v-c6285ced>Self-documenting code</strong>: Your message schemas serve as documentation for your protocol</li><li data-v-c6285ced><strong data-v-c6285ced>IDE support</strong>: Get autocomplete and type checking as you work with messages</li><li data-v-c6285ced><strong data-v-c6285ced>Safer refactoring</strong>: Change message structures with confidence, as TypeScript will find usages</li><li data-v-c6285ced><strong data-v-c6285ced>Clearer mental model</strong>: Discrete message types make the system easier to understand</li></ol><h3 id="from-chaos-to-order" tabindex="-1" data-v-c6285ced>From Chaos to Order <a class="header-anchor" href="#from-chaos-to-order" aria-label="Permalink to ‚ÄúFrom Chaos to Order‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>With a type-safe approach using <strong data-v-c6285ced>ws-kit</strong> and Zod, we&#39;ve moved from the Wild West of WebSocket messages to a structured, maintainable system. No more casting and hoping for the best. No more giant switch statements. No more manual validation code.</p><p data-v-c6285ced>In the next section, we&#39;ll dive deeper into <strong data-v-c6285ced>ws-kit</strong> and explore how it can be used to build a complete real-time chat application with authentication, rooms, and more.</p><h2 id="part-3-introducing-ws-kit" tabindex="-1" data-v-c6285ced>Part 3: Introducing ws-kit <a class="header-anchor" href="#part-3-introducing-ws-kit" aria-label="Permalink to ‚ÄúPart 3: Introducing ws-kit‚Äù" data-v-c6285ced>‚Äã</a></h2><h3 id="the-missing-piece-in-websocket-development" tabindex="-1" data-v-c6285ced>The Missing Piece in WebSocket Development <a class="header-anchor" href="#the-missing-piece-in-websocket-development" aria-label="Permalink to ‚ÄúThe Missing Piece in WebSocket Development‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>In the previous sections, we explored WebSockets in Bun and the challenges of maintaining type safety in a real-time messaging environment. Now it&#39;s time to introduce the solution to our WebSocket woes: <strong data-v-c6285ced>ws-kit</strong>.</p><p data-v-c6285ced>Think of <strong data-v-c6285ced>ws-kit</strong> as that friend who always keeps their kitchen organized‚Äîthe one who has separate containers for different types of pasta and labels everything. Maybe a bit obsessive, but you&#39;re secretly grateful when you need to find the rigatoni at 2 AM. That&#39;s what <strong data-v-c6285ced>ws-kit</strong> does for your WebSocket messages: it keeps everything organized, labeled, and exactly where it should be.</p><h3 id="what-is-ws-kit" tabindex="-1" data-v-c6285ced>What is ws-kit? <a class="header-anchor" href="#what-is-ws-kit" aria-label="Permalink to ‚ÄúWhat is ws-kit?‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced><strong data-v-c6285ced>ws-kit</strong> is a lightweight, type-safe WebSocket router for Bun and other platforms. It provides a structured way to handle WebSocket connections and route messages to different handlers based on message types, all with full TypeScript support and pluggable validator integration (Zod, Valibot, custom).</p><p data-v-c6285ced>Instead of building your own message routing system from scratch (and let&#39;s be honest, the first version would probably be a giant switch statement), <strong data-v-c6285ced>ws-kit</strong> gives you a battle-tested solution that&#39;s ready to use.</p><h2 id="core-philosophy" tabindex="-1" data-v-c6285ced>Core Philosophy <a class="header-anchor" href="#core-philosophy" aria-label="Permalink to ‚ÄúCore Philosophy‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>The core philosophy behind <strong data-v-c6285ced>WS-Kit</strong> is simple:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Pluggable, not prescriptive</strong>: Work with any validator (Zod, Valibot, custom) and any platform (Bun, Cloudflare, custom adapters)</li><li data-v-c6285ced><strong data-v-c6285ced>Type safety everywhere</strong>: From message definition to handler execution</li><li data-v-c6285ced><strong data-v-c6285ced>Runtime validation</strong>: Catch errors before they cause problems</li><li data-v-c6285ced><strong data-v-c6285ced>Clean separation</strong>: Organize handlers by message type</li><li data-v-c6285ced><strong data-v-c6285ced>Minimal overhead</strong>: Keep things fast and lightweight</li></ol><h3 id="key-features-in-detail" tabindex="-1" data-v-c6285ced>Key Features in Detail <a class="header-anchor" href="#key-features-in-detail" aria-label="Permalink to ‚ÄúKey Features in Detail‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Let&#39;s dig into the key features that make <strong data-v-c6285ced>ws-kit</strong> stand out:</p><h3 id="type-safe-messaging-with-zod-schemas" tabindex="-1" data-v-c6285ced>Type-Safe Messaging with Zod Schemas <a class="header-anchor" href="#type-safe-messaging-with-zod-schemas" aria-label="Permalink to ‚ÄúType-Safe Messaging with Zod Schemas‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>At the heart of <strong data-v-c6285ced>ws-kit</strong> is the <code data-v-c6285ced>message</code> function. This function allows you to define message types with their associated payloads using Zod schemas:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define a message type for joining a chat room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JoinRoom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;JOIN_ROOM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define a message for sending a chat message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> SendMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;SEND_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  message: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add constraints</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  attachments: z</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;image&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>]),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        url: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    )</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>The magic here is twofold:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>TypeScript Types</strong>: The <code data-v-c6285ced>message</code> function automatically generates TypeScript types that you can use throughout your codebase</li><li data-v-c6285ced><strong data-v-c6285ced>Runtime Validation</strong>: When a message arrives, it&#39;s automatically validated against the schema before your handler is called</li></ol><p data-v-c6285ced>This means you can confidently access <code data-v-c6285ced>ctx.payload.roomId</code> in your handler, knowing it&#39;s a string that passed validation. No more defensive coding with <code data-v-c6285ced>if (typeof data.roomId === &#39;string&#39;)</code> checks everywhere!</p><h3 id="intuitive-routing-system" tabindex="-1" data-v-c6285ced>Intuitive Routing System <a class="header-anchor" href="#intuitive-routing-system" aria-label="Permalink to ‚ÄúIntuitive Routing System‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>With <strong data-v-c6285ced>WS-Kit</strong>, you define handlers for specific message types:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { JoinRoom, SendMessage } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle JOIN_ROOM messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Fully typed and validated!</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Client wants to join room: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Join the room using Bun&#39;s built-in PubSub</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Send confirmation</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, { roomId }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Type-checked!</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle SEND_MESSAGE messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(SendMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>attachments</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`New message in ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // No need to check if attachments exists - type system handles it</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> hasAttachments</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> attachments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> attachments.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Broadcast to room (using Bun&#39;s built-in PubSub)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // More on this in the broadcast section</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>Each handler receives a context object with:</p><ul data-v-c6285ced><li data-v-c6285ced><code data-v-c6285ced>ws</code>: The WebSocket connection</li><li data-v-c6285ced><code data-v-c6285ced>payload</code>: The validated message payload (fully typed!)</li><li data-v-c6285ced><code data-v-c6285ced>meta</code>: Additional metadata about the message</li><li data-v-c6285ced><code data-v-c6285ced>send()</code>: A helper method for sending responses</li></ul><p data-v-c6285ced>If a message arrives with an unknown type or fails validation, it&#39;s automatically rejected with an appropriate error message ‚Äî no need to write that boilerplate yourself.</p><h2 id="leveraging-bun-s-native-websocket-performance" tabindex="-1" data-v-c6285ced>Leveraging Bun&#39;s Native WebSocket Performance <a class="header-anchor" href="#leveraging-bun-s-native-websocket-performance" aria-label="Permalink to ‚ÄúLeveraging Bun&#39;s Native WebSocket Performance‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced><strong data-v-c6285ced>WS-Kit</strong> is designed to be a thin layer on top of Bun&#39;s already-fast WebSocket implementation. It doesn&#39;t reinvent the wheel‚Äîit just adds guardrails to keep you on the road.</p><p data-v-c6285ced>The library adds minimal overhead to message processing, focusing on routing and validation while letting Bun handle the heavy lifting of WebSocket connections, frame parsing, and PubSub functionality.</p><h2 id="flexible-integration" tabindex="-1" data-v-c6285ced>Flexible Integration <a class="header-anchor" href="#flexible-integration" aria-label="Permalink to ‚ÄúFlexible Integration‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>One of the strengths of <strong data-v-c6285ced>WS-Kit</strong> is how easily it integrates with different server setups:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { createRouter, z } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// WebSocket router</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define your message handlers here</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(YourMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Handle message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// High-level serve() with auto-configuration</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Or for advanced setups, use Hono or any HTTP framework:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { Hono } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;hono&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { createBunHandler } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> app</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Hono</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> c.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Welcome to Hono!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>));</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> wsHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createBunHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>Bun.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req.url).pathname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> wsHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req, server);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> app.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(req);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  websocket: router.websocket,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>The library is framework-agnostic ‚Äî it works standalone, with Hono, Elysia, or any other HTTP framework you prefer.</p><h3 id="connection-lifecycle-management" tabindex="-1" data-v-c6285ced>Connection Lifecycle Management <a class="header-anchor" href="#connection-lifecycle-management" aria-label="Permalink to ‚ÄúConnection Lifecycle Management‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced><strong data-v-c6285ced>WS-Kit</strong> provides handlers for the entire WebSocket lifecycle:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle new connections</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`New client connected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Send welcome message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Welcome, { message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Welcome to the server!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle message types (as seen earlier)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /* ... */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle disconnections</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Client disconnected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Close code: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>code</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Close reason: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>reason</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Clean up any resources</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ctx.ws.data.roomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    leaveRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.roomId, ctx.ws.data.clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>Each handler has access to the WebSocket connection&#39;s metadata through <code data-v-c6285ced>ctx.ws.data</code>, allowing you to store and retrieve session information.</p><h2 id="authentication-and-security" tabindex="-1" data-v-c6285ced>Authentication and Security <a class="header-anchor" href="#authentication-and-security" aria-label="Permalink to ‚ÄúAuthentication and Security‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>Security is a critical concern in WebSocket applications. <strong data-v-c6285ced>WS-Kit</strong> provides a clean way to handle authentication during the WebSocket upgrade process:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { verifyToken } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./auth&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Your authentication logic</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> AppData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  userRole</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create router with type for connection metadata</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Your message handlers</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(SomeMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // ctx.ws.data.userId is available here</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Start server with authentication</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Extract and verify authentication token</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> authHeader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> authHeader?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>split</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Bearer &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>];</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Optional: Reject connection if no token</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>token) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Rejects the connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Verify token and get user info</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> verifyToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(token);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Return user data to be attached to ws.data</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userId: user?.id,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userRole: user?.role,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    };</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>By authenticating during the upgrade process, you ensure that only authorized users can establish WebSocket connections. The user data is then available in all your handlers via <code data-v-c6285ced>ctx.ws.data</code>.</p><h2 id="broadcasting-and-room-management" tabindex="-1" data-v-c6285ced>Broadcasting and Room Management <a class="header-anchor" href="#broadcasting-and-room-management" aria-label="Permalink to ‚ÄúBroadcasting and Room Management‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>WebSocket applications often need to broadcast messages to multiple clients. <strong data-v-c6285ced>WS-Kit</strong> complements Bun&#39;s built-in PubSub functionality with schema validation:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { ChatMessage, UserJoined } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ChatMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Broadcast the message to everyone in the room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, ChatMessage, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    message,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Subscribe to the room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.roomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Notify others</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, UserJoined, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>The <code data-v-c6285ced>ctx.publish()</code> helper ensures that broadcast messages are validated against their schemas before being sent, providing the same type safety for broadcasts that you get with direct messaging.</p><h3 id="error-handling" tabindex="-1" data-v-c6285ced>Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to ‚ÄúError Handling‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Robust error handling is crucial for WebSocket applications. <strong data-v-c6285ced>WS-Kit</strong> includes a standardized error system with error codes aligned with gRPC:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if room exists</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> roomExists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> checkRoomExists</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomExists) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Send typed error response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;NOT_FOUND&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Room ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} does not exist`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      roomId, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Additional debug info</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Continue with normal flow...</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>The library includes predefined error codes (UNAUTHENTICATED, PERMISSION_DENIED, INVALID_ARGUMENT, NOT_FOUND, RESOURCE_EXHAUSTED, etc.) for common scenarios, ensuring consistent error reporting.</p><h3 id="modular-route-organization" tabindex="-1" data-v-c6285ced>Modular Route Organization <a class="header-anchor" href="#modular-route-organization" aria-label="Permalink to ‚ÄúModular Route Organization‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>As your application grows, you can organize routes into separate modules:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// chat.ts</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { ChatMessage, JoinRoom } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create a router instance</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> chatRouter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add message handlers</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>chatRouter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ChatMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /* ... */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>chatRouter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /* ... */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// main.ts</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { chatRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./chat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { userRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add modular routers</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(chatRouter);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userRouter);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Start server</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, { port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> });</span></span></code></pre></div><p data-v-c6285ced>This keeps your codebase organized and makes it easier to collaborate with team members.</p><h3 id="why-choose-ws-kit" tabindex="-1" data-v-c6285ced>Why Choose WS-Kit? <a class="header-anchor" href="#why-choose-ws-kit" aria-label="Permalink to ‚ÄúWhy Choose WS-Kit?‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>With so many WebSocket solutions out there, why choose <strong data-v-c6285ced>WS-Kit</strong>?</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Platform-agnostic</strong>: Pluggable adapters for Bun, Cloudflare, and custom platforms</li><li data-v-c6285ced><strong data-v-c6285ced>Validator-agnostic</strong>: Works with Zod, Valibot, or your own validation library</li><li data-v-c6285ced><strong data-v-c6285ced>TypeScript-first</strong>: Designed with type safety as a core principle</li><li data-v-c6285ced><strong data-v-c6285ced>Runtime validation</strong>: Catch errors before they cause problems</li><li data-v-c6285ced><strong data-v-c6285ced>Lightweight</strong>: Minimal overhead, just the features you need</li><li data-v-c6285ced><strong data-v-c6285ced>Progressive</strong>: Start simple and scale as needed</li></ol><p data-v-c6285ced>It&#39;s the Goldilocks of WebSocket libraries: not too heavy, not too bare-bones, but just right. Plus, you&#39;re not locked into a single validator or platform.</p><h3 id="getting-started-with-ws-kit" tabindex="-1" data-v-c6285ced>Getting Started with ws-kit <a class="header-anchor" href="#getting-started-with-ws-kit" aria-label="Permalink to ‚ÄúGetting Started with ws-kit‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Ready to bring some order to your WebSocket chaos? Let&#39;s get started:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @ws-kit/zod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @ws-kit/bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> zod</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @types/bun</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> -D</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  # For TypeScript support</span></span></code></pre></div><p data-v-c6285ced>In the next section, we&#39;ll put everything together to build a complete real-time chat application using <strong data-v-c6285ced>WS-Kit</strong>, demonstrating how the library makes complex WebSocket applications more manageable.</p><p data-v-c6285ced>Say goodbye to giant switch statements and untyped message payloads. With <strong data-v-c6285ced>WS-Kit</strong>, your WebSocket code can be as clean and organized as that friend&#39;s pasta collection‚Äîjust hopefully without the late-night carbohydrate cravings.</p><h2 id="part-4-building-a-real-time-chat-application" tabindex="-1" data-v-c6285ced>Part 4: Building a Real-Time Chat Application <a class="header-anchor" href="#part-4-building-a-real-time-chat-application" aria-label="Permalink to ‚ÄúPart 4: Building a Real-Time Chat Application‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>Now that we understand the fundamentals of WebSockets in Bun and have been introduced to <strong data-v-c6285ced>WS-Kit</strong>, let&#39;s put everything together to build something practical: a real-time chat application.</p><p data-v-c6285ced>After all, what better way to test our new WebSocket routing superpowers than by creating yet another chat app? Because clearly, what the world needs is one more place for people to share cat memes and debate whether pineapple belongs on pizza (it does, fight me).</p><h3 id="project-setup" tabindex="-1" data-v-c6285ced>Project Setup <a class="header-anchor" href="#project-setup" aria-label="Permalink to ‚ÄúProject Setup‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>First things first, let&#39;s set up our project. Create a new folder for our chat application and initialize it:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> bun-chat-app</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> bun-chat-app</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> -y</span></span></code></pre></div><p data-v-c6285ced>Next, install the dependencies we&#39;ll need:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @ws-kit/zod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @ws-kit/bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> zod</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> @types/bun</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> -D</span></span></code></pre></div><h3 id="step-1-define-our-message-schemas" tabindex="-1" data-v-c6285ced>Step 1: Define Our Message Schemas <a class="header-anchor" href="#step-1-define-our-message-schemas" aria-label="Permalink to ‚ÄúStep 1: Define Our Message Schemas‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>The heart of our type-safe approach is defining clear message schemas. Let&#39;s create a file called <code data-v-c6285ced>schemas.ts</code> to define all the message types our chat application will support:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// User authentication</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> Authenticate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;AUTHENTICATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  token: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> AuthSuccess</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;AUTH_SUCCESS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Room management</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JoinRoom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;JOIN_ROOM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> LeaveRoom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;LEAVE_ROOM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> UserJoined</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;USER_JOINED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> UserLeft</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;USER_LEFT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> RoomList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;ROOM_LIST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  rooms: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      id: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      name: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userCount: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Messaging</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> SendMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;SEND_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  text: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Optional attachment</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  attachment: z</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;image&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>]),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      url: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      name: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    })</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ChatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;CHAT_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messageId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  text: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  timestamp: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  attachment: z</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>enum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;image&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;file&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>]),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      url: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      name: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    })</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Typing indicators</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> TypingStart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;TYPING_START&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> TypingStop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;TYPING_STOP&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> UserTyping</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;USER_TYPING&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Connection metadata type</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  currentRoomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  isAuthenticated</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span></code></pre></div><p data-v-c6285ced>Notice how we‚Äôve organized our messages into logical groups: authentication, room management, messaging, and typing indicators. We‚Äôre also using Zod‚Äôs validation capabilities to ensure messages have the correct shape and content (like enforcing minimum and maximum message length).</p><h3 id="step-2-setting-up-our-mock-user-database" tabindex="-1" data-v-c6285ced>Step 2: Setting Up Our Mock User Database <a class="header-anchor" href="#step-2-setting-up-our-mock-user-database" aria-label="Permalink to ‚ÄúStep 2: Setting Up Our Mock User Database‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>For simplicity, we‚Äôll use an in-memory store for users and rooms instead of a real database:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { randomUUID } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;crypto&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// User record</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Room record</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// User IDs</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// In-memory storage</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> tokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// token -&gt; userId</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> rooms</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Seed with some default rooms</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;general&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;general&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;General Chat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  users: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;random&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;random&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Random Stuff&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  users: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// User authentication methods</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> authenticateUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> tokens.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(token);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { id, username, token };</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(id, user);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  tokens.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(token, id);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> user;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Room methods</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> getRooms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>[] {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>());</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> getRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>roomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> joinRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>roomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  room.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> leaveRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>roomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> room.users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> getUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> users.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>This simple store handles user authentication, room management, and keeping track of who‚Äôs in which room.</p><h3 id="step-3-implementing-our-websocket-handlers" tabindex="-1" data-v-c6285ced>Step 3: Implementing Our WebSocket Handlers <a class="header-anchor" href="#step-3-implementing-our-websocket-handlers" aria-label="Permalink to ‚ÄúStep 3: Implementing Our WebSocket Handlers‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Now let&#39;s implement handlers for each of our message types. Let&#39;s create a file called <code data-v-c6285ced>chat-router.ts</code>:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { randomUUID } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;crypto&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  authenticateUser,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  createUser,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  getRoom,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  getRooms,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  joinRoom,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  leaveRoom,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  getUser,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./data-store&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create a router with our meta type</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle new connections</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // clientId is automatically assigned by ws-kit framework</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`New client connected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Assign a random guest name until authenticated</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>assignData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Guest-${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>Math</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>floor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>Math</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>random</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 10000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Send room list to the new client</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> rooms</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> getRooms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    id: room.id,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    name: room.name,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userCount: room.users.size,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }));</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.RoomList, { rooms });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle authentication</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.Authenticate, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if token exists in our store</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> authenticateUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(token);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (user) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Authentication successful</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.isAuthenticated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> user.id;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> user.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.AuthSuccess, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userId: user.id,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      username: user.username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`User authenticated: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>})`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Create a new user if token doesn&#39;t exist</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // In a real app, you&#39;d probably reject invalid tokens</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> newUser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.ws.data.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `User-${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>randomUUID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>slice</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.isAuthenticated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> newUser.id;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> newUser.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.AuthSuccess, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userId: newUser.id,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      username: newUser.username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`New user created: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>newUser</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>newUser</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>})`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle joining a room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if user is authenticated</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;UNAUTHENTICATED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;You must be authenticated to join a room&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if room exists</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> getRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;NOT_FOUND&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Room ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} does not exist`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // If user is already in a room, leave it first</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ctx.ws.data.currentRoomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    leaveRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.currentRoomId, userId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Let others know user left the previous room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.currentRoomId, schema.UserLeft, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      roomId: ctx.ws.data.currentRoomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Unsubscribe from previous room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.currentRoomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Join the new room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  joinRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Subscribe to the room&#39;s messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Confirm to the user they&#39;ve joined</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.UserJoined, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Let others know a new user joined</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.UserJoined, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`User ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}) joined room: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle leaving a room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.LeaveRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;UNAUTHENTICATED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;You must be authenticated to leave a room&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if user is in the room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ctx.ws.data.currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;INVALID_ARGUMENT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;You are not in this room&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Leave the room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  leaveRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Unsubscribe from room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Let others know user left</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.UserLeft, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`User ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}) left room: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle sending messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.SendMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>attachment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;UNAUTHENTICATED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;You must be authenticated to send messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if room exists</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;NOT_FOUND&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Room ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} does not exist`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check if user is in the room they&#39;re trying to message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ctx.ws.data.currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;PERMISSION_DENIED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;You must join the room before sending messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Create a message object with ID and timestamp</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> chatMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    messageId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    text,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timestamp,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    attachment,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  };</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Broadcast the message to everyone in the room, including sender</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.ChatMessage, chatMessage);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    `Message sent to room ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} by ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>substring</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;...&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle typing indicators</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.TypingStart, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Broadcast typing indicator to everyone else in the room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.UserTyping, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle connection closure</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> roomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.currentRoomId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    `Client disconnected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}, code: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>code</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  );</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // If user was in a room, notify others and clean up</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    leaveRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, userId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Let others know user left</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.UserLeft, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> router;</span></span></code></pre></div><p data-v-c6285ced>That‚Äôs quite a bit of code, but it‚Äôs well-organized and each message type has its own dedicated handler. The beauty of this approach is that each handler receives a fully typed and validated payload, making it easy to work with the data without worrying about runtime errors.</p><h3 id="step-4-creating-the-main-server" tabindex="-1" data-v-c6285ced>Step 4: Creating the Main Server <a class="header-anchor" href="#step-4-creating-the-main-server" aria-label="Permalink to ‚ÄúStep 4: Creating the Main Server‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Now let&#39;s create the main server file that will bring everything together:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> chatRouter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./chat-router&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create the main WebSocket router</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add our chat routes</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(chatRouter);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Start the server with ws-kit</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Chat server running on http://localhost:3000&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket endpoint: ws://localhost:3000/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span></code></pre></div><h2 id="step-5-creating-a-simple-frontend" tabindex="-1" data-v-c6285ced>Step 5: Creating a Simple Frontend <a class="header-anchor" href="#step-5-creating-a-simple-frontend" aria-label="Permalink to ‚ÄúStep 5: Creating a Simple Frontend‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>Let‚Äôs create a basic chat UI to test our WebSocket server. First, create a <code data-v-c6285ced>public</code> folder for our static files:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> public</span></span></code></pre></div><p data-v-c6285ced>Then create a simple HTML file:</p><div class="language-html" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>html</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>&lt;!-- filepath: public/index.html --&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;!</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>DOCTYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>html</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> lang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;en&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> charset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;viewport&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;width=device-width, initial-scale=1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Bun Chat App&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>link</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> rel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;stylesheet&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> href</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;styles.css&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;app-container&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;sidebar&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;user-info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>span</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Not logged in&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>span</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;login-btn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Login&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>h3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Rooms&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>h3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>ul</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-list&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>ul</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chat-container&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-header&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-header&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Select a room&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messages&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;typing-indicator&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;typing-indicator&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>form</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message-form&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message-form&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>input</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;text&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message-input&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            placeholder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Type a message...&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            disabled</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;submit&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;send-btn&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> disabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;Send&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>form</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>div</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>script</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> src</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;app.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;</span></span></code></pre></div><p data-v-c6285ced>Add some basic styling:</p><div class="language-css" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>css</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  box-sizing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>border-box</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  font-family</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    system-ui</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    -apple-system</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    BlinkMacSystemFont,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    &quot;Segoe UI&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    Roboto,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    Oxygen,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    Ubuntu,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    Cantarell,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    &quot;Open Sans&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    &quot;Helvetica Neue&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    sans-serif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced>body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#f5f5f5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.app-container</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>vh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  max-width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1200</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  box-shadow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> rgba</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.sidebar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>250</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#f0f0f0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-right</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> solid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> #ddd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.user-info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  justify-content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>space-between</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  align-items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>center</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> solid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> #ddd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.room-list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  list-style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>none</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.room-item</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-radius</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  cursor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>pointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.room-item:hover</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#e0e0e0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.room-item.active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#2c3e50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.chat-container</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  flex-direction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>column</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.room-header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>15</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#2c3e50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  font-weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>bold</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.messages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  overflow-y</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>15</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> .header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-bottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> .username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  font-weight</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>bold</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-right</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> .time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#999</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  font-size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0.8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>em</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> .text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#f1f1f1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-radius</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  max-width</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>80</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  word-break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>break-word</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message.own</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  text-align</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>right</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message.own</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> .text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#3498db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-left</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>auto</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.typing-indicator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#666</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  font-style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>italic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  min-height</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>30</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message-form</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  display</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 20</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#f9f9f9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-top</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> solid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> #ddd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message-form</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced> input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  flex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> solid</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> #ddd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-radius</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  margin-right</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message-form</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced> button</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  padding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 15</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#3498db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>none</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  border-radius</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>px</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  cursor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>pointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>.message-form</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;" data-v-c6285ced> button</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>:disabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  background-color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>#ccc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  cursor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>not-allowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>And now, the client-side JavaScript to connect to our WebSocket server:</p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Elements</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> usernameElement</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> loginButton</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;login-btn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> roomList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> roomHeader</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;room-header&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messagesContainer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> typingIndicator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;typing-indicator&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageForm</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message-form&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageInput</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message-input&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> sendButton</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getElementById</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;send-btn&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// State</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> socket;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentUser </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  userId: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  username: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  token: localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chatToken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> rooms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [];</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> typingTimeout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Connect to WebSocket</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> connectWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`ws://${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>window</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>location</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}/ws`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;open&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connected to WebSocket server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // If we have a stored token, try to authenticate</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (currentUser.token) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;AUTHENTICATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { token: currentUser.token });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    handleMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(data.type, data.payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Disconnected from WebSocket server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Try to reconnect after a delay</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(connectWebSocket, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Send a message to the server</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> socket.readyState </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> WebSocket.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>OPEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      type,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      meta: { timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      payload,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    };</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message));</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle incoming messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Received ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}:`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, payload);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (type) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;ROOM_LIST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleRoomList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;AUTH_SUCCESS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleAuthSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;USER_JOINED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleUserJoined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;USER_LEFT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleUserLeft</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;CHAT_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;USER_TYPING&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleUserTyping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>:</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      handleError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle room list</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleRoomList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  rooms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.rooms;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  renderRoomList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle successful authentication</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleAuthSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  currentUser.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  currentUser.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.username;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  currentUser.token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chatToken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  usernameElement.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.username;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  loginButton.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Logout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Enable message input now that we&#39;re logged in</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messageInput.disabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  sendButton.disabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle user joined room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleUserJoined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (payload.roomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Add system message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> isCurrentUser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentUser.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> isCurrentUser</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;You joined the room&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} joined the room`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    addSystemMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle user left room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleUserLeft</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (payload.roomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> isCurrentUser</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentUser.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> isCurrentUser</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;You left the room&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} left the room`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    addSystemMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle chat message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (payload.roomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> isOwnMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentUser.userId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;div&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    messageEl.className </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `message ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>isOwnMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;own&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> time</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload.timestamp).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toLocaleTimeString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    messageEl.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &lt;div class=&quot;header&quot;&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &lt;span class=&quot;username&quot;&gt;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>isOwnMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;You&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}&lt;/span&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &lt;span class=&quot;time&quot;&gt;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}&lt;/span&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &lt;/div&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &lt;div class=&quot;text&quot;&gt;${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>escapeHtml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}&lt;/div&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>    `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (payload.attachment) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> attachmentEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;div&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      attachmentEl.className </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;attachment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (payload.attachment.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;image&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        attachmentEl.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>          &lt;img src=&quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>attachment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}&quot; alt=&quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>attachment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Attachment&quot;}&quot; /&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        attachmentEl.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>          &lt;a href=&quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>attachment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}&quot; target=&quot;_blank&quot;&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>            ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>attachment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Download file&quot;}</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>          &lt;/a&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        `</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      messageEl.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(attachmentEl);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    messagesContainer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(messageEl);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    scrollToBottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle typing indicators</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleUserTyping</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    payload.roomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    payload.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentUser.userId</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Show typing indicator</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    typingIndicator.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} is typing...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Clear after a delay</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(typingTimeout);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    typingTimeout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      typingIndicator.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle errors</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handleError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Server error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, payload);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Display error as system message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  addSystemMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Error: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Render the room list</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> renderRoomList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  roomList.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>forEach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>room</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> li</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;li&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    li.className </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `room-item ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> currentRoomId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;active&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    li.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>room</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userCount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>})`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    li.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;click&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> joinRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(room.id));</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(li);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Join a room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> joinRoom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Clear messages when switching rooms</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messagesContainer.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  typingIndicator.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Join the new room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  currentRoomId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;JOIN_ROOM&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { roomId });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Update UI</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> room</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> rooms.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> r.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> roomId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (room) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomHeader.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> room.name;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  renderRoomList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Update active state</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Send a chat message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> sendChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>text.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>currentRoomId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;SEND_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId: currentRoomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    text: text.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Clear input</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messageInput.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add system message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> addSystemMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>isError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageEl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;div&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messageEl.className </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> `system-message ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>isError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;error&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messageEl.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> text;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messagesContainer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(messageEl);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  scrollToBottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Utilities</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> scrollToBottom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  messagesContainer.scrollTop </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> messagesContainer.scrollHeight;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> escapeHtml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> div</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;div&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  div.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> text;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> div.innerHTML;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Event listeners</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>loginButton.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;click&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (currentUser.userId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Logout</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>removeItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chatToken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    window.location.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>reload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Mock login for simplicity</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user-&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>36</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>substring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    localStorage.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>setItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;chatToken&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, token);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;AUTHENTICATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { token });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>messageForm.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;submit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>preventDefault</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  sendChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(messageInput.value);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>messageInput.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;input&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (currentRoomId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Send typing indicator</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;TYPING_START&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { roomId: currentRoomId });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Start the app</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>connectWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span></code></pre></div><h3 id="step-6-running-the-application" tabindex="-1" data-v-c6285ced>Step 6: Running the Application <a class="header-anchor" href="#step-6-running-the-application" aria-label="Permalink to ‚ÄúStep 6: Running the Application‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>With everything in place, let‚Äôs run our chat application:</p><div class="language-bash" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>bun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> server.ts</span></span></code></pre></div><p data-v-c6285ced>Now open your browser to <code data-v-c6285ced>http://localhost:3000</code>, and you should see the chat interface. You can:</p><ol data-v-c6285ced><li data-v-c6285ced>Click the login button to get a random username</li><li data-v-c6285ced>Join one of the two default rooms (General Chat or Random Stuff)</li><li data-v-c6285ced>Send messages and see them appear in real-time</li><li data-v-c6285ced>See typing indicators when other users are typing</li></ol><p data-v-c6285ced>You can even open multiple browser tabs to simulate different users!</p><h3 id="extending-the-application" tabindex="-1" data-v-c6285ced>Extending the Application <a class="header-anchor" href="#extending-the-application" aria-label="Permalink to ‚ÄúExtending the Application‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>This chat application is just a starting point. With the robust foundation provided by <strong data-v-c6285ced>WS-Kit</strong>, you can easily extend it with additional features:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Direct messaging</strong>: Add a new message schema for private messaging between users</li><li data-v-c6285ced><strong data-v-c6285ced>User profiles</strong>: Store and display more information about users</li><li data-v-c6285ced><strong data-v-c6285ced>Message history</strong>: Add persistence to store chat history</li><li data-v-c6285ced><strong data-v-c6285ced>Room creation</strong>: Allow users to create their own chat rooms</li><li data-v-c6285ced><strong data-v-c6285ced>Rich media</strong>: Improve the attachment support for images, videos, etc.</li><li data-v-c6285ced><strong data-v-c6285ced>Moderation tools</strong>: Add features for admins to moderate chats</li></ol><h3 id="conclusion" tabindex="-1" data-v-c6285ced>Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to ‚ÄúConclusion‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>We&#39;ve built a complete real-time chat application using Bun, WebSockets, and <strong data-v-c6285ced>WS-Kit</strong>. The application features:</p><ul data-v-c6285ced><li data-v-c6285ced>Type-safe messaging with Zod schemas</li><li data-v-c6285ced>Room-based chat with join/leave notifications</li><li data-v-c6285ced>User authentication</li><li data-v-c6285ced>Real-time message delivery</li><li data-v-c6285ced>Typing indicators</li><li data-v-c6285ced>Error handling</li></ul><p data-v-c6285ced>Despite the simplicity of our example, it showcases the power of a type-safe approach to WebSocket messaging. By defining our message schemas upfront and using <strong data-v-c6285ced>WS-Kit</strong> to handle validation and routing, we&#39;ve created a codebase that&#39;s easy to understand, extend, and maintain.</p><p data-v-c6285ced>No more giant switch statements. No more type coercion surprises. No more undefined property errors. Just clean, type-safe WebSocket messaging that scales with your application‚Äôs needs.</p><p data-v-c6285ced>So the next time someone asks you to build ‚Äújust a simple chat app‚Äù (which, let‚Äôs be honest, is never simple), you‚Äôll have the tools you need to build it properly from the start. Your future self ‚Äî the one who has to maintain this code six months from now while sipping coffee at 2 AM ‚Äî will thank you.</p><h2 id="part-5-advanced-patterns" tabindex="-1" data-v-c6285ced>Part 5: Advanced Patterns <a class="header-anchor" href="#part-5-advanced-patterns" aria-label="Permalink to ‚ÄúPart 5: Advanced Patterns‚Äù" data-v-c6285ced>‚Äã</a></h2><h3 id="beyond-the-basics-leveling-up-your-websocket-game" tabindex="-1" data-v-c6285ced>Beyond the Basics: Leveling Up Your WebSocket Game <a class="header-anchor" href="#beyond-the-basics-leveling-up-your-websocket-game" aria-label="Permalink to ‚ÄúBeyond the Basics: Leveling Up Your WebSocket Game‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Now that we‚Äôve built a functional chat application, let‚Äôs dive into some advanced patterns that can take your WebSocket applications from ‚Äúit works‚Äù to ‚Äúwow, that‚Äôs impressive!‚Äù After all, anyone can build a chat app ‚Äî it‚Äôs like the ‚ÄúHello World‚Äù of WebSockets ‚Äî but production-grade applications require more sophisticated techniques.</p><p data-v-c6285ced>Think of these patterns as the difference between knowing how to play ‚ÄúHot Cross Buns‚Äù on the recorder and performing a jazz improvisation. Same instrument, vastly different results. Let‚Äôs jazz things up!</p><h3 id="connection-pools-and-client-tracking" tabindex="-1" data-v-c6285ced>Connection Pools and Client Tracking <a class="header-anchor" href="#connection-pools-and-client-tracking" aria-label="Permalink to ‚ÄúConnection Pools and Client Tracking‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>In production applications, you‚Äôll often need to keep track of connected clients beyond what‚Äôs directly available in the WebSocket object. This is especially important for features like:</p><ul data-v-c6285ced><li data-v-c6285ced>Displaying online/offline status</li><li data-v-c6285ced>User activity monitoring</li><li data-v-c6285ced>Rate limiting</li><li data-v-c6285ced>Resource cleanup</li></ul><p data-v-c6285ced>Here&#39;s a robust connection pool implementation using <strong data-v-c6285ced>WS-Kit</strong>:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { ServerWebSocket } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  connectedAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  lastActivity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  rooms</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ConnectionPool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt; {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced> clients</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&gt;();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced> userConnections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Register a new connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Store connection by client ID</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId, ws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Track by user ID if available</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (userId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>());</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Update user ID for an existing connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  associateWithUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ws.data.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> userId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>());</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Remove a connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ws.data.userId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Remove from clients map</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Clean up user association</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> connections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      connections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (connections.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Update activity timestamp</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  updateActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ws) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ws.data.lastActivity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Check if user is online (has any active connections)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  isUserOnline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Get all connections for a user</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  getUserConnections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;[] {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [];</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.userConnections.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId))</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Boolean) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;[];</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Get all clients</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  getAllClients</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ClientInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;[] {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.clients.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>());</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Send message to all connections of a specific user</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  sendToUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>P</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>schema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> P</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> connections</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>getUserConnections</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> connections) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Using the WebSocketRouter&#39;s message format</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          type: (schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).type,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          payload,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ConnectionPool;</span></span></code></pre></div><p data-v-c6285ced>Now let&#39;s integrate it with our router:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { randomUUID } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;crypto&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ConnectionPool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./connection-pool&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> chatRouter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./chat-router&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> AppData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  connectedAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  lastActivity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create the WebSocket router</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create connection pool</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> pool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ConnectionPool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add connection tracking</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Generate a unique ID for this connection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> randomUUID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Set initial connection metadata</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.clientId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> clientId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.connectedAt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.lastActivity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Add to connection pool</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId, ctx.ws);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Client connected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add activity tracking middleware</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Update last activity timestamp</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.lastActivity </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>updateActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.clientId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Continue processing</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// When user authenticates, associate their connection with their user ID</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.Authenticate, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Authentication logic...</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Associate connection with user</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (ctx.ws.data.userId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>associateWithUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.clientId, ctx.ws.data.userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Continue with normal flow...</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle disconnection</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Client disconnected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws.data.clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Add our chat routes</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>merge</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(chatRouter);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Expose pool to other modules</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { pool };</span></span></code></pre></div><p data-v-c6285ced>With this connection pool, you can now easily:</p><ul data-v-c6285ced><li data-v-c6285ced>Send messages to all of a user‚Äôs devices (multi-device support)</li><li data-v-c6285ced>Check if users are online</li><li data-v-c6285ced>Implement presence detection</li><li data-v-c6285ced>Monitor connection statistics</li></ul><h3 id="rate-limiting-and-throttling" tabindex="-1" data-v-c6285ced>Rate Limiting and Throttling <a class="header-anchor" href="#rate-limiting-and-throttling" aria-label="Permalink to ‚ÄúRate Limiting and Throttling‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Nothing ruins a WebSocket service faster than a client that sends messages at the speed of light (or a poorly written client that got stuck in a message loop). Let‚Äôs implement a rate limiter middleware:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> RateLimitOptions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Maximum messages per window</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  maxMessages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Time window in milliseconds</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  windowMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Optional exception for specific message types</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  excludeTypes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>[];</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> RateLimitData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  counter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  resetAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Store rate limit data by client ID</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> limiters</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>RateLimitData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Clean up stale rate limit data every 5 minutes</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>clientId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> limiters.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (data.resetAt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> now) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        limiters.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 60</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Create rate limiter middleware</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> RateLimitOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>maxMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>windowMs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>excludeTypes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [] } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> options;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> rateLimiterMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Skip rate limiting for excluded message types</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (excludeTypes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.type)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.clientId;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Can&#39;t rate limit without client ID</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> limiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> limiters.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Initialize or reset if window has passed</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>limiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> limiter.resetAt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> now) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      limiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        counter: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        resetAt: now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> windowMs,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      };</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      limiters.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(clientId, limiter);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Check if rate limit exceeded</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (limiter.counter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> maxMessages) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> secondsRemaining</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((limiter.resetAt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> now) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send error message with proper details</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &quot;RESOURCE_EXHAUSTED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &quot;Rate limit exceeded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        { secondsRemaining, maxMessages, windowMs },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        { retryable: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, retryAfterMs: limiter.resetAt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> now },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      );</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Stop processing</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Increment counter and continue</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    limiter.counter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  };</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>Now let&#39;s apply this middleware to our router:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { createRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./rate-limiter&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Apply rate limiting</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  createRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    maxMessages: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// 20 messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    windowMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>10_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// per 10 seconds</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    excludeTypes: [</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Don&#39;t rate limit typing indicators</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;TYPING_START&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;TYPING_STOP&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ],</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Rest of your server setup...</span></span></code></pre></div><h3 id="custom-pubsub-with-selective-message-delivery" tabindex="-1" data-v-c6285ced>Custom PubSub with Selective Message Delivery <a class="header-anchor" href="#custom-pubsub-with-selective-message-delivery" aria-label="Permalink to ‚ÄúCustom PubSub with Selective Message Delivery‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>While <strong data-v-c6285ced>WS-Kit</strong> provides built-in pub/sub through <code data-v-c6285ced>ctx.publish()</code> and <code data-v-c6285ced>ctx.subscribe()</code>, sometimes you need advanced filtering based on user properties. This section shows a custom implementation for scenarios requiring fine-grained control:</p><p data-v-c6285ced><strong data-v-c6285ced>For most applications, WS-Kit&#39;s native pub/sub is sufficient:</strong></p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Simple room-based broadcasting with WS-Kit</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.ChatMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Publish to all subscribers in room (with validation)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId, schema.ChatMessage, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId: ctx.ws.data.userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username: ctx.ws.data.username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    text,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Join room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.LeaveRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(roomId); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Leave room</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>**For advanced filtering use cases, here&#39;s a custom PubSub extension:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { ServerWebSocket } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define a topic subscriber with filtering options</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Subscriber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>  ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  filter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>};</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> EnhancedPubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt; {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced> topics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Subscriber</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;&gt;&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Subscribe a client to a topic with optional filter</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    filter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>());</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({ ws, filter });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Unsubscribe a client from a topic</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> subscribers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> toRemove</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(subscribers).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> sub.ws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ws);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> sub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> toRemove) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      subscribers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(sub);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (subscribers.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Unsubscribe a client from all topics</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  unsubscribeAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>subscribers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ws, topic);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Publish a message to all subscribers of a topic</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>P</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    sourceSender</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    schema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> P</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>    skipSender</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> subscribers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> sentCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      type: (schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).type,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      payload,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> subscribers) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Skip sender if requested</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (skipSender </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> sourceSender) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Apply filter if one exists</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (filter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ws.data)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send the message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      sentCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> sentCount;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Get count of subscribers for a topic</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  subscriberCount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  /**</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   * Get all topics a client is subscribed to</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>   */</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  getSubscribedTopics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>[] {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [];</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>subscribers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(subscribers).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>some</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> sub.ws </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ws)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(topic);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> result;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> EnhancedPubSub;</span></span></code></pre></div><p data-v-c6285ced>Now we can use this advanced PubSub system to implement features like:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> EnhancedPubSub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./enhanced-pubsub&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> AppData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> pubsub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> EnhancedPubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>AppData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle room joining with role-based filters</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.JoinRoom, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.username;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userRole</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Subscribe with filter - only receive messages for your role level and below</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pubsub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws, roomId, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> messageMinRole</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> clientData.messageMinRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (messageMinRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;admin&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;admin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Filter out admin-only messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      messageMinRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;moderator&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;admin&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;moderator&quot;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Filter out moderator-only messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Let others know user joined</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pubsub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws, roomId, schema.UserJoined, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`User ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>username</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>userId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}) joined room: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>roomId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Send message only to admins and moderators</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.ModAction, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>roomId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Only allow moderators and admins to send mod actions</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> userRole</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.data.userRole;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;moderator&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> userRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;admin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;PERMISSION_DENIED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      &quot;You don&#39;t have permission to perform moderator actions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Set minimum role to receive this message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.messageMinRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;moderator&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Publish to room (only mods/admins will receive it due to filter)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pubsub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws, roomId, schema.ModAction, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    roomId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    userId: ctx.ws.data.userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    username: ctx.ws.data.username,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    action,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Reset the message minimum role</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.ws.data.messageMinRole </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Clean up subscriptions when user leaves</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onClose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  pubsub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unsubscribeAll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.ws);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> router;</span></span></code></pre></div><h3 id="resilient-client-server-communication-with-acknowledgments" tabindex="-1" data-v-c6285ced>Resilient Client/Server Communication with Acknowledgments <a class="header-anchor" href="#resilient-client-server-communication-with-acknowledgments" aria-label="Permalink to ‚ÄúResilient Client/Server Communication with Acknowledgments‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>In real-time applications, ensuring message delivery can be critical. <strong data-v-c6285ced>WS-Kit</strong> provides built-in RPC support via <code data-v-c6285ced>router.rpc()</code> and <code data-v-c6285ced>client.request()</code>. However, for custom request/response patterns with explicit correlation IDs, you can implement acknowledgment-based communication:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Custom request-response pattern schemas</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// (Note: ws-kit&#39;s native RPC is simpler for most use cases)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> RequestMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;REQUEST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  requestId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  action: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  payload: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ResponseMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;RESPONSE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  requestId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  success: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  payload: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  error: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced><strong data-v-c6285ced>For simpler RPC use cases, consider WS-Kit&#39;s native RPC:</strong></p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Native WS-Kit RPC - no custom correlation needed</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> FetchProfile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;FETCH_PROFILE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { userId: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ProfileResponse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;PROFILE_RESPONSE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  id: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  name: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // ... other fields</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(FetchProfile, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> profile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> fetchUserProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ctx.payload.userId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ProfileResponse, profile); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Built-in correlation</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Client side with WS-Kit</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> profile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(FetchProfile, { userId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> });</span></span></code></pre></div><p data-v-c6285ced>Now let‚Äôs implement client-side request tracking:</p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocketClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> url;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.reconnectAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.maxReconnectAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.url);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;open&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connected to server&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.reconnectAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Resend any pending requests</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>requestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (request.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>_sendRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(request.message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(event.data);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Handle response messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (message.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;RESPONSE&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> message.payload.requestId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> requestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> message.payload.requestId;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> pendingRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (pendingRequest) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(pendingRequest.timeout);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (message.payload.success) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              pendingRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message.payload.payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              pendingRequest.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>                new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message.payload.error </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>||</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;Request failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>              );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Handle regular messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> handler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message.type);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (handler) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>          handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message.payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Error processing message:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.reconnectAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.maxReconnectAttempts) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> delay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.reconnectAttempts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>30000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Connection closed. Reconnecting in ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>delay</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}ms...`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.reconnectAttempts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>        setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(), delay);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Max reconnection attempts reached&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Reject all pending requests</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>requestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (request.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>            clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(request.timeout);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            request.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connection lost&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>));</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;WebSocket error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  _sendRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message));</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Send a message with acknowledgment</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>timeoutMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 10000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> requestId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>36</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>random</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>toString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>36</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>substr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;REQUEST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        payload: {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          requestId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          action,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          payload,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      };</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Set timeout for this request</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> timeout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId).status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;timeout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>          reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Request timeout for action: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>action</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>));</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }, timeoutMs);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Store the request</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(requestId, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        message,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        resolve,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        reject,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        timeout,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;pending&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send the message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> sent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>_sendRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // If not connected, don&#39;t immediately reject - reconnection will resend</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>sent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Socket not connected. Request ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>requestId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>} queued.`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Regular send without acknowledgment</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>_sendRaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      type,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      payload,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Register message handler</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  onMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(type, handler);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Clean disconnect</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  disconnect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>clear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>clear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>And on the server side:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> schema </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> RequestHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> requestHandlers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>RequestHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Register request handlers</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>requestHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;fetchUserProfile&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>userId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Check authorization</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>meta.userId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Authentication required&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Fetch user profile from database</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> profile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> fetchUserProfileFromDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(userId);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>profile) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;User not found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> profile; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// This becomes the response payload</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>requestHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;updateUserPreferences&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>preferences</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>meta.userId) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Authentication required&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Update preferences in database</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> updateUserPreferencesInDb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(meta.userId, preferences);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> }; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Acknowledge success</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Handle incoming requests</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setupRequestHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>router</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.RequestMessage, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>requestId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Find handler for this action</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> handler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> requestHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(action);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>handler) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Unknown action: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>action</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Execute the handler</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(payload, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        userId: ctx.ws.data.userId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send success response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.ResponseMessage, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        requestId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        payload: result,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Send error response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(schema.ResponseMessage, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        requestId,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        error: error </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> error.message </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(error),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced>Now you can use this pattern from the client:</p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocketClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;ws://localhost:3000/ws&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Using the request/response pattern</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> fetchUserProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>userId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> profile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;fetchUserProfile&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { userId });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;User profile:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, profile);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> profile;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (error) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Failed to fetch profile:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, error);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> error;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Using regular messages</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;CHAT_MESSAGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  displayChatMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(message);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>This approach gives you reliable communication with error handling, timeout detection, and automatic retries on reconnection ‚Äî far more robust than fire-and-forget message sending.</p><h3 id="connection-health-monitoring-with-heartbeats" tabindex="-1" data-v-c6285ced>Connection Health Monitoring with Heartbeats <a class="header-anchor" href="#connection-health-monitoring-with-heartbeats" aria-label="Permalink to ‚ÄúConnection Health Monitoring with Heartbeats‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>WebSocket connections can silently die or become &quot;zombies&quot; where the TCP connection is technically open but no longer passing messages. <strong data-v-c6285ced>WS-Kit</strong> provides built-in heartbeat support through router configuration:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { serve } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/bun&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { Meta } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define custom heartbeat messages for application-level monitoring</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> HeartbeatPing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PING&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  timestamp: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> HeartbeatPong</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PONG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  timestamp: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  latency: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Setup router with built-in heartbeat</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>&gt;({</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  heartbeat: {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    intervalMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>30_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Send heartbeat every 30 seconds</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timeoutMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>5_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Expect response within 5 seconds</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>    onStaleConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Stale connection detected: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Connection is automatically closed by framework</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Use this callback for cleanup if needed</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  },</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Optional: handle custom heartbeat messages for latency measurement</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(HeartbeatPing, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>timestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> latency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> timestamp;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(HeartbeatPong, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    timestamp,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    latency,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Setup server with heartbeat enabled</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(router, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  port: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span></code></pre></div><p data-v-c6285ced>For client-side monitoring of connection health:</p><div class="language-javascript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>javascript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> WebSocketClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // ... other code from earlier</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  setupHealthCheck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Track consecutive failures</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> failureCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> maxFailures</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>onMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PONG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Connection is healthy</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      failureCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Heartbeat latency: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>latency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}ms`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Optionally measure round-trip time</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.healthCheckInterval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.connected) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> startTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PING&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, { timestamp: startTime });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Set a timeout for response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> timeout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          failureCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Heartbeat timeout (${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>failureCount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}/${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>maxFailures</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>})`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (failureCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> maxFailures) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Connection unhealthy, reconnecting...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.socket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>();</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>            failureCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>        // Clear timeout if we get a response</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> originalOnMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PONG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;HEARTBEAT_PONG&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>          clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(timeout);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          failureCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>          console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>`Heartbeat latency: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>payload</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>latency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}ms`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>          originalOnMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>?.(payload);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>45000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Check every 45 seconds (offset from server&#39;s 30s)</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>  disconnect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>() {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.healthCheckInterval) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      clearInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>.healthCheckInterval);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // ... rest of disconnect code</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  }</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><p data-v-c6285ced><strong data-v-c6285ced>Key advantages of WS-Kit&#39;s built-in heartbeat:</strong></p><ul data-v-c6285ced><li data-v-c6285ced>Automatic detection of stale connections</li><li data-v-c6285ced>No manual connection tracking needed</li><li data-v-c6285ced>Configurable intervals and timeouts</li><li data-v-c6285ced>Framework handles connection cleanup</li><li data-v-c6285ced>Can be disabled by omitting heartbeat config</li></ul><h3 id="connection-upgrades-and-protocol-negotiation" tabindex="-1" data-v-c6285ced>Connection Upgrades and Protocol Negotiation <a class="header-anchor" href="#connection-upgrades-and-protocol-negotiation" aria-label="Permalink to ‚ÄúConnection Upgrades and Protocol Negotiation‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>In sophisticated applications, you might need to negotiate protocol features or upgrade connections to support different functionality:</p><div class="language-typescript" data-v-c6285ced><button title="Copy Code" class="copy" data-v-c6285ced></button><span class="lang" data-v-c6285ced>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-c6285ced><code data-v-c6285ced><span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { z, createRouter, message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;@ws-kit/zod&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { Meta } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;./schemas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Define feature flags</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> Feature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  COMPRESSION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;compression&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  ENCRYPTION</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;encryption&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  BATCHING</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;batching&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>  BINARY_MESSAGES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;binary_messages&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Negotiation message schemas</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ClientCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;CLIENT_CAPABILITIES&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  protocolVersion: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  features: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>nativeEnum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Feature)),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  compressionFormats: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>()).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> ServerCapabilities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;SERVER_CAPABILITIES&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  protocolVersion: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  supportedFeatures: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>nativeEnum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Feature)),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  enabledFeatures: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>nativeEnum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Feature)),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  compressionFormat: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>});</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Setup protocol negotiation</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> setupProtocolNegotiation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>router</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Server supported features</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> supportedFeatures</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> [Feature.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>COMPRESSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, Feature.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>BATCHING</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>];</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Handle client capabilities message</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ClientCapabilities, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>protocolVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>features</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>compressionFormats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.payload;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Check protocol version compatibility</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>isCompatibleVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(protocolVersion)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        &quot;INVALID_ARGUMENT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>        `Unsupported protocol version: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>protocolVersion</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}. Server requires 1.x`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      );</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Terminate connection - incompatible protocol</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>      setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> ctx.ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>1002</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;Incompatible protocol version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>        100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Determine which features to enable</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> enabledFeatures</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> supportedFeatures.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>feature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=&gt;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      features.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(feature),</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Store enabled features in connection metadata</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.ws.data.enabledFeatures </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> enabledFeatures;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Determine compression format if requested</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> compressionFormat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      enabledFeatures.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(Feature.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>COMPRESSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      compressionFormats </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>&amp;&amp;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      compressionFormats.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced>length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> 0</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>      // Choose first supported compression format</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (compressionFormats.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;gzip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        compressionFormat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;gzip&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> (compressionFormats.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;deflate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)) {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>        compressionFormat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced> &quot;deflate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      ctx.ws.data.compressionFormat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> compressionFormat;</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    }</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>    // Send server capabilities</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(ServerCapabilities, {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      protocolVersion: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      supportedFeatures,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      enabledFeatures,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>      compressionFormat,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    });</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>      `Negotiated protocol with ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>enabledFeatures</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>join</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;, &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>,</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>    );</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>  });</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span>
<span class="line" data-v-c6285ced></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>// Check if client version is compatible with server</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced> isCompatibleVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-c6285ced>clientVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-c6285ced> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> {</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-c6285ced>  // Simple version check - in real app you&#39;d use semver</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-c6285ced>  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced> clientVersion.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-c6285ced>startsWith</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-c6285ced>&quot;1.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>);</span></span>
<span class="line" data-v-c6285ced><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-c6285ced>}</span></span></code></pre></div><h3 id="conclusion-the-power-of-advanced-patterns" tabindex="-1" data-v-c6285ced>Conclusion: The Power of Advanced Patterns <a class="header-anchor" href="#conclusion-the-power-of-advanced-patterns" aria-label="Permalink to ‚ÄúConclusion: The Power of Advanced Patterns‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>By implementing these advanced patterns, you‚Äôve taken your WebSocket application from a simple message-passing system to a robust, production-ready communication platform. We‚Äôve covered:</p><ol data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Connection management</strong> with tracking, pooling, and user association</li><li data-v-c6285ced><strong data-v-c6285ced>Rate limiting</strong> to protect against accidental or malicious overload</li><li data-v-c6285ced><strong data-v-c6285ced>Enhanced PubSub</strong> with selective message delivery based on user properties</li><li data-v-c6285ced><strong data-v-c6285ced>Request/response patterns</strong> for reliable communication with acknowledgments</li><li data-v-c6285ced><strong data-v-c6285ced>Connection health monitoring</strong> with heartbeats to detect zombie connections</li><li data-v-c6285ced><strong data-v-c6285ced>Protocol negotiation</strong> for feature detection and progressive enhancement</li></ol><p data-v-c6285ced>Each of these patterns addresses real-world challenges you&#39;ll face when deploying WebSocket applications at scale. The beauty of using <strong data-v-c6285ced>WS-Kit</strong> is that its clean, type-safe foundation makes it easy to layer these advanced patterns on top without creating a tangled mess of code.</p><p data-v-c6285ced>Remember, in the world of WebSockets, the difference between a toy project and a production system isn‚Äôt just in the basic functionality ‚Äî it‚Äôs in how gracefully your application handles edge cases, failures, and scale. With these patterns in your toolkit, you‚Äôre well-equipped to build WebSocket applications that don‚Äôt just work in the happy path, but thrive in the chaotic reality of the real world.</p><p data-v-c6285ced>And the next time someone casually suggests ‚ÄúLet‚Äôs just add real-time messaging to our app, how hard could it be?‚Äù, you can smile knowingly ‚Äî and then build it right the first time.</p><h2 id="wrapping-it-up" tabindex="-1" data-v-c6285ced>Wrapping It Up <a class="header-anchor" href="#wrapping-it-up" aria-label="Permalink to ‚ÄúWrapping It Up‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>We&#39;ve taken quite a journey together, exploring how to build robust, type-safe WebSocket applications with Bun and <strong data-v-c6285ced>WS-Kit</strong>. From the basics of WebSocket communication to advanced patterns like connection management, authentication, and error handling, we&#39;ve covered the essentials of crafting real-time applications that are both maintainable and scalable.</p><h3 id="why-ws-kit-stands-out" tabindex="-1" data-v-c6285ced>Why WS-Kit Stands Out <a class="header-anchor" href="#why-ws-kit-stands-out" aria-label="Permalink to ‚ÄúWhy WS-Kit Stands Out‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced><strong data-v-c6285ced>WS-Kit</strong> represents a modern approach to WebSocket development:</p><ul data-v-c6285ced><li data-v-c6285ced><strong data-v-c6285ced>Platform-agnostic</strong>: Works with Bun, Cloudflare Durable Objects, and custom adapters</li><li data-v-c6285ced><strong data-v-c6285ced>Validator-agnostic</strong>: Choose between Zod, Valibot, or your own validation library</li><li data-v-c6285ced><strong data-v-c6285ced>Production-ready</strong>: Built on lessons learned from years of real-time systems experience</li><li data-v-c6285ced><strong data-v-c6285ced>Actively developed</strong>: Continuously improved based on community feedback</li></ul><p data-v-c6285ced>The library is designed to be the foundation for production applications while remaining simple enough for quick prototypes.</p><h2 id="getting-support" tabindex="-1" data-v-c6285ced>Getting Support <a class="header-anchor" href="#getting-support" aria-label="Permalink to ‚ÄúGetting Support‚Äù" data-v-c6285ced>‚Äã</a></h2><p data-v-c6285ced>If you encounter any issues, have questions, or want to contribute to the project, check out the WS-Kit repository on GitHub. You can also connect with the community and maintainers on Discord to share your experiences and get help troubleshooting any problems you might face.</p><h3 id="final-thoughts" tabindex="-1" data-v-c6285ced>Final Thoughts <a class="header-anchor" href="#final-thoughts" aria-label="Permalink to ‚ÄúFinal Thoughts‚Äù" data-v-c6285ced>‚Äã</a></h3><p data-v-c6285ced>Building real-time applications doesn&#39;t have to be complex or error-prone. With the right tools and patterns, you can focus on creating amazing user experiences without getting bogged down in the details of WebSocket message routing or type validation.</p><p data-v-c6285ced>Whether you&#39;re building a simple chat application or a sophisticated collaborative platform, <strong data-v-c6285ced>WS-Kit</strong> provides the foundation you need to create reliable, type-safe real-time experiences with confidence.</p><p data-v-c6285ced>Now go forth and build something amazing! And remember, in the fast-moving world of WebSockets, type safety isn&#39;t just a luxury ‚Äî it&#39;s your best friend.</p><p data-v-c6285ced>Happy coding!</p></div></div></main><footer class="VPDocFooter" data-v-7886d922 data-v-184d645f><!--[--><!--]--><div class="edit-info" data-v-184d645f><div class="edit-link" data-v-184d645f><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/ws-kit/edit/main/docs/posts/[slug].md" target="_blank" rel="noreferrer" data-v-184d645f><!--[--><span class="vpi-square-pen edit-link-icon" data-v-184d645f></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-184d645f><p class="VPLastUpdated" data-v-184d645f data-v-1bacbe43>Last updated: <time datetime="2025-11-06T11:56:29.000Z" data-v-1bacbe43></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-184d645f><span class="visually-hidden" id="doc-footer-aria-label" data-v-184d645f>Pager</span><div class="pager" data-v-184d645f><!----></div><div class="pager" data-v-184d645f><a class="VPLink link pager-link next" href="/ws-kit/getting-started" data-v-184d645f><!--[--><span class="desc" data-v-184d645f>Next page</span><span class="title" data-v-184d645f>Getting Started</span><!--]--></a></div></nav></footer><!--[--><!--[--><!--[--><div class="post-author" data-v-7763c96d><div class="author-info" data-v-7763c96d><div class="published-by" data-v-7763c96d> Published by <a href="https://github.com/undefined" target="_blank" rel="noopener noreferrer" class="author-name" data-v-7763c96d></a></div><!----></div><!----></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-c8fbc71f data-v-2a72c85a><div class="container" data-v-2a72c85a><p class="message" data-v-2a72c85a>Released under the <a href="https://github.com/kriasoft/ws-kit/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-2a72c85a>Copyright ¬© 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> ¬∑ Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"CZsUNZhd\",\"adr_001-message-context-conditional-payload-typing.md\":\"DZbz_n2q\",\"adr_002-typed-client-adapters.md\":\"BdSa4zgP\",\"adr_003-example-imports.md\":\"EQOIrSvD\",\"adr_005-builder-pattern-and-symbol-escape-hatch.md\":\"CNw1-qAS\",\"adr_006-multi-runtime-serve-with-explicit-selection.md\":\"l50RF6Rs\",\"adr_007-export-with-helpers-pattern.md\":\"CSwbTjpu\",\"adr_008-middleware-support.md\":\"7tqRjB1_\",\"adr_009-error-handling-and-lifecycle-hooks.md\":\"BdmH8OAA\",\"adr_010-throttled-broadcast-pattern.md\":\"Y0ZhJl_m\",\"adr_011-structured-logging-adapter.md\":\"Cp02VjhM\",\"adr_012-rpc-minimal-reliable.md\":\"D_5GJCLW\",\"adr_013-rpc-reconnect-idempotency.md\":\"B_jwCsqW\",\"adr_014-rpc-dx-safety-improvements.md\":\"BP59eMW5\",\"adr_015-unified-rpc-api-design.md\":\"BFGsnB9N\",\"adr_016-connection-data-api-naming.md\":\"D4XPW1v2\",\"adr_017-message-api-parameter-naming.md\":\"DvGTiu9x\",\"adr_018-broadcast-method-naming.md\":\"Nz9grqV8\",\"adr_019-ctx-publish-convenience-method.md\":\"DmIRYGmT\",\"adr_020-send-method-naming.md\":\"Wi2b7N9l\",\"adr_021-adapter-first-architecture.md\":\"DxUIpKe_\",\"adr_archive_004-typed-router-factory.md\":\"8lFM_SVN\",\"adr_readme.md\":\"DFs2wY4D\",\"advanced-usage.md\":\"BXfkiHcq\",\"api-reference.md\":\"ZA-2uUsp\",\"client-advanced.md\":\"Dqp6y_x8\",\"client-api.md\":\"CeH6Tk8o\",\"client-auth.md\":\"dl0SmQe6\",\"client-errors.md\":\"YvPICaoj\",\"client-setup.md\":\"CrHgHvzY\",\"core-concepts.md\":\"BxyKWodw\",\"deployment.md\":\"Dt9idVNf\",\"eslint-config.md\":\"DK3mn6lq\",\"examples.md\":\"fW9eeg-P\",\"getting-started.md\":\"CIi6Bs2p\",\"guides_advanced-multi-runtime.md\":\"CK-T33EU\",\"guides_on-vs-rpc.md\":\"B9qkp-_o\",\"guides_rate-limiting.md\":\"BrHvx_6P\",\"guides_rpc-troubleshooting.md\":\"BZ1jWNAS\",\"index.md\":\"vIhwTUvU\",\"invariants.md\":\"CU_Qmd1z\",\"message-schemas.md\":\"qw5PBQDb\",\"middleware.md\":\"BSrHa5K7\",\"patterns_delta-sync.md\":\"B1ZYmNAw\",\"patterns_flow-control.md\":\"CGTSKf4Y\",\"patterns_readme.md\":\"ZsgwgOlw\",\"patterns_state-channels.md\":\"CVtur-xc\",\"posts_building-websocket-router.md\":\"DCfNLFPT\",\"posts_index.md\":\"3dHF90Di\",\"posts_l.md\":\"4KzZCr_z\",\"posts_token-bucket-policies.md\":\"Wu0YI5jC\",\"posts_two-timestamps-one-message.md\":\"BmWdPzTp\",\"proposals_problems.local.md\":\"5ouzqCc7\",\"proposals_publish-issues.local.md\":\"6dvOeO0G\",\"proposals_rate-limiting.md\":\"CfW6CQ-B\",\"rpc.md\":\"Cu9Rvqaj\",\"specs_adapters.md\":\"DEQj2eR8\",\"specs_broadcasting.md\":\"97_CQdlr\",\"specs_client.md\":\"BGykBOQc\",\"specs_error-handling.md\":\"DVqh5jOf\",\"specs_patterns.md\":\"DWAPSBFh\",\"specs_readme.md\":\"CyeEz035\",\"specs_router.md\":\"4NKmnBoq\",\"specs_rules.md\":\"BW_GHv2Q\",\"specs_schema.md\":\"B7Ckj6Yv\",\"specs_test-requirements.md\":\"DlvURGFd\",\"specs_validation.md\":\"C0liY2aC\",\"valibot-integration.md\":\"DLxQM8nW\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"‚ö° WS-Kit\",\"description\":\"Schema-first WebSocket message router for Bun with TypeScript validation\",\"base\":\"/ws-kit/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Docs\",\"link\":\"/getting-started\"},{\"text\":\"Blog\",\"link\":\"/posts/\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/ws-kit/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Manual\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Message Schemas\",\"link\":\"/message-schemas\"},{\"text\":\"API Reference\",\"link\":\"/api-reference\"},{\"text\":\"Examples\",\"link\":\"/examples\"},{\"text\":\"Advanced Usage\",\"link\":\"/advanced-usage\"},{\"text\":\"Deployment\",\"link\":\"/deployment\"}]},{\"text\":\"Guides\",\"items\":[{\"text\":\"Rate Limiting\",\"link\":\"/guides/rate-limiting\"},{\"text\":\"On vs RPC\",\"link\":\"/guides/on-vs-rpc\"},{\"text\":\"RPC Troubleshooting\",\"link\":\"/guides/rpc-troubleshooting\"},{\"text\":\"Advanced Multi-Runtime\",\"link\":\"/guides/advanced-multi-runtime\"}]},{\"text\":\"Client\",\"items\":[{\"text\":\"Setup\",\"link\":\"/client-setup\"},{\"text\":\"API Reference\",\"link\":\"/client-api\"},{\"text\":\"Authentication\",\"link\":\"/client-auth\"},{\"text\":\"Error Handling\",\"link\":\"/client-errors\"},{\"text\":\"Advanced\",\"link\":\"/client-advanced\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/ws-kit/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/ws-kit\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/aW29wXyb7w\"},{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"bluesky\",\"link\":\"https://bsky.app/profile/kriasoft.com\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/ws-kit/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright ¬© 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> ¬∑ Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>⚡ WS-Kit</title>
    <meta name="description" content="Schema-first WebSocket message router for Bun with TypeScript validation">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/ws-kit/assets/style.D0W0Koqu.css" as="style">
    <link rel="preload stylesheet" href="/ws-kit/vp-icons.css" as="style">
    
    <script type="module" src="/ws-kit/assets/app.BPIPn9Qm.js"></script>
    <link rel="preload" href="/ws-kit/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/theme.DkRH7RWT.js">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/framework.Dl5MHC_T.js">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/posts.data.BfCso2-g.js">
    <link rel="modulepreload" href="/ws-kit/assets/posts_token-bucket-policies.md.BLw3pXHc.lean.js">
    <link rel="icon" href="/ws-kit/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="Bun WebSocket Router | Schema-First WebSocket Routing">
    <meta property="og:site_name" content="Bun WebSocket Router">
    <meta property="og:url" content="https://kriasoft.com/ws-kit/">
    <meta property="og:image" content="https://kriasoft.com/ws-kit/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="canonical" href="https://medium.com/gitconnected/designing-fair-token-bucket-policies-for-real-time-apps-289b00eb4435">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-7763c96d data-v-7ba21f5d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-67090c32></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-67090c32>Skip to content</a><!--]--><!----><header class="VPNav" data-v-7ba21f5d data-v-246ee1dc><div class="VPNavBar" data-v-246ee1dc data-v-6e8e6faa><div class="wrapper" data-v-6e8e6faa><div class="container" data-v-6e8e6faa><div class="title" data-v-6e8e6faa><div class="VPNavBarTitle" data-v-6e8e6faa data-v-8d71445d><a class="title" href="/ws-kit/" data-v-8d71445d><!--[--><!--]--><!----><span data-v-8d71445d>⚡ WS-Kit</span><!--[--><!--]--></a></div></div><div class="content" data-v-6e8e6faa><div class="content-body" data-v-6e8e6faa><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6e8e6faa><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6e8e6faa data-v-32814e69><span id="main-nav-aria-label" class="visually-hidden" data-v-32814e69> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/" tabindex="0" data-v-32814e69 data-v-d59822bf><!--[--><span data-v-d59822bf>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/getting-started" tabindex="0" data-v-32814e69 data-v-d59822bf><!--[--><span data-v-d59822bf>Docs</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/posts/" tabindex="0" data-v-32814e69 data-v-d59822bf><!--[--><span data-v-d59822bf>Blog</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6e8e6faa data-v-de36fa04><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-de36fa04 data-v-100541d2 data-v-c5986858><span class="check" data-v-c5986858><span class="icon" data-v-c5986858><!--[--><span class="vpi-sun sun" data-v-100541d2></span><span class="vpi-moon moon" data-v-100541d2></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6e8e6faa data-v-d3fa4316 data-v-3796cd85><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-bluesky"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6e8e6faa data-v-0b6fadab data-v-183df15d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-183df15d><span class="vpi-more-horizontal icon" data-v-183df15d></span></button><div class="menu" data-v-183df15d><div class="VPMenu" data-v-183df15d data-v-f0060311><!----><!--[--><!--[--><!----><div class="group" data-v-0b6fadab><div class="item appearance" data-v-0b6fadab><p class="label" data-v-0b6fadab>Appearance</p><div class="appearance-action" data-v-0b6fadab><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-0b6fadab data-v-100541d2 data-v-c5986858><span class="check" data-v-c5986858><span class="icon" data-v-c5986858><!--[--><span class="vpi-sun sun" data-v-100541d2></span><span class="vpi-moon moon" data-v-100541d2></span><!--]--></span></span></button></div></div></div><div class="group" data-v-0b6fadab><div class="item social-links" data-v-0b6fadab><div class="VPSocialLinks social-links-list" data-v-0b6fadab data-v-3796cd85><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-3796cd85 data-v-ce869f9f><span class="vpi-social-bluesky"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6e8e6faa data-v-04d22f6b><span class="container" data-v-04d22f6b><span class="top" data-v-04d22f6b></span><span class="middle" data-v-04d22f6b></span><span class="bottom" data-v-04d22f6b></span></span></button></div></div></div></div><div class="divider" data-v-6e8e6faa><div class="divider-line" data-v-6e8e6faa></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-7ba21f5d data-v-b04d4bdb><div class="container" data-v-b04d4bdb><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-b04d4bdb data-v-5dbb0e0c><button data-v-5dbb0e0c>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-7ba21f5d data-v-269a68b2><div class="VPDoc has-aside" data-v-269a68b2 data-v-4658cce5><!--[--><!--]--><div class="container" data-v-4658cce5><div class="aside" data-v-4658cce5><div class="aside-curtain" data-v-4658cce5></div><div class="aside-container" data-v-4658cce5><div class="aside-content" data-v-4658cce5><div class="VPDocAside" data-v-4658cce5 data-v-263c44e6><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-263c44e6 data-v-9a691e7b><div class="content" data-v-9a691e7b><div class="outline-marker" data-v-9a691e7b></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-9a691e7b>On this page</div><ul class="VPDocOutlineItem root" data-v-9a691e7b data-v-0ba3419b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-263c44e6></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-4658cce5><div class="content-container" data-v-4658cce5><!--[--><!--[--><!--[--><h1 data-v-7763c96d>Designing Fair Token Bucket Policies for Real-Time Apps</h1><!----><!--]--><!--]--><!--]--><main class="main" data-v-4658cce5><div style="position:relative;" class="vp-doc _ws-kit_posts_token-bucket-policies" data-v-4658cce5><div data-v-0f34702c><!----><blockquote data-v-0f34702c><p data-v-0f34702c>Sizing burst capacity and refill rates for chat, gaming, and streaming without starving legitimate users or enabling abuse.</p></blockquote><h2 id="the-problem-with-one-size-fits-all-rate-limiting" tabindex="-1" data-v-0f34702c>The Problem With One-Size-Fits-All Rate Limiting <a class="header-anchor" href="#the-problem-with-one-size-fits-all-rate-limiting" aria-label="Permalink to “The Problem With One-Size-Fits-All Rate Limiting”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>You launch your multiplayer game. The collision detection runs tight — good. Then a speedrunner discovers an exploit: spam move commands fast enough and the server&#39;s position updates lag behind optimistic rendering. Your rate limiter catches them at 30 messages, which feels fair. But then legitimate players in heated moments hit the same limit after 20 rapid inputs during a firefight.</p><p data-v-0f34702c>You dial the limit down to 15 to catch abuse earlier. Now everyone complains about input lag.</p><p data-v-0f34702c>Sound familiar?</p><p data-v-0f34702c>The problem isn&#39;t that rate limiting is wrong. It&#39;s essential for protecting backend resources and ensuring fair access. The problem is that <strong data-v-0f34702c>most policies treat all traffic the same</strong>, missing the fact that different applications have radically different traffic signatures. A chat app needs to tolerate sudden bursts when users paste code blocks. A game needs predictable, high-frequency streams. A video stream needs one massive initial burst, then steady flow.</p><p data-v-0f34702c>The token bucket algorithm is elegant enough to handle all three — but only if you size it correctly for your workload. This post shows you how to reason about capacity and refill rate, not as magic numbers, but as levers that directly model your application&#39;s behavior. You&#39;ll learn to distinguish between legitimate user behavior and abuse, then size your limits accordingly.</p><h2 id="how-token-buckets-work-a-quick-mental-model" tabindex="-1" data-v-0f34702c>How Token Buckets Work: A Quick Mental Model <a class="header-anchor" href="#how-token-buckets-work-a-quick-mental-model" aria-label="Permalink to “How Token Buckets Work: A Quick Mental Model”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>Token buckets are simple: tokens refill at a constant rate (<code data-v-0f34702c>r</code>), you consume tokens per message, and requests queue when empty. The key parameters are:</p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Refill rate</strong> (<code data-v-0f34702c>r</code>): tokens per second — your sustained message rate</li><li data-v-0f34702c><strong data-v-0f34702c>Burst capacity</strong> (<code data-v-0f34702c>B_max</code>): maximum tokens — how many messages you can send instantly</li></ul><p data-v-0f34702c>The magic: bursts are allowed without punishing inactive users. This is why token buckets beat leaky buckets for real-time apps.</p><h2 id="capacity-vs-refill-rate-the-fundamental-trade-off" tabindex="-1" data-v-0f34702c>Capacity vs. Refill Rate: The Fundamental Trade-Off <a class="header-anchor" href="#capacity-vs-refill-rate-the-fundamental-trade-off" aria-label="Permalink to “Capacity vs. Refill Rate: The Fundamental Trade-Off”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>These two parameters work together. Sized independently, they create terrible user experiences or dangerous security holes.</p><h3 id="capacity-burst-tolerance" tabindex="-1" data-v-0f34702c>Capacity: Burst Tolerance <a class="header-anchor" href="#capacity-burst-tolerance" aria-label="Permalink to “Capacity: Burst Tolerance”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>What it controls</strong>: How many tokens a user can consume in a single burst.</p><p data-v-0f34702c><strong data-v-0f34702c>If too low</strong>: Users feel input lag. A gamer can&#39;t respond quickly. A chatter can&#39;t paste a code block without hitting the limit.</p><p data-v-0f34702c><strong data-v-0f34702c>If too high</strong>: Attackers get a long window to flood before detection kicks in.</p><p data-v-0f34702c><strong data-v-0f34702c>Example comparison</strong> (chat app):</p><ul data-v-0f34702c><li data-v-0f34702c>Capacity 10, Rate 2/sec → allows 10 instant messages, then wait 5s. Feels slow.</li><li data-v-0f34702c>Capacity 100, Rate 2/sec → allows 100 instant messages, then wait 50s. Easy attack vector.</li><li data-v-0f34702c>Capacity 30, Rate 10/sec → allows 30 instant messages, then wait 2s. Good balance.</li></ul><h3 id="refill-rate-sustained-throughput" tabindex="-1" data-v-0f34702c>Refill Rate: Sustained Throughput <a class="header-anchor" href="#refill-rate-sustained-throughput" aria-label="Permalink to “Refill Rate: Sustained Throughput”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>What it controls</strong>: The long-term average message rate.</p><p data-v-0f34702c><strong data-v-0f34702c>If too low</strong>: Legitimate users feel starved. App feels sluggish.</p><p data-v-0f34702c><strong data-v-0f34702c>If too high</strong>: Abusers run rampant and can saturate the system.</p><p data-v-0f34702c><strong data-v-0f34702c>Example comparison</strong> (gaming):</p><ul data-v-0f34702c><li data-v-0f34702c>Rate 10/sec, Capacity 20 → 10 messages/sec sustained, burst of 20. Too slow for 60 Hz game.</li><li data-v-0f34702c>Rate 100/sec, Capacity 20 → 100 messages/sec sustained, but only 20-token burst. Drops packets on network jitter.</li><li data-v-0f34702c>Rate 60/sec, Capacity 120 → 60 messages/sec sustained, 2-second burst window. Matches 60 Hz tick rate perfectly.</li></ul><h3 id="the-pairing-principle" tabindex="-1" data-v-0f34702c>The Pairing Principle <a class="header-anchor" href="#the-pairing-principle" aria-label="Permalink to “The Pairing Principle”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>Set capacity and refill rate together, not independently. A useful formula:</p><div class="language-" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span data-v-0f34702c>recovery_time = capacity / refill_rate</span></span></code></pre></div><p data-v-0f34702c>If you want users to recover from a full burst in 3 seconds, size it as:</p><ul data-v-0f34702c><li data-v-0f34702c><code data-v-0f34702c>refill_rate = 20 tokens/sec</code> implies <code data-v-0f34702c>capacity = 60 tokens</code></li><li data-v-0f34702c><code data-v-0f34702c>refill_rate = 10 tokens/sec</code> implies <code data-v-0f34702c>capacity = 30 tokens</code></li></ul><p data-v-0f34702c>Both allow 3-second recovery, but the first sustains higher throughput while the second is more restrictive. Your choice depends on your app&#39;s typical load and abuse patterns.</p><table tabindex="0" data-v-0f34702c><thead data-v-0f34702c><tr data-v-0f34702c><th data-v-0f34702c>Use Case</th><th data-v-0f34702c>Capacity</th><th data-v-0f34702c>Rate/sec</th><th data-v-0f34702c>Sustained</th><th data-v-0f34702c>Recovery</th><th data-v-0f34702c>Outcome</th></tr></thead><tbody data-v-0f34702c><tr data-v-0f34702c><td data-v-0f34702c>Too Strict</td><td data-v-0f34702c>10</td><td data-v-0f34702c>2</td><td data-v-0f34702c>2 msg/sec</td><td data-v-0f34702c>5s</td><td data-v-0f34702c>Users churn from input lag</td></tr><tr data-v-0f34702c><td data-v-0f34702c>Chat (Balanced)</td><td data-v-0f34702c>100-200</td><td data-v-0f34702c>1-2</td><td data-v-0f34702c>1-2 msg/sec</td><td data-v-0f34702c>50-200s</td><td data-v-0f34702c>Handles history load without false positives</td></tr><tr data-v-0f34702c><td data-v-0f34702c>Gaming (30 Hz)</td><td data-v-0f34702c>10-15</td><td data-v-0f34702c>35-40</td><td data-v-0f34702c>35-40 msg/sec</td><td data-v-0f34702c>&lt;1s</td><td data-v-0f34702c>Matches game tick rate plus jitter margin</td></tr><tr data-v-0f34702c><td data-v-0f34702c>Too Loose</td><td data-v-0f34702c>500</td><td data-v-0f34702c>100</td><td data-v-0f34702c>100 msg/sec</td><td data-v-0f34702c>5s</td><td data-v-0f34702c>Abusers flood the system</td></tr></tbody></table><h2 id="domain-specific-policies" tabindex="-1" data-v-0f34702c>Domain-Specific Policies <a class="header-anchor" href="#domain-specific-policies" aria-label="Permalink to “Domain-Specific Policies”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>Real-time apps have distinct traffic signatures. Understanding yours is the key to sizing limits that work.</p><h3 id="chat-applications" tabindex="-1" data-v-0f34702c>Chat Applications <a class="header-anchor" href="#chat-applications" aria-label="Permalink to “Chat Applications”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>Traffic signature</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Users type at 0.6-1.1 words per second (roughly one message every 10-20 seconds under normal typing)</li><li data-v-0f34702c>Bursts occur: pasting code snippets, rapid-fire group conversation, media uploads</li><li data-v-0f34702c>False positives hurt engagement; users churn if rate limiting feels excessive</li><li data-v-0f34702c>Initial state: loading message history, fetching member lists, synchronizing presence</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Recommended policy</strong>:</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Capacity:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100-200</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Rate:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 1-2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages/sec</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Recovery</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> time:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 50-200</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> seconds</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Rationale</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Refill rate (1-2/sec) covers normal conversation: typical typing pace plus presence updates and typing indicators</li><li data-v-0f34702c>Capacity (100-200) handles the most common legitimate burst: loading message history on channel entry or pasting code snippets</li><li data-v-0f34702c>If a user loads 100 recent messages on entering a channel, they need burst capacity of at least 100</li><li data-v-0f34702c>Recovery time of 50-200 seconds is acceptable — users expect a pause after heavy activity like bulk uploads or rapid pasting</li><li data-v-0f34702c>Real test: User sends 50 fast messages (code paste or rapid conversation), 50-150 tokens remain, wait 25-150s, back to full bucket</li></ul><p data-v-0f34702c><strong data-v-0f34702c>What breaks this</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Capacity 10: Users copying code blocks get blocked constantly</li><li data-v-0f34702c>Rate 100/sec: Coordinated spam floods rooms before moderation</li><li data-v-0f34702c>Rate 0.5/sec: Users feel starved in group conversations</li><li data-v-0f34702c>No monitoring: You won&#39;t know when the policy is too strict</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Observability</strong>: Alert if more than 5% of users hit rate limits daily. This signals either a too-strict policy or a spam spike.</p><h3 id="multiplayer-gaming" tabindex="-1" data-v-0f34702c>Multiplayer Gaming <a class="header-anchor" href="#multiplayer-gaming" aria-label="Permalink to “Multiplayer Gaming”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>Traffic signature</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Players send input commands at the <strong data-v-0f34702c>game tick rate</strong> (e.g., 60 Hz = 60 messages/sec per player)</li><li data-v-0f34702c>One limit too low makes the game unplayable; one too high enables desynchronization attacks</li><li data-v-0f34702c>Different message types have different costs: position updates vs. chat messages</li><li data-v-0f34702c>Network jitter causes packet batching; the bucket must absorb temporary spikes</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Recommended policy</strong> (for a 30 Hz server):</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-player</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (position, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>rotation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>):</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Capacity:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 10-15</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> tokens</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (quick </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>action</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;combos&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Rate:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 35-40</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> tokens/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (30 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>Hz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> tick</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 20%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> safety</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> margin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-player</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> chat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (separate </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>bucket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>):</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Capacity:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Rate:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages/sec</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Rationale</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Refill rate must match or exceed the server&#39;s tick rate, plus a 20% safety margin for network jitter</li><li data-v-0f34702c>For a 30 Hz server, 35-40 tokens/sec ensures players can send and receive at the game&#39;s natural frequency</li><li data-v-0f34702c>Capacity (10-15 tokens) is small because gaming traffic is a continuous stream, not bursty — large bursts often signal abuse (spam scripts)</li><li data-v-0f34702c>Separate buckets prevent chat spam from blocking critical movement commands</li><li data-v-0f34702c>Scenario: Player executes a quick combo (5 actions). Bucket has tokens. Player spams chat. Chat bucket empties, but movement input still flows through</li></ul><p data-v-0f34702c><strong data-v-0f34702c>What breaks this</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Single bucket for all messages: Attacker spams chat, blocks position updates, player appears frozen</li><li data-v-0f34702c>Capacity 20: Temporary packet loss makes the game unplayable</li><li data-v-0f34702c>Capacity 500+: Malicious clients send fake position updates, world desynchronizes</li><li data-v-0f34702c>Rate 20/sec: Input lag on 60 Hz server feels terrible</li></ul><h3 id="streaming-live-video" tabindex="-1" data-v-0f34702c>Streaming (Live Video) <a class="header-anchor" href="#streaming-live-video" aria-label="Permalink to “Streaming (Live Video)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>Traffic signature</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Two-phase model: massive initial buffer-fill (0-10 seconds), then steady-state flow at video bitrate</li><li data-v-0f34702c>Phase 1 (buffer-fill): High-speed transfer to fill client buffer (e.g., 10 seconds of content upfront)</li><li data-v-0f34702c>Phase 2 (steady-state): Downloads at bitrate matched to playback speed (with minor pauses to prevent buffer overflow)</li><li data-v-0f34702c>Control plane: Viewers send heartbeats, seek requests, quality changes (low volume); Streamers send metadata updates</li></ul><p data-v-0f34702c><strong data-v-0f34702c>The Critical Buffer-Fill Calculation</strong>:</p><p data-v-0f34702c>Streaming policies must explicitly handle the initial massive burst. This is the most commonly missed piece.</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c># Example: 1080p stream at 6 Mbps, target 10-second buffer</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Video</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> bitrate:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>       750</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> KB/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (6 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>Mbps</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 750</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> kilobytes/second</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Buffer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> duration:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>     10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> seconds</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Initial</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> burst</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>  750</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> KB/sec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> ×</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> sec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 7,500</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> KB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 7.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> MB</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>This</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> minimum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> burst</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> your</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> policy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> must</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> allow.</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Recommended policy</strong> (per-viewer):</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Initial</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> buffer-fill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (first </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>connection</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> seek</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>):</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Capacity:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 7.5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> MB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (for </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>10s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Mbps</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Rate:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 750</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> KB/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (6 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>Mbps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Recovery</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> time:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> ~10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> seconds</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Steady-state</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> playback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (after </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>buffer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> full</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>):</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Capacity:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Bitrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> ×</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 2-3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> seconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (e.g., </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>1.5-2.25</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> MB</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> for</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Mbps</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> stream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Rate:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Video</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> bitrate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (e.g., </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>750</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> KB/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Control</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> plane</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (heartbeats, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>seeks,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> quality</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> changes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>):</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Capacity:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> actions</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Rate:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> actions/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (separate </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>bucket</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> transfer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Rationale</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Burst capacity must be sized to the actual initial buffer-fill requirement, not guessed</li><li data-v-0f34702c>For a 6 Mbps stream with 10-second target buffer, capacity must be <strong data-v-0f34702c>at least 7.5 MB</strong></li><li data-v-0f34702c>Steady-state capacity slightly larger than refill rate prevents underflow during minor network jitter</li><li data-v-0f34702c>Separate control plane prevents heartbeat timeouts or seek delays from being starved by data transfer</li><li data-v-0f34702c>Recovery time for initial burst is acceptable (users expect a few seconds of buffering on start)</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Calculating for Your Bitrate</strong>:</p><p data-v-0f34702c>First, convert Mbps to KB/sec (divide by 8): 6 Mbps → 750 KB/sec. Then multiply by buffer duration.</p><table tabindex="0" data-v-0f34702c><thead data-v-0f34702c><tr data-v-0f34702c><th data-v-0f34702c>Bitrate</th><th data-v-0f34702c>KB/sec</th><th data-v-0f34702c>5s Buffer</th><th data-v-0f34702c>10s Buffer</th><th data-v-0f34702c>15s Buffer</th></tr></thead><tbody data-v-0f34702c><tr data-v-0f34702c><td data-v-0f34702c>2.5 Mbps (480p)</td><td data-v-0f34702c>312.5</td><td data-v-0f34702c>1.56 MB</td><td data-v-0f34702c>3.125 MB</td><td data-v-0f34702c>4.7 MB</td></tr><tr data-v-0f34702c><td data-v-0f34702c>5 Mbps (720p)</td><td data-v-0f34702c>625</td><td data-v-0f34702c>3.13 MB</td><td data-v-0f34702c>6.25 MB</td><td data-v-0f34702c>9.4 MB</td></tr><tr data-v-0f34702c><td data-v-0f34702c>8 Mbps (1080p)</td><td data-v-0f34702c>1,000</td><td data-v-0f34702c>5 MB</td><td data-v-0f34702c>10 MB</td><td data-v-0f34702c>15 MB</td></tr></tbody></table><p data-v-0f34702c><strong data-v-0f34702c>What breaks this</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Using a generic 100-token capacity: Can&#39;t handle even 5 seconds of buffer-fill at real-world bitrates</li><li data-v-0f34702c>Mixing data and control in one bucket: Heartbeats timeout while buffering, users see &quot;connection lost&quot;</li><li data-v-0f34702c>Heartbeat rate 0.2/sec: Users seeking every few seconds hit the control limit</li><li data-v-0f34702c>Not accounting for buffer-fill: Users experience long startup delays on first play or after seeking</li></ul><h2 id="layering-limits-per-user-per-route-cost-based" tabindex="-1" data-v-0f34702c>Layering Limits: Per-User, Per-Route, Cost-Based <a class="header-anchor" href="#layering-limits-per-user-per-route-cost-based" aria-label="Permalink to “Layering Limits: Per-User, Per-Route, Cost-Based”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>A single global limit is a blunt instrument. Production systems need multiple layers of protection.</p><h3 id="the-pyramid-of-protection" tabindex="-1" data-v-0f34702c>The Pyramid of Protection <a class="header-anchor" href="#the-pyramid-of-protection" aria-label="Permalink to “The Pyramid of Protection”" data-v-0f34702c>​</a></h3><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Global</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (all </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>users,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> all</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>    ↓</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Per-Device</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (catch </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>botnets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>    ↓</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-User</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Per-Type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (fairness </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>between</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>    ↓</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-Route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> Cost-Based</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (protect </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>expensive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> operations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Example: Chat room with 10,000 users</strong>:</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Global:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100,000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages/sec</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-IP:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> messages/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (catch </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>credential</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> stuffing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-User:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 20/sec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> per</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> type</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-Route:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> TEXT=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> token,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> ADMIN_COMMAND=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> tokens</span></span></code></pre></div><h3 id="per-user-per-type-most-common" tabindex="-1" data-v-0f34702c>Per-User Per-Type (Most Common) <a class="header-anchor" href="#per-user-per-type-most-common" aria-label="Permalink to “Per-User Per-Type (Most Common)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>One bucket per (user, message type) pair. Chat messages have a separate quota from presence updates.</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Per-user per-type (in-memory adapter shown; swap for Redis/Durable Objects in production)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { rateLimit, keyPerUserPerType } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/middleware&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { memoryRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> limiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  key: keyPerUserPerType,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(limiter);</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(ChatSendMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(ChatSentMessage, { message: ctx.payload.text });</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(PresenceUpdateMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>&quot;presence&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, PresenceChangedMessage, {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    userId: ctx.data?.userId,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  });</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Why it works</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Prevents one chatty user from monopolizing bandwidth and starving others</li><li data-v-0f34702c>Different message types can have different tolerances based on their impact</li><li data-v-0f34702c>Fair: each user gets an independent quota per message type</li><li data-v-0f34702c>Simple to reason about and tune based on real-world usage</li></ul><h3 id="cost-based-limiting-advanced" tabindex="-1" data-v-0f34702c>Cost-Based Limiting (Advanced) <a class="header-anchor" href="#cost-based-limiting-advanced" aria-label="Permalink to “Cost-Based Limiting (Advanced)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>Different operations consume different amounts of resources. GitHub and Shopify use this for GraphQL APIs — it&#39;s equally powerful for WebSockets.</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Single unified rate limiter with custom cost per operation</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { rateLimit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/middleware&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { memoryRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> limiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> ctx.data?.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;anon&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> `user:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  },</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  cost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>    // All costs must be positive integers</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (ctx.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;ChatSend&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (ctx.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;FileUpload&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (ctx.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;AdminBan&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (ctx.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;HistorySearch&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// default</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  },</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(limiter);</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Why it works</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Expensive operations (database queries, external APIs) cost more tokens</li><li data-v-0f34702c>Cheap operations (presence updates, heartbeats) cost less, allowing higher frequency</li><li data-v-0f34702c>Single shared bucket prevents any one operation type from monopolizing quota</li><li data-v-0f34702c>Users have flexibility: spend budget on many cheap operations or a few expensive ones</li><li data-v-0f34702c>Scales better than managing dozens of independent buckets</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Trade-off</strong>: Costs must align with actual resource consumption. Misjudged costs will either starve legitimate users or enable abuse.</p><h3 id="choosing-a-rate-limiter-adapter" tabindex="-1" data-v-0f34702c>Choosing a Rate Limiter Adapter <a class="header-anchor" href="#choosing-a-rate-limiter-adapter" aria-label="Permalink to “Choosing a Rate Limiter Adapter”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>Examples above use <code data-v-0f34702c>memoryRateLimiter</code>. For production, choose your adapter based on deployment:</p><table tabindex="0" data-v-0f34702c><thead data-v-0f34702c><tr data-v-0f34702c><th data-v-0f34702c>Adapter</th><th data-v-0f34702c>Best For</th><th data-v-0f34702c>Latency</th></tr></thead><tbody data-v-0f34702c><tr data-v-0f34702c><td data-v-0f34702c>In-Memory</td><td data-v-0f34702c>Single server, dev/test</td><td data-v-0f34702c>&lt;1ms</td></tr><tr data-v-0f34702c><td data-v-0f34702c>Redis</td><td data-v-0f34702c>Distributed fleets</td><td data-v-0f34702c>2-5ms</td></tr><tr data-v-0f34702c><td data-v-0f34702c>Durable Objects</td><td data-v-0f34702c>Edge/global</td><td data-v-0f34702c>10-50ms</td></tr></tbody></table><p data-v-0f34702c>Swap the adapter and the semantics remain identical:</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { redisRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/redis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> limiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>redisRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(redis, { capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  key: keyPerUserPerType,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Note on imports</strong>: Each adapter is available via a subpath export. Use <code data-v-0f34702c>@ws-kit/memory</code>, <code data-v-0f34702c>@ws-kit/redis</code>, or <code data-v-0f34702c>@ws-kit/cloudflare</code> to import only the adapter you need. Importing from <code data-v-0f34702c>@ws-kit/memory, @ws-kit/redis, @ws-kit/cloudflare</code> directly requires explicit adapter selection via the platform-specific factories.</p><h3 id="how-to-calculate-costs" tabindex="-1" data-v-0f34702c>How to Calculate Costs <a class="header-anchor" href="#how-to-calculate-costs" aria-label="Permalink to “How to Calculate Costs”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>Assigning costs requires understanding what each operation actually costs your backend:</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Example cost calculation based on database operations</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// All costs must be positive integers (no decimals, no zero/negative values)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> operationCosts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>  // Simple, in-memory operations (cost = 1)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  PresenceUpdate: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Just update local state</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  TypingIndicator: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Ephemeral, instant delivery</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>  // Database reads (cost = 2-5 depending on complexity)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  MessageGet: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Single document read</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  UserProfile: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Cache-friendly read</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>  // Database writes (cost = 5-10 including indexing)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  MessageSend: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Write + index update</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  MessageEdit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Update + audit log</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>  // Expensive operations (cost = 20-50 for CPU-intensive work)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  MessageSearch: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Full-text search across millions</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  HistoryExport: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Generates file, might send email</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  AnalyticsQuery: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Aggregates data across time range</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>};</span></span></code></pre></div><p data-v-0f34702c>Start with these simple ratios:</p><ul data-v-0f34702c><li data-v-0f34702c>In-memory operations: 1 token</li><li data-v-0f34702c>Database reads: 2-5 tokens (depends on complexity)</li><li data-v-0f34702c>Database writes: 5-10 tokens (include indexing, replication)</li><li data-v-0f34702c>External API calls: 10-20 tokens (includes latency uncertainty)</li><li data-v-0f34702c>Aggregations/searches: 20-50 tokens (CPU-intensive)</li></ul><p data-v-0f34702c>Then validate by measuring actual P95 latencies. If <code data-v-0f34702c>message.search</code> takes 100ms and <code data-v-0f34702c>message.send</code> takes 10ms, but both cost 5 tokens, you&#39;re underweighting search. Increase its cost to 50 tokens.</p><h2 id="common-mistakes-and-red-flags" tabindex="-1" data-v-0f34702c>Common Mistakes and Red Flags <a class="header-anchor" href="#common-mistakes-and-red-flags" aria-label="Permalink to “Common Mistakes and Red Flags”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>The most impactful rate-limiting failures in production boil down to three design errors. These are the battle scars from real systems.</p><h3 id="_1-capacity-way-higher-than-refill-rate-most-common" tabindex="-1" data-v-0f34702c>1. Capacity Way Higher Than Refill Rate (Most Common) <a class="header-anchor" href="#_1-capacity-way-higher-than-refill-rate-most-common" aria-label="Permalink to “1. Capacity Way Higher Than Refill Rate (Most Common)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>The Failure Mode</strong>: This is why most rate-limiting deployments fail in their first week.</p><p data-v-0f34702c>❌ Bad: Capacity 1000, Rate 10/sec = 100-second burst window.</p><p data-v-0f34702c>An attacker (or botnet) exploits the massive window: they send 1000 requests in 10 seconds while your monitoring system is still sleeping. The damage is done before typical monitoring thresholds are breached and alerts fire — by then, the database is already melting.</p><p data-v-0f34702c><strong data-v-0f34702c>Real-world impact</strong>: In early 2023, a major gaming platform experienced a DDoS that succeeded not because attacks were fast, but because their burst window was so large that coordinated spam flooded the system before rate-limit signals propagated to edge nodes.</p><p data-v-0f34702c>✅ Fix: Use the formula <code data-v-0f34702c>capacity ≈ refill_rate * desired_recovery_time</code>. A 10/sec refill rate with a 3-second recovery window means capacity ≈ 30. An attacker can&#39;t get meaningful damage done in 3 seconds.</p><h3 id="_2-confusing-per-user-and-global-limits-second-most-common" tabindex="-1" data-v-0f34702c>2. Confusing Per-User and Global Limits (Second Most Common) <a class="header-anchor" href="#_2-confusing-per-user-and-global-limits-second-most-common" aria-label="Permalink to “2. Confusing Per-User and Global Limits (Second Most Common)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>The Failure Mode</strong>: Limits work independently instead of layered, creating security gaps or fairness problems.</p><p data-v-0f34702c>❌ Bad approach 1: Per-user limit only → one power user or coordinated botnet saturates the server&#39;s total capacity.</p><p data-v-0f34702c>❌ Bad approach 2: Global limit only → one misbehaving user or network spike blocks all other users. Innocent mobile users in high-latency regions get starved.</p><p data-v-0f34702c><strong data-v-0f34702c>Real-world impact</strong>: A real-time collaboration platform launched with per-user limits but no global cap. During a product launch event, legitimate traffic from 50,000 concurrent users each hitting their personal limit harmlessly... except in aggregate they exceeded the database&#39;s actual throughput. The platform went down not from abuse, but from scale.</p><p data-v-0f34702c>✅ Fix: Implement the pyramid structure. Global limits upstream catch coordinated attacks by restricting aggregate capacity across all users and IPs — even if every single user stays within their quota, the sum cannot overwhelm the database. Per-user limits downstream ensure fairness. Both must exist.</p><h3 id="_3-not-accounting-for-network-jitter-subtle-but-frequent" tabindex="-1" data-v-0f34702c>3. Not Accounting for Network Jitter (Subtle but Frequent) <a class="header-anchor" href="#_3-not-accounting-for-network-jitter-subtle-but-frequent" aria-label="Permalink to “3. Not Accounting for Network Jitter (Subtle but Frequent)”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>The Failure Mode</strong>: Policies work perfectly in the lab but fail mysteriously in production due to real-world network behavior.</p><p data-v-0f34702c>❌ Bad: Capacity 5, Rate 10/sec. Looks reasonable on paper: 0.5-second recovery.</p><p data-v-0f34702c>On a flaky mobile network, packet loss causes TCP to retransmit and batch messages. The client bursts 5 messages in rapid succession. Bucket emptied. User can&#39;t send anything for 0.5 seconds. It feels like input lag.</p><p data-v-0f34702c>At scale, 10% of users experience this on Tuesday afternoons when cellular networks are congested. Support tickets flood in. You revert the rollout.</p><p data-v-0f34702c>✅ Fix: Add 1-2 seconds of headroom to your capacity parameter — enough to absorb traffic bursts lasting that duration. For a 10/sec rate, use capacity 30-50 (representing 3-5 seconds of refill), not 10. This absorbs temporary network spikes without being a security hole (recovery is still fast: 3-5 seconds).</p><h3 id="other-considerations" tabindex="-1" data-v-0f34702c>Other Considerations <a class="header-anchor" href="#other-considerations" aria-label="Permalink to “Other Considerations”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>If building cost-based limits (advanced), ensure operation costs match actual resource consumption — misjudged weights starve expensive queries or enable cheap-operation spam. Cost assignment is iterative: start with educated guesses (database reads cost more than presence updates), then continuously validate against actual latencies and user behavior, adjusting weights every few weeks. For multi-phase services, tie buckets to stable identifiers (session or device ID, not just user ID) to avoid losing tokens on login. Finally, always layer limits — global upstream, per-operation downstream — so bugs in one handler don&#39;t cascade.</p><h2 id="testing-and-tuning-your-policy" tabindex="-1" data-v-0f34702c>Testing and Tuning Your Policy <a class="header-anchor" href="#testing-and-tuning-your-policy" aria-label="Permalink to “Testing and Tuning Your Policy”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>Choosing initial values is only half the battle. The other half is validating them against real-world usage patterns.</p><h3 id="load-testing-strategy" tabindex="-1" data-v-0f34702c>Load Testing Strategy <a class="header-anchor" href="#load-testing-strategy" aria-label="Permalink to “Load Testing Strategy”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>Before deploying to production, validate your policy with synthetic load:</p><ol data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Baseline test</strong>: Run legitimate usage at 10x typical load. Verify that normal users don&#39;t hit limits.</li><li data-v-0f34702c><strong data-v-0f34702c>Burst test</strong>: Simulate network jitter by batching messages. Ensure capacity absorbs temporary spikes without false positives.</li><li data-v-0f34702c><strong data-v-0f34702c>Abuse test</strong>: Run coordinated spam from multiple IPs/users. Verify that global and per-IP limits catch coordinated attacks before they saturate the system.</li><li data-v-0f34702c><strong data-v-0f34702c>Edge case test</strong>: Run mixed workloads (some users light, some heavy). Verify that fair distribution works as expected.</li></ol><h3 id="monitoring-during-rollout" tabindex="-1" data-v-0f34702c>Monitoring During Rollout <a class="header-anchor" href="#monitoring-during-rollout" aria-label="Permalink to “Monitoring During Rollout”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>When deploying to production, ramp up gradually:</p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Week 1</strong>: Deploy to 5% of users. Monitor metrics hourly. Look for unexpected spikes in rejected requests.</li><li data-v-0f34702c><strong data-v-0f34702c>Week 2</strong>: Expand to 25% of users. Watch for patterns (time of day? geographic? user type?).</li><li data-v-0f34702c><strong data-v-0f34702c>Week 3-4</strong>: Full rollout with continued monitoring.</li></ul><p data-v-0f34702c>Track these metrics:</p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Rate limit hit rate</strong> (by message type, user tier): Should be &lt;1% for legitimate traffic</li><li data-v-0f34702c><strong data-v-0f34702c>Histogram of tokens remaining at rejection</strong>: If users always have 0 tokens, you&#39;re too strict. If they have plenty, you&#39;re too loose.</li><li data-v-0f34702c><strong data-v-0f34702c>Time since last refill</strong>: How long do users wait after hitting a limit? Should match your recovery_time.</li><li data-v-0f34702c><strong data-v-0f34702c>P95 latency of rate limit checks</strong>: Keep &lt;1ms. Slow checks block your event loop.</li></ul><h3 id="tuning-based-on-real-data" tabindex="-1" data-v-0f34702c>Tuning Based on Real Data <a class="header-anchor" href="#tuning-based-on-real-data" aria-label="Permalink to “Tuning Based on Real Data”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>After 2-4 weeks of data, adjust:</p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>If &lt;0.1% hit the limit</strong>: Your policy is too loose. Users may complain if you see coordinated spam.</li><li data-v-0f34702c><strong data-v-0f34702c>If 0.1%-1% hit the limit</strong>: Good zone. Some legitimate power users hit it, but most don&#39;t.</li><li data-v-0f34702c><strong data-v-0f34702c>If 1%-5% hit the limit</strong>: Getting strict. Watch user support tickets for complaints about input lag or sluggish feel.</li><li data-v-0f34702c><strong data-v-0f34702c>If &gt;5% hit the limit</strong>: Too strict. You&#39;re harming legitimate users.</li></ul><p data-v-0f34702c>Also consider:</p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Seasonal patterns</strong>: Games may be stricter during tournaments. Chat apps during product launches.</li><li data-v-0f34702c><strong data-v-0f34702c>User cohorts</strong>: Free users might have stricter limits than paid. Mobile users might have more generous limits due to network variance.</li><li data-v-0f34702c><strong data-v-0f34702c>Abuse trends</strong>: If a particular message type is being attacked, tighten its limit without affecting others.</li></ul><h2 id="real-world-case-study-roomchat" tabindex="-1" data-v-0f34702c>Real-World Case Study: RoomChat <a class="header-anchor" href="#real-world-case-study-roomchat" aria-label="Permalink to “Real-World Case Study: RoomChat”" data-v-0f34702c>​</a></h2><p data-v-0f34702c><strong data-v-0f34702c>Setup</strong>: Collaborative room editor with real-time cursor positions and code editing. 10,000 concurrent users, averaging 2-3 Mbps egress during peak hours. Launch week: everything seemed fine. Week two: support tickets spiked.</p><p data-v-0f34702c><strong data-v-0f34702c>Initial policy</strong> (launched naively):</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> per-type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 200,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100/sec</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Why this choice</strong>: Backend could handle ~100k msg/sec aggregate. With 10k users, averaging 10 msg/sec each felt reasonable. The team picked 100/sec as a &quot;burst allowance&quot; without much thought — it came from dividing remaining capacity by active users at a single snapshot.</p><p data-v-0f34702c><strong data-v-0f34702c>Week 1-2: The Discovery Phase</strong></p><p data-v-0f34702c>Support tickets: &quot;Rate limit? I just pasted a code snippet&quot; and &quot;My cursor keeps disappearing.&quot;</p><p data-v-0f34702c>First instinct: check if it&#39;s users on weird network conditions or if everyone&#39;s being blocked equally.</p><div class="language-" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span data-v-0f34702c>Oct 15 — rate_limit_hit_total: 2.3% of active users hitting limits</span></span>
<span class="line" data-v-0f34702c><span data-v-0f34702c>Oct 16 — pulled message breakdown: TEXT_MESSAGE 12% of hits, CODE_PASTE 31%, CURSOR_POSITION 89%</span></span>
<span class="line" data-v-0f34702c><span data-v-0f34702c>Oct 17 — chart of hits by time of day: spiky, not uniform (but no clear pattern yet)</span></span></code></pre></div><p data-v-0f34702c>Initial hypothesis: &quot;Bucket&#39;s too small, users are naturally bursty.&quot; Increased capacity to 500 and shipped it midweek, fingers crossed.</p><p data-v-0f34702c><strong data-v-0f34702c>Week 2-3: The False Start</strong></p><p data-v-0f34702c>Capacity 500 helped... sort of. Some metrics improved dramatically, others barely moved:</p><div class="language-" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span data-v-0f34702c>CURSOR_POSITION hits: 89% → 47% (huge win, network jitter absorbed)</span></span>
<span class="line" data-v-0f34702c><span data-v-0f34702c>TEXT_MESSAGE hits: 12% → 9% (minor improvement)</span></span>
<span class="line" data-v-0f34702c><span data-v-0f34702c>CODE_PASTE hits: 31% → 19% (only 12-point drop, still high)</span></span></code></pre></div><p data-v-0f34702c>But in the support channel: &quot;I pasted a 50-line snippet and got rate limited.&quot; Still happening at 19% — not acceptable.</p><p data-v-0f34702c>Plus, during testing, one engineer noticed: if you rapidly paste 5 code blocks, the server logs don&#39;t show 5 separate CODE_PASTE messages arriving. They show 3 or 4, sometimes out of order. TCP batching on 4G was real.</p><p data-v-0f34702c><strong data-v-0f34702c>Root cause discovery</strong> (messy, took longer than expected):</p><p data-v-0f34702c>One engineer pulled wire timings from production—looking at actual message arrival patterns. First observation: code pastes weren&#39;t evenly spaced. A user would send one paste, and the server would receive it as 2-3 fragmented TCP packets within 50ms. The token bucket saw each fragment as a separate message.</p><p data-v-0f34702c>Hypothesis: &quot;Network batching is compressing things.&quot; But how much?</p><p data-v-0f34702c>Checked message sizes: text messages averaged 80 bytes, code pastes 2-4 KB. On a congested 4G network, the TCP stack groups multiple frames together. A single logical &quot;paste code block&quot; operation becomes 3-4 physical packets arriving in rapid succession.</p><p data-v-0f34702c>More investigation: ran a load test with intentional packet loss. At 5% loss, CODE_PASTE hit rate jumped from 19% to 34%. At 15% loss (simulating congested networks), it hit 41%.</p><p data-v-0f34702c>Additionally discovered during an unrelated audit: <code data-v-0f34702c>10k users × 100/sec = 1M msg/sec theoretical capacity</code>. Reality check against database: the backend maxed out around 150k/sec sustained load. We were giving users a budget that the infrastructure couldn&#39;t actually handle.</p><p data-v-0f34702c><strong data-v-0f34702c>Week 3-4: Iterating (with setbacks)</strong></p><p data-v-0f34702c>Strategy 1: Separate buckets by message type, uniform token cost.</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>TEXT_MESSAGE:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 50,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 20/sec</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>CODE_PASTE:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 80,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 8/sec</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>CURSOR_POSITION:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 300,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100/sec</span></span></code></pre></div><p data-v-0f34702c>Deployed. After 2 days, CODE_PASTE hits were down to 15% — progress but still unacceptable. Cursor felt smooth. Text felt fine. But code paste users were still complaining.</p><p data-v-0f34702c>Late-week realization (and this was annoying): the issue wasn&#39;t rate — it was <em data-v-0f34702c>capacity</em>. Users could hit their CODE_PASTE bucket almost immediately during packet batching. Once empty, they had to wait 10 seconds for recovery. That felt broken.</p><p data-v-0f34702c>Strategy 2: Different approach. Maybe code pastes cost more than text messages because they&#39;re actually more expensive on the backend.</p><p data-v-0f34702c>Measured actual server resource consumption:</p><ul data-v-0f34702c><li data-v-0f34702c>TEXT_MESSAGE: ~0.5ms processing</li><li data-v-0f34702c>CODE_PASTE: 2.5-4ms processing (syntax highlighting, diff calculation, conflict detection)</li><li data-v-0f34702c>CURSOR_POSITION: ~0.1ms processing</li></ul><p data-v-0f34702c>Cost weighting: code paste takes 5-8x longer. So cost them more tokens.</p><p data-v-0f34702c><strong data-v-0f34702c>Final tuned policy</strong> (end of week 4):</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Global:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 80,000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> msg/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (150k/sec </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> minus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> headroom,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> with</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> some</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> buffer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> spikes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>Per-user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> per-type:</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  TEXT_MESSAGE:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 50,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 20/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>token</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> each</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  CODE_PASTE:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 3/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (5 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>tokens</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> each</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>accounts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> actual</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> backend</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> overhead</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  CURSOR_POSITION:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> capacity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 500,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> 100/sec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (0.5 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>tokens</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>cheap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Rollout</strong> (week 5, then week 6):</p><p data-v-0f34702c>Friday deploy: Canary to 5% of traffic. Monitored hourly over the weekend — hit rate hovered around 1.6-1.9%. Not perfect, but better than 2.3%.</p><p data-v-0f34702c>Monday morning: Expanded to 30% (skipped the &quot;25%&quot; step; ops team wanted to move faster). Hit rate climbed to 2.1% during peak hours. Huh. Global limit + network spike during Monday morning activity. Pulled the release back to 5% after 4 hours.</p><p data-v-0f34702c>Mid-week investigation: realized the global 80k limit was too tight for genuine peaks. Bumped to 95k. Re-deployed to 30%. Steadier at 1.3-1.7%.</p><p data-v-0f34702c>Friday: Full rollout to 100%. First week: 1.4%, 1.8%, 1.1%, 1.9%, 1.5% day-to-day. Not the clean 0.8-1.2% range. More like 1-2%, with occasional spikes to 2.1% during product launch days or when heavy European users come online.</p><p data-v-0f34702c>Current state (2 months later): still hovering around 1.3% average, with weeks ranging 0.9%-2.2% depending on user activity patterns.</p><p data-v-0f34702c><strong data-v-0f34702c>What we learned from actual data</strong>:</p><ol data-v-0f34702c><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Initial assumptions were confidently wrong</strong>. Dividing backend capacity by user count sounds logical; it&#39;s still wrong. Real traffic doesn&#39;t distribute evenly. One 10,000-user instance isn&#39;t the same as ten 1,000-user instances.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Network batching isn&#39;t a theoretical problem</strong>. It shows up in production the moment users are on congested networks. Staging with 500 synthetic users showed 0.2% hit rate. Real-world 10k users on 4G networks: 2.3%. The difference is TCP&#39;s Nagle algorithm and network variance, not your code.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Metrics lie until you understand them</strong>. &quot;CODE_PASTE 31% hit rate&quot; sounds bad. But investigation revealed: CODE_PASTE messages were 25x larger than TEXT, and they triggered 5-8x more backend work. A hit rate of 31% on expensive operations might be more acceptable than 12% on cheap ones. You need to measure resource cost, not just message count.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Rollouts reveal what testing missed</strong>. The Friday canary revealed the baseline. Monday&#39;s 2.1% spike (hitting the global limit) told us the 80k value was optimistic. Without real traffic, you can&#39;t tune effectively.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Tuning isn&#39;t a one-time event</strong>. Two months in, we&#39;re still between 0.9%-2.2% depending on the week. That&#39;s not failure; that&#39;s normal. The policy absorbs user behavior variation and network conditions without catastrophic failures. We adjust the global limit once every 2-3 weeks if we see consistent drift, but the per-user per-type strategy handles most variance automatically.</p></li></ol><p data-v-0f34702c><strong data-v-0f34702c>Current monitoring setup</strong>:</p><ul data-v-0f34702c><li data-v-0f34702c>Alert if &gt;3% of users hit rate limits in an hour (sudden policy drift or attack)</li><li data-v-0f34702c>Track global limit rejection rate separately; if &gt;0.5% of requests hit it, check for DDoS or planned load spike</li><li data-v-0f34702c>Weekly histogram of per-type hit rates; CODE_PASTE at 1-2% is expected, TEXT at &gt;1% means investigation</li><li data-v-0f34702c>Correlate with customer support tickets; if code-heavy teams complain about &quot;lags,&quot; the policy might be too strict</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Lessons learned</strong> (revised after production experience):</p><ol data-v-0f34702c><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Assumptions require validation</strong>. The textbook formula (capacity × refill_rate = recovery_time) is useful for thinking but meaningless without real traffic data. Always A/B test in canary before rolling out.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Cost-based limiting works, but requires measurement</strong>. You can&#39;t eyeball token costs. Measure actual backend latency per operation. CODE_PASTE costing 5 tokens wasn&#39;t a guess; it came from production profiling.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Network jitter is your biggest wildcard</strong>. All your lab testing happens on stable networks. Production users on 4G, airplane WiFi, and congested corporate networks behave differently. Add 20-30% headroom to burst capacity; it&#39;s not a waste, it&#39;s insurance.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Global limits are the safety net you hope never activates</strong>. During normal operation, they shouldn&#39;t be hit. When they are (coordinated spam, load spike), that&#39;s the only thing standing between your backend and meltdown. Don&#39;t skimp on them.</p></li><li data-v-0f34702c><p data-v-0f34702c><strong data-v-0f34702c>Tuning is iterative forever</strong>. There&#39;s no &quot;final policy.&quot; Seasonal patterns (back-to-school, holidays, product launches) mean you&#39;ll adjust limits 4-6 times per year. Build monitoring that makes adjustments quick and low-risk.</p></li></ol><h2 id="implementation-checklist" tabindex="-1" data-v-0f34702c>Implementation Checklist <a class="header-anchor" href="#implementation-checklist" aria-label="Permalink to “Implementation Checklist”" data-v-0f34702c>​</a></h2><ul data-v-0f34702c><li data-v-0f34702c>[ ] Analyze your application&#39;s traffic signature (chat? gaming? streaming?)</li><li data-v-0f34702c>[ ] Define capacity and rate for each message type or operation</li><li data-v-0f34702c>[ ] Document reasoning for chosen numbers (recovery time, user behavior, abuse scenarios)</li><li data-v-0f34702c>[ ] Implement observability: log when limits are hit, by whom, how often</li><li data-v-0f34702c>[ ] Test with synthetic load: simulate network jitter, bursts, and coordinated spam</li><li data-v-0f34702c>[ ] Monitor in production for 2 weeks before declaring success</li><li data-v-0f34702c>[ ] Review every 3 months: are users complaining? Is abuse rising? Adjust as needed.</li><li data-v-0f34702c>[ ] Set up alerts for anomalies (sudden spike in limit hits, unusual patterns)</li><li data-v-0f34702c>[ ] Use separate buckets for different message types (or cost-weight a single bucket)</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Key metrics to track</strong>:</p><div class="language-bash" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>rate_limit_exceeded_total</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (counter)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> down</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> message</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> cohort</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>rate_limit_bucket_tokens</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (gauge)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Distribution</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> remaining</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> tokens</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> rejection</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>rate_limit_check_latency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (histogram)</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  Cost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> checking</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> limits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> (target: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>1ms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>)</span></span></code></pre></div><h2 id="putting-it-into-practice" tabindex="-1" data-v-0f34702c>Putting It Into Practice <a class="header-anchor" href="#putting-it-into-practice" aria-label="Permalink to “Putting It Into Practice”" data-v-0f34702c>​</a></h2><p data-v-0f34702c>Token bucket rate limiting is deceptively simple: add tokens, consume tokens, reject when empty. But designing fair policies that protect your backend without starving users requires understanding the trade-offs between capacity, refill rate, buckets, and costs.</p><h3 id="the-three-phase-deployment-strategy" tabindex="-1" data-v-0f34702c>The Three-Phase Deployment Strategy <a class="header-anchor" href="#the-three-phase-deployment-strategy" aria-label="Permalink to “The Three-Phase Deployment Strategy”" data-v-0f34702c>​</a></h3><p data-v-0f34702c><strong data-v-0f34702c>Phase 1: Design (1-2 weeks)</strong></p><ul data-v-0f34702c><li data-v-0f34702c>Analyze your app&#39;s traffic signature using real production logs</li><li data-v-0f34702c>Calculate baseline rates from P95 user behavior</li><li data-v-0f34702c>Choose strategy: single bucket, per-user per-type, or cost-based</li><li data-v-0f34702c>Build a simple rate limit simulator to test policies without deploying</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Phase 2: Testing (1 week)</strong></p><ul data-v-0f34702c><li data-v-0f34702c>Run load tests at 5x and 10x typical peak load</li><li data-v-0f34702c>Simulate network jitter and packet batching</li><li data-v-0f34702c>Run abuse scenarios: coordinated spam, individual floods, mixed workloads</li><li data-v-0f34702c>Document what settings work and what breaks</li></ul><p data-v-0f34702c><strong data-v-0f34702c>Phase 3: Gradual Rollout (4 weeks)</strong></p><ul data-v-0f34702c><li data-v-0f34702c>Week 1: Deploy to 5% of users (or one region)</li><li data-v-0f34702c>Week 2: Expand to 25% as you build confidence</li><li data-v-0f34702c>Week 3-4: Roll out to 100% with continued monitoring</li><li data-v-0f34702c>Keep tuning decisions lightweight — you can adjust rates without redeploying</li></ul><h3 id="common-implementation-patterns" tabindex="-1" data-v-0f34702c>Common Implementation Patterns <a class="header-anchor" href="#common-implementation-patterns" aria-label="Permalink to “Common Implementation Patterns”" data-v-0f34702c>​</a></h3><p data-v-0f34702c>(Examples use <code data-v-0f34702c>memoryRateLimiter</code> — swap for <code data-v-0f34702c>redisRateLimiter</code> or <code data-v-0f34702c>durableObjectRateLimiter</code> per deployment.)</p><p data-v-0f34702c><strong data-v-0f34702c>Pattern 1: Per-User Limits Only</strong></p><p data-v-0f34702c>Simple, good for early-stage apps. Protects against individual users monopolizing resources but doesn&#39;t prevent coordinated attacks.</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Per-user rate limit</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { rateLimit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/middleware&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { memoryRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> limiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>    tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> {</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> ctx.data?.userId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;anon&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> `user:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  },</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(limiter);</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Pattern 2: Tiered by Message Type</strong></p><p data-v-0f34702c>Better for apps with mixed message costs. Text chat gets higher limits than expensive operations.</p><div class="language-typescript" data-v-0f34702c><button title="Copy Code" class="copy" data-v-0f34702c></button><span class="lang" data-v-0f34702c>typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr" data-v-0f34702c><code data-v-0f34702c><span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Define different limits per operation type</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { rateLimit } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/middleware&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> { memoryRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;@ws-kit/memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>;</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> chatLimiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({ capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> `user:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>?.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;anon&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> uploadLimiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({ capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> `user:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>?.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;anon&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c> searchLimiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c> rateLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>  limiter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>memoryRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>({ capacity: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>, tokensPerSecond: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;" data-v-0f34702c>2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c> }),</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;" data-v-0f34702c>ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c>=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> `user:${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>ctx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c>?.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;" data-v-0f34702c> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;" data-v-0f34702c> &quot;anon&quot;}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>,</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>});</span></span>
<span class="line" data-v-0f34702c></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;" data-v-0f34702c>// Register each limiter with its specific message type</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(ChatSendMessage, chatLimiter);</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(FileUploadMessage, uploadLimiter);</span></span>
<span class="line" data-v-0f34702c><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;" data-v-0f34702c>use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;" data-v-0f34702c>(SearchHistoryMessage, searchLimiter);</span></span></code></pre></div><p data-v-0f34702c><strong data-v-0f34702c>Pattern 3: Cost-Based (Most Sophisticated)</strong></p><p data-v-0f34702c>Single bucket per user, costs scale with operation impact. Best for mature apps where you&#39;ve measured actual costs.</p><p data-v-0f34702c><strong data-v-0f34702c>Selecting Your Pattern:</strong></p><ul data-v-0f34702c><li data-v-0f34702c><strong data-v-0f34702c>Early stage</strong>: Start with Pattern 1 (per-user only)</li><li data-v-0f34702c><strong data-v-0f34702c>Multiple message types</strong>: Graduate to Pattern 2 (per-type limits)</li><li data-v-0f34702c><strong data-v-0f34702c>Mature, complex API</strong>: Pattern 3 (cost-based) provides the most control</li></ul><h3 id="quick-start" tabindex="-1" data-v-0f34702c>Quick Start <a class="header-anchor" href="#quick-start" aria-label="Permalink to “Quick Start”" data-v-0f34702c>​</a></h3><ol data-v-0f34702c><li data-v-0f34702c>Analyze your app&#39;s traffic signature (chat? gaming? streaming?)</li><li data-v-0f34702c>Pick initial capacity and rate from the domain-specific recommendations above</li><li data-v-0f34702c>Choose your strategy: simple per-user, per-type, or cost-based</li><li data-v-0f34702c>Deploy to a small cohort and monitor for 2 weeks</li><li data-v-0f34702c>Tune based on real-world feedback: Are users complaining? Is abuse rising?</li></ol><p data-v-0f34702c>The case study shows that one generic policy rarely survives contact with production. But by reasoning about capacity and refill rate as levers that model your workload, you move from reactive firefighting to proactive, confident tuning.</p><p data-v-0f34702c>Fair rate limiting isn&#39;t about saying &quot;no&quot; more often. It&#39;s about saying &quot;yes&quot; predictably, protecting the system when necessary, and building a platform where both legitimate users and your backend infrastructure can thrive. When done right, users won&#39;t notice the limit is there — they&#39;ll just experience a fast, fair, and stable service.</p><hr data-v-0f34702c><h2 id="further-reading" tabindex="-1" data-v-0f34702c>Further Reading <a class="header-anchor" href="#further-reading" aria-label="Permalink to “Further Reading”" data-v-0f34702c>​</a></h2><ul data-v-0f34702c><li data-v-0f34702c>Token bucket algorithm (<a href="https://en.wikipedia.org/wiki/Token_bucket" target="_blank" rel="noreferrer" data-v-0f34702c>Wikipedia</a>)</li><li data-v-0f34702c>Rate limiting patterns (<a href="https://discord.com/developers/docs/topics/rate-limits" target="_blank" rel="noreferrer" data-v-0f34702c>Discord Developer Docs</a>)</li><li data-v-0f34702c>Cost-based rate limiting (<a href="https://shopify.engineering/rate-limiting-graphql-apis-calculating-query-complexity" target="_blank" rel="noreferrer" data-v-0f34702c>Shopify Engineering</a>)</li><li data-v-0f34702c>Rate limiting in WS-Kit (<a href="./../guides/rate-limiting" data-v-0f34702c>Guide</a>)</li></ul></div></div></main><footer class="VPDocFooter" data-v-4658cce5 data-v-ff5490e8><!--[--><!--]--><div class="edit-info" data-v-ff5490e8><div class="edit-link" data-v-ff5490e8><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/ws-kit/edit/main/docs/posts/[slug].md" target="_blank" rel="noreferrer" data-v-ff5490e8><!--[--><span class="vpi-square-pen edit-link-icon" data-v-ff5490e8></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-ff5490e8><p class="VPLastUpdated" data-v-ff5490e8 data-v-3f9e433e>Last updated: <time datetime="2025-11-06T19:52:34.000Z" data-v-3f9e433e></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-ff5490e8><span class="visually-hidden" id="doc-footer-aria-label" data-v-ff5490e8>Pager</span><div class="pager" data-v-ff5490e8><!----></div><div class="pager" data-v-ff5490e8><a class="VPLink link pager-link next" href="/ws-kit/getting-started" data-v-ff5490e8><!--[--><span class="desc" data-v-ff5490e8>Next page</span><span class="title" data-v-ff5490e8>Getting Started</span><!--]--></a></div></nav></footer><!--[--><!--[--><!--[--><div class="post-author" data-v-7763c96d><div class="author-info" data-v-7763c96d><div class="published-by" data-v-7763c96d> Published by <a href="https://github.com/undefined" target="_blank" rel="noopener noreferrer" class="author-name" data-v-7763c96d></a></div><!----></div><!----></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-7ba21f5d data-v-d0094b0e><div class="container" data-v-d0094b0e><p class="message" data-v-d0094b0e>Released under the <a href="https://github.com/kriasoft/ws-kit/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-d0094b0e>Copyright © 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> · Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"CxLA52tA\",\"adr_001-message-context-conditional-payload-typing.md\":\"B1UsMUlH\",\"adr_002-typed-client-adapters.md\":\"BEro5ZvE\",\"adr_003-example-imports.md\":\"CiIOE54W\",\"adr_005-builder-pattern-and-symbol-escape-hatch.md\":\"DfnE42Yg\",\"adr_006-multi-runtime-serve-with-explicit-selection.md\":\"eXufrgnH\",\"adr_007-export-with-helpers-pattern.md\":\"B512tkid\",\"adr_008-middleware-support.md\":\"B1NjEAtF\",\"adr_009-error-handling-and-lifecycle-hooks.md\":\"BDIkq7Cz\",\"adr_010-throttled-broadcast-pattern.md\":\"CLgAxy99\",\"adr_011-structured-logging-adapter.md\":\"DNdQ4NYh\",\"adr_012-rpc-minimal-reliable.md\":\"BkqlJj-8\",\"adr_013-rpc-reconnect-idempotency.md\":\"biE4rvw2\",\"adr_014-rpc-dx-safety-improvements.md\":\"DAvlOdvd\",\"adr_015-unified-rpc-api-design.md\":\"OHaMmcXb\",\"adr_016-connection-data-api-naming.md\":\"WhLkmLdF\",\"adr_017-message-api-parameter-naming.md\":\"Cxrt79nc\",\"adr_018-broadcast-method-naming.md\":\"CngjIZAS\",\"adr_019-ctx-publish-convenience-method.md\":\"D8PcKRFc\",\"adr_020-send-method-naming.md\":\"DwiogfeG\",\"adr_021-adapter-first-architecture.md\":\"BtQSpnWj\",\"adr_022-namespace-first-pubsub-api.md\":\"B4lmPK1l\",\"adr_023-pubsub-adapter-split.md\":\"VAZQQN-I\",\"adr_023-schema-driven-type-inference.md\":\"Dlowzz-8\",\"adr_024-unified-pubsub-adapter-optional-lifecycle.md\":\"C7LXtULP\",\"adr_025-validator-plugins-configurable.md\":\"D9dXPgQQ\",\"adr_026-internal-router-access-patterns.md\":\"Bv_Waxec\",\"adr_028-plugin-architecture-final-design.md\":\"C_6ufXRD\",\"adr_029-context-enhancer-registry-plugin-safety.md\":\"Bp9sPApx\",\"adr_030-context-methods-design.md\":\"DM7gkS6A\",\"adr_031-plugin-adapter-architecture.md\":\"BIu8lP6y\",\"adr_032-canonical-imports-design.md\":\"7qZQQaup\",\"adr_033-opaque-transport-canonical-connection-data.md\":\"nOdaBdW5\",\"adr_034-bun-upgrade-return-semantics.md\":\"DLSom4mb\",\"adr_035-bun-adapter-refinement.md\":\"Dxn8RvtR\",\"adr_036-unified-error-handling-core-primitive.md\":\"DCbrM-pO\",\"adr_archive_004-typed-router-factory.md\":\"CIxEkBqB\",\"adr_readme.md\":\"ViYle-sA\",\"advanced-usage.md\":\"0VgpfqnV\",\"api-reference.md\":\"C_yqp1rm\",\"bun.md\":\"CJxP2cWP\",\"client-advanced.md\":\"SrYpIZAa\",\"client-api.md\":\"CiJk5rV-\",\"client-auth.md\":\"CdHxbSeP\",\"client-errors.md\":\"DYmmDLbD\",\"client-setup.md\":\"Dlupw3_h\",\"core-concepts.md\":\"B2hKaP2i\",\"deployment.md\":\"tK7xtaSC\",\"eslint-config.md\":\"B-5weKR-\",\"examples.md\":\"BnaaniHS\",\"getting-started.md\":\"DjEiWCTQ\",\"guides_advanced-multi-runtime.md\":\"_pZC3dER\",\"guides_getting-started-composition.md\":\"DAGq5K1x\",\"guides_on-vs-rpc.md\":\"c1axU67t\",\"guides_rate-limiting.md\":\"DW6Cn0oU\",\"guides_readme.md\":\"-3L4O2kZ\",\"guides_rpc-troubleshooting.md\":\"BlE-b15z\",\"guides_rpc.md\":\"Bcb8valx\",\"guides_schema-driven-design.md\":\"ColGgFod\",\"index.md\":\"B_lT8dm2\",\"invariants.md\":\"CS0_RyyM\",\"issues_typecheck.local.md\":\"BYO9g14r\",\"message-schemas.md\":\"CRgK9KJk\",\"middleware.md\":\"C2MS6ZKT\",\"migration_pubsub-adapter-split.md\":\"uqyvwo1u\",\"patterns_composition.md\":\"6dePxggX\",\"patterns_delta-sync.md\":\"Br1wl1g2\",\"patterns_flow-control.md\":\"CXU5y538\",\"patterns_readme.md\":\"DsW2kGW4\",\"patterns_state-channels.md\":\"DCiGkIuT\",\"plugin-author-guide.md\":\"6_3jls5M\",\"posts_building-websocket-router.md\":\"UcUB1O7j\",\"posts_index.md\":\"xnRWV7RT\",\"posts_token-bucket-policies.md\":\"BLw3pXHc\",\"posts_two-timestamps-one-message.md\":\"B1MQcV5W\",\"proposals_plugin-architecture.md\":\"Bo2l_R_m\",\"proposals_problems.local.md\":\"B1HhBxuW\",\"proposals_publish-issues.local.md\":\"By-tss3Y\",\"proposals_pubsub-adapter.md\":\"BjrG_H_e\",\"proposals_rate-limiting.md\":\"CHyIyI6K\",\"proposals_router.md\":\"D7XpzxUh\",\"proposals_rpc.md\":\"BrUhgxVd\",\"specs_adapters.md\":\"RkVdCYMr\",\"specs_canonical-imports.md\":\"f3mj5eaK\",\"specs_client.md\":\"Ds8ZHLNC\",\"specs_context-methods.md\":\"DbPI5hDv\",\"specs_error-handling.md\":\"DhsGXzcD\",\"specs_patterns.md\":\"BJSRmW6P\",\"specs_plugins.md\":\"CCfLqTyh\",\"specs_pubsub.md\":\"rWwyIj_H\",\"specs_readme.md\":\"rIWyUbQG\",\"specs_router.md\":\"4wKt_rz0\",\"specs_rules.md\":\"pbApYNYp\",\"specs_schema.md\":\"Bk4-kS0U\",\"specs_test-requirements.md\":\"D-VfE8Ji\",\"specs_validation.md\":\"YJbCNjgj\",\"valibot-integration.md\":\"aFsPdc3M\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"⚡ WS-Kit\",\"description\":\"Schema-first WebSocket message router for Bun with TypeScript validation\",\"base\":\"/ws-kit/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Docs\",\"link\":\"/getting-started\"},{\"text\":\"Blog\",\"link\":\"/posts/\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/ws-kit/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Manual\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Message Schemas\",\"link\":\"/message-schemas\"},{\"text\":\"API Reference\",\"link\":\"/api-reference\"},{\"text\":\"Examples\",\"link\":\"/examples\"},{\"text\":\"Advanced Usage\",\"link\":\"/advanced-usage\"},{\"text\":\"Deployment\",\"link\":\"/deployment\"}]},{\"text\":\"Guides\",\"items\":[{\"text\":\"Rate Limiting\",\"link\":\"/guides/rate-limiting\"},{\"text\":\"On vs RPC\",\"link\":\"/guides/on-vs-rpc\"},{\"text\":\"RPC Troubleshooting\",\"link\":\"/guides/rpc-troubleshooting\"},{\"text\":\"Advanced Multi-Runtime\",\"link\":\"/guides/advanced-multi-runtime\"}]},{\"text\":\"Client\",\"items\":[{\"text\":\"Setup\",\"link\":\"/client-setup\"},{\"text\":\"API Reference\",\"link\":\"/client-api\"},{\"text\":\"Authentication\",\"link\":\"/client-auth\"},{\"text\":\"Error Handling\",\"link\":\"/client-errors\"},{\"text\":\"Advanced\",\"link\":\"/client-advanced\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/ws-kit/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/ws-kit\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/aW29wXyb7w\"},{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"bluesky\",\"link\":\"https://bsky.app/profile/kriasoft.com\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/ws-kit/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright © 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> · Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>
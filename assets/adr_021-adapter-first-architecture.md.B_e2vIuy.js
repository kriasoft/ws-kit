import{x as i,a,f as e,p as t}from"./chunks/framework.DdttWuXo.js";const c=JSON.parse('{"title":"ADR-021: Adapter-First Architecture for Stateful Features","description":"","frontmatter":{},"headers":[],"relativePath":"adr/021-adapter-first-architecture.md","filePath":"adr/021-adapter-first-architecture.md","lastUpdated":1763159006000}'),n={name:"adr/021-adapter-first-architecture.md"};function r(l,s,p,h,k,d){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="adr-021-adapter-first-architecture-for-stateful-features" tabindex="-1">ADR-021: Adapter-First Architecture for Stateful Features <a class="header-anchor" href="#adr-021-adapter-first-architecture-for-stateful-features" aria-label="Permalink to “ADR-021: Adapter-First Architecture for Stateful Features”">​</a></h1><p><strong>Status</strong>: Proposed <strong>Date</strong>: 2025-11-01 <strong>Related</strong>: ADR-006 (multi-runtime serve), ADR-008 (middleware)</p><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to “Context”">​</a></h2><p>ws-kit must support production deployments across diverse runtimes: single-instance Bun, multi-pod Node.js, Cloudflare Workers/Durable Objects, and edge runtimes. Features requiring shared state (rate limiting, deduplication, presence, sessions) face a fundamental portability challenge:</p><ol><li><strong>Single-instance (Bun)</strong>: In-memory state works fine; no coordination needed</li><li><strong>Multi-pod (Node.js)</strong>: Must coordinate state across pods (Redis, Memcached, etc.)</li><li><strong>Serverless (Cloudflare Workers)</strong>: Isolated execution contexts; need Durable Objects or external KV stores</li><li><strong>Edge runtimes</strong>: Lightweight state access; geographically distributed</li></ol><p>A naive approach—hardcoding Redis or in-memory state—breaks at least one deployment model. A monolithic &quot;choose your backend&quot; library becomes unmaintainable as runtimes proliferate.</p><p><strong>The problem</strong>: How do we ship stateful features that work identically across all runtimes without littering the codebase with backend-specific logic?</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>Establish <strong>adapter-first architecture</strong>: Core packages define lean <strong>adapter interfaces</strong> (contracts); adapters implement those contracts for specific backends. This decouples policy (middleware) from storage/communication (adapters).</p><h3 id="tl-dr" tabindex="-1">TL;DR <a class="header-anchor" href="#tl-dr" aria-label="Permalink to “TL;DR”">​</a></h3><ul><li>✅ Core defines the interface (contract only, no impl)</li><li>✅ Middleware consumes the interface (policy-agnostic)</li><li>✅ Adapters implement the interface (one per backend: memory, Redis, Durable Objects)</li><li>✅ Apps choose adapters based on deployment (single-instance, multi-pod, serverless)</li><li>✅ All adapters pass the same test suite (correctness guarantees)</li></ul><h3 id="core-principle" tabindex="-1">Core Principle <a class="header-anchor" href="#core-principle" aria-label="Permalink to “Core Principle”">​</a></h3><p><strong>One interface, many implementations</strong>:</p><ul><li>Interface lives in <code>@ws-kit/core</code> (or relevant core package)</li><li>Implementations live in <code>@ws-kit/adapters</code> (organized by backend)</li><li>Middleware consumes the interface, never specific adapters</li><li>Apps choose the adapter that fits their deployment</li></ul><h3 id="example-rate-limiting" tabindex="-1">Example: Rate Limiting <a class="header-anchor" href="#example-rate-limiting" aria-label="Permalink to “Example: Rate Limiting”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Interface (core package)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  consume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RateLimitDecision</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Middleware (doesn&#39;t care about backend)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ← Any adapter implementing the interface</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Middleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Adapters (one per backend)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createMemoryBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @ws-kit/adapters/memory</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRedisBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @ws-kit/adapters/redis</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createDurableObjectBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// @ws-kit/adapters/cloudflare</span></span></code></pre></div><h3 id="package-structure" tabindex="-1">Package Structure <a class="header-anchor" href="#package-structure" aria-label="Permalink to “Package Structure”">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>@ws-kit/core</span></span>
<span class="line"><span>├── Adapter interfaces (RateLimitStore, KVStore, PubSub, etc.)</span></span>
<span class="line"><span>└── Router, validators, error handling</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@ws-kit/middleware</span></span>
<span class="line"><span>├── createRateLimiter(store)</span></span>
<span class="line"><span>├── createDeduplicator(store)</span></span>
<span class="line"><span>├── createPresence(pubsub)</span></span>
<span class="line"><span>└── (All middleware agnostic to backend)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@ws-kit/adapters</span></span>
<span class="line"><span>├── memory/        → memoryStore, memoryPubSub (Bun, Node.js dev)</span></span>
<span class="line"><span>├── redis/         → redisStore, redisPubSub (multi-pod production)</span></span>
<span class="line"><span>└── cloudflare/ → durableObjectStore, durableObjectPubSub (Workers)</span></span></code></pre></div><h2 id="design-directives" tabindex="-1">Design Directives <a class="header-anchor" href="#design-directives" aria-label="Permalink to “Design Directives”">​</a></h2><p><strong>DO</strong>:</p><ul><li>✅ Define interfaces in core; implementations in <code>@ws-kit/adapters/*</code></li><li>✅ Make interfaces async-first (support both sync and network backends)</li><li>✅ Design interfaces to be minimal and backend-agnostic</li><li>✅ Require all adapters to pass the same contract test suite</li><li>✅ Use subpath imports (<code>@ws-kit/adapters/redis</code>) to isolate dependencies</li></ul><p><strong>NEVER</strong>:</p><ul><li>❌ Hardcode backend selection (no auto-detection; let apps choose)</li><li>❌ Expose backend-specific operations in the middleware interface</li><li>❌ Create separate packages per adapter (consolidate in <code>@ws-kit/adapters</code>)</li><li>❌ Skip contract tests for new adapters</li><li>❌ Assume a specific storage model (KV, relational, etc.)</li></ul><h2 id="design-constraints" tabindex="-1">Design Constraints <a class="header-anchor" href="#design-constraints" aria-label="Permalink to “Design Constraints”">​</a></h2><h3 id="_1-adapter-interface-design" tabindex="-1">1. Adapter Interface Design <a class="header-anchor" href="#_1-adapter-interface-design" aria-label="Permalink to “1. Adapter Interface Design”">​</a></h3><p>Interfaces must be:</p><ul><li><strong>Async-first</strong> — Support both sync (memory) and async (network) backends</li><li><strong>Minimal</strong> — Only capture the contract, not implementation details</li><li><strong>Backend-agnostic</strong> — Never assume a specific storage model (key-value, relational, etc.)</li></ul><p>Example good interface:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  consume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cost</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RateLimitDecision</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Example bad interface:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ← Assumes key-value model</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ← Exposes impl details; not atomic; adapters must manage policy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-where-adapters-live" tabindex="-1">2. Where Adapters Live <a class="header-anchor" href="#_2-where-adapters-live" aria-label="Permalink to “2. Where Adapters Live”">​</a></h3><ul><li><strong>Core logic</strong> → <code>@ws-kit/core</code> (interfaces only; no impl)</li><li><strong>Cross-runtime adapters</strong> → <code>@ws-kit/adapters</code> (memory, Redis, etc.)</li><li><strong>Runtime-specific helpers</strong> → Runtime packages (e.g., <code>@ws-kit/bun</code>, <code>@ws-kit/cloudflare</code>)</li></ul><p><strong>Not allowed</strong>: Scattered <code>@ws-kit/rate-limit-redis</code>, <code>@ws-kit/rate-limit-memory</code>, etc. (splinters ecosystem).</p><h3 id="_3-adapter-naming" tabindex="-1">3. Adapter Naming <a class="header-anchor" href="#_3-adapter-naming" aria-label="Permalink to “3. Adapter Naming”">​</a></h3><ul><li>Backends: <code>create&lt;Name&gt;Backend()</code> or <code>create&lt;Name&gt;Store()</code> (e.g., <code>createRedisBackend()</code>)</li><li>Convenience wrappers: <code>&lt;name&gt;Store()</code> (e.g., <code>memoryStore()</code> — single policy, common case)</li><li>Implementations live in <code>@ws-kit/adapters/&lt;name&gt;</code></li></ul><h3 id="_4-testing-requirements" tabindex="-1">4. Testing Requirements <a class="header-anchor" href="#_4-testing-requirements" aria-label="Permalink to “4. Testing Requirements”">​</a></h3><p>Every adapter must pass <strong>the same contract test suite</strong> under concurrency:</p><ul><li>Atomicity tests (no race conditions)</li><li>Fairness tests (key isolation)</li><li>Edge-case tests (cost &gt; capacity, clock skew, etc.)</li></ul><p>This ensures any adapter can be swapped in without behavior changes.</p><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to “Consequences”">​</a></h2><h3 id="benefits" tabindex="-1">Benefits <a class="header-anchor" href="#benefits" aria-label="Permalink to “Benefits”">​</a></h3><p>✅ <strong>Portability</strong>: Middleware works identically on Bun, Node.js, Cloudflare, edge runtimes ✅ <strong>Zero coupling</strong>: Middleware never knows which adapter is plugged in ✅ <strong>Scalability</strong>: Apps start with memory adapter, scale to Redis or DO without code changes ✅ <strong>Testability</strong>: Adapters tested in isolation; middleware tested with fake adapter ✅ <strong>Reusability</strong>: Same adapter interface used by rate limiting, deduplication, presence, etc. ✅ <strong>Maintainability</strong>: Centralized adapter implementations, no scattered logic</p><h3 id="trade-offs" tabindex="-1">Trade-offs <a class="header-anchor" href="#trade-offs" aria-label="Permalink to “Trade-offs”">​</a></h3><p>⚠️ <strong>Indirection</strong>: Apps must choose and configure the right adapter (vs. auto-detect) ⚠️ <strong>Interface iteration</strong>: Adding features to adapters requires new interface versions ⚠️ <strong>Dependency overhead</strong>: Even unused adapters are &quot;exposed&quot; in type imports (mitigated by <code>@ws-kit/adapters/*</code> subpath structure) ⚠️ <strong>Coordination burden</strong>: Shared backends (Redis, DO namespace) require careful prefix/shard management by apps</p><h2 id="alternatives-considered" tabindex="-1">Alternatives Considered <a class="header-anchor" href="#alternatives-considered" aria-label="Permalink to “Alternatives Considered”">​</a></h2><h3 id="_1-runtime-auto-detection" tabindex="-1">1. Runtime Auto-Detection <a class="header-anchor" href="#_1-runtime-auto-detection" aria-label="Permalink to “1. Runtime Auto-Detection”">​</a></h3><p>Detect runtime and automatically choose adapter:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> autoDetectRateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bun → memory, Node → Redis?</span></span></code></pre></div><p><strong>Why rejected:</strong></p><ul><li>Implicit behavior is harder to debug</li><li>Apps can&#39;t easily test with non-default adapters</li><li>Clouds providers (Cloudflare) have no obvious &quot;default&quot;</li><li>Encourages assumptions about runtime capabilities</li></ul><h3 id="_2-single-monolithic-package" tabindex="-1">2. Single Monolithic Package <a class="header-anchor" href="#_2-single-monolithic-package" aria-label="Permalink to “2. Single Monolithic Package”">​</a></h3><p>Bundle all adapters in separate packages:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { memoryRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@ws-kit/memory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { redisRateLimiter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@ws-kit/redis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>Why rejected:</strong></p><ul><li>Pulls in all dependencies (Redis client, DO types) even if not used</li><li>Harder to maintain as new adapters/runtimes emerge</li><li>Doesn&#39;t scale to future features (deduplication, presence, etc.)</li><li>Violates Unix philosophy (one package, one concern)</li></ul><h3 id="_3-inheritance-based-adapters" tabindex="-1">3. Inheritance-Based Adapters <a class="header-anchor" href="#_3-inheritance-based-adapters" aria-label="Permalink to “3. Inheritance-Based Adapters”">​</a></h3><p>Use class hierarchy:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">abstract</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">abstract</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> consume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...) }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MemoryRateLimitStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RedisRateLimitStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RateLimitStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><p><strong>Why rejected:</strong></p><ul><li>Creates cognitive overhead (inheritance hierarchy to learn)</li><li>Makes it harder to support multiple implementations (composition wins)</li><li>TypeScript interface inheritance is sufficient and simpler</li></ul><h3 id="_4-adapter-factory-with-magic" tabindex="-1">4. Adapter Factory with Magic <a class="header-anchor" href="#_4-adapter-factory-with-magic" aria-label="Permalink to “4. Adapter Factory with Magic”">​</a></h3><p>Auto-instantiate adapters based on environment variables:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  backendUrl: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REDIS_URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Auto-detects Redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>Why rejected:</strong></p><ul><li>Same problems as runtime auto-detection</li><li>Harder to test (can&#39;t easily swap backends)</li><li>Magic is error-prone (typos in env vars, subtle failures)</li></ul><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to “References”">​</a></h2><ul><li><strong>ADR-006</strong>: Multi-Runtime <code>serve()</code> with Explicit Selection (explicit runtime choice)</li><li><strong>ADR-008</strong>: Middleware Support (middleware pattern that consumes adapters)</li><li><strong>Proposal</strong>: <a href="./../proposals/rate-limiting">Feature Proposal: Built-In Rate Limiting</a> (first use of adapter pattern)</li></ul><h2 id="future-applications" tabindex="-1">Future Applications <a class="header-anchor" href="#future-applications" aria-label="Permalink to “Future Applications”">​</a></h2><p>The adapter pattern is not limited to rate limiting. Same principle applies to:</p><ul><li><strong>Deduplication</strong>: <code>DeduplicationStore</code> (memory, Redis, DO)</li><li><strong>Presence</strong>: <code>PresenceStore</code> (for tracking user activity across connections)</li><li><strong>Sessions</strong>: <code>SessionStore</code> (for connection recovery, state persistence)</li><li><strong>Observability</strong>: <code>MetricsExporter</code> (Prometheus, OTLP, CloudWatch)</li></ul><p>Each feature defines a lean interface, implements adapters for common backends, and leaves app responsibility for choosing. This keeps ws-kit focused while enabling production patterns.</p>`,72)])])}const g=i(n,[["render",r]]);export{c as __pageData,g as default};

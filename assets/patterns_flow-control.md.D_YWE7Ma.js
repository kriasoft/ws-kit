import{_ as c,C as u,c as p,o as r,a2 as a,b as l,j as i,w as t,a as n,G as s,a3 as d}from"./chunks/framework.Wvl1o-t0.js";const S=JSON.parse('{"title":"Flow Control Application Pattern","description":"","frontmatter":{},"headers":[],"relativePath":"patterns/flow-control.md","filePath":"patterns/flow-control.md","lastUpdated":1762079697000}'),m={name:"patterns/flow-control.md"};function f(A,e,h,g,E,q){const o=u("Mermaid");return r(),p("div",null,[e[2]||(e[2]=a('<h1 id="flow-control-application-pattern" tabindex="-1">Flow Control Application Pattern <a class="header-anchor" href="#flow-control-application-pattern" aria-label="Permalink to &quot;Flow Control Application Pattern&quot;">​</a></h1><p>Backpressure strategies (drop-oldest, drop-new, queue) with server retry hints.</p><p><strong>Spec-Version:</strong> 1.0.0 | <strong>Schema:</strong> <code>examples/flow-control/contract.json</code><strong>Fixtures:</strong> <code>examples/flow-control/fixtures/</code> | <strong>Tests:</strong> <code>conformance.test.ts</code><strong>Invariants:</strong> <a href="./../invariants">docs/invariants.md</a></p><h2 id="server-must" tabindex="-1">Server MUST <a class="header-anchor" href="#server-must" aria-label="Permalink to &quot;Server MUST&quot;">​</a></h2><ol><li>Define <code>policy</code> (e.g., &quot;drop-oldest&quot;, &quot;drop-new&quot;, &quot;queue&quot;) at router startup</li><li>For drop policies: on queue overflow, emit <code>RESOURCE_EXHAUSTED</code> error with <code>retryAfterMs</code> hint</li><li>Never drop messages silently (drop policies must emit error); queue policy accumulates without bound</li><li>Track queue depth per client (for monitoring)</li></ol><h2 id="client-must" tabindex="-1">Client MUST <a class="header-anchor" href="#client-must" aria-label="Permalink to &quot;Client MUST&quot;">​</a></h2><ol><li>On receiving <code>RESOURCE_EXHAUSTED</code>, back off by at least <code>retryAfterMs</code></li><li>Do not queue messages if policy is &quot;drop-new&quot;</li><li>For policy &quot;queue&quot;, monitor <code>queueDepth</code> from server signals to gauge backlog</li></ol><h2 id="failure-modes" tabindex="-1">Failure Modes <a class="header-anchor" href="#failure-modes" aria-label="Permalink to &quot;Failure Modes&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Condition</th><th>Error</th><th>Retryable</th><th>Client Action</th></tr></thead><tbody><tr><td>Queue full (drop-oldest)</td><td>RESOURCE_EXHAUSTED</td><td>yes</td><td>back off by <code>retryAfterMs</code></td></tr><tr><td>Queue full (drop-new)</td><td>RESOURCE_EXHAUSTED</td><td>yes</td><td>drop new msg locally, back off</td></tr><tr><td>Queue unbounded (queue)</td><td>(none)</td><td>—</td><td>monitor <code>queueDepth</code> from ACKs or errors on other policies</td></tr></tbody></table><h2 id="timelines" tabindex="-1">Timelines <a class="header-anchor" href="#timelines" aria-label="Permalink to &quot;Timelines&quot;">​</a></h2><p><strong>Drop policy on overflow:</strong></p>',11)),(r(),l(d,null,{default:t(()=>[s(o,{id:"mermaid-125",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Client%0A%20%20%20%20participant%20Server%20as%20Server%20(capacity%3D10)%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%201%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%202%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%203%0A%20%20%20%20Note%20over%20Server%3A%20queue%20fills...%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%2011%0A%20%20%20%20Note%20over%20Server%3A%20queue%20full!%3Cbr%2F%3Eapply%20policy%3Cbr%2F%3Edrop-oldest%3A%20remove%20msg%201%0A%20%20%20%20Server-%3E%3EClient%3A%20RESOURCE_EXHAUSTED%3Cbr%2F%3EretryAfterMs%3D100%0A%20%20%20%20Client-%3E%3EClient%3A%20back%20off%20100ms%2C%20retry%0A"})]),fallback:t(()=>[...e[0]||(e[0]=[n(" Loading... ",-1)])]),_:1})),e[3]||(e[3]=i("p",null,[i("strong",null,"Queue policy (no drop):")],-1)),(r(),l(d,null,{default:t(()=>[s(o,{id:"mermaid-129",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20Client%0A%20%20%20%20participant%20Server%20as%20Server%20(backlog)%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%201%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%202%0A%20%20%20%20Note%20over%20Server%3A%20fast%20sends...%0A%20%20%20%20Client-%3E%3EServer%3A%20msg%2050%0A%20%20%20%20Note%20over%20Server%3A%20queue%3D50%3Cbr%2F%3Eprocessing%20slow%0A%20%20%20%20Server-%3E%3EClient%3A%20DATA_ACK%20(queueDepth%20in%20metadata%20if%20supported)%0A%20%20%20%20Note%20over%20Client%3A%20client%20may%20wait%3Cbr%2F%3Eor%20send%20based%20on%3Cbr%2F%3Eobserved%20queueDepth%0A"})]),fallback:t(()=>[...e[1]||(e[1]=[n(" Loading... ",-1)])]),_:1})),e[4]||(e[4]=a('<h2 id="conformance" tabindex="-1">Conformance <a class="header-anchor" href="#conformance" aria-label="Permalink to &quot;Conformance&quot;">​</a></h2><p><code>examples/flow-control/conformance.test.ts</code> currently verifies:</p><ul><li>Contract and fixture schema versions match</li><li>Fixtures are numbered sequentially</li><li>Fixtures expose the required structural fields (<code>steps</code>, <code>assertions</code>, etc.)</li></ul><p>Fixtures ship at:</p><ol><li><strong>001-drop-oldest</strong> — Queue full, policy=&quot;drop-oldest&quot;, msg 1 discarded, client gets error</li><li><strong>002-drop-new</strong> — Queue full, policy=&quot;drop-new&quot;, new msg dropped, client backs off</li><li><strong>003-queue-unlimited</strong> — policy=&quot;queue&quot;, messages accumulated, no error until recovery</li><li><strong>004-retry-hints</strong> — <code>RESOURCE_EXHAUSTED</code> includes <code>retryAfterMs</code>, client backs off correctly</li></ol><p>See <a href="https://github.com/kriasoft/ws-kit/tree/main/examples/flow-control/fixtures/" target="_blank" rel="noreferrer">examples/flow-control/fixtures/</a> for definitions. Executable replay tests are a future enhancement.</p>',6))])}const b=c(m,[["render",f]]);export{S as __pageData,b as default};

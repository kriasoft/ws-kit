import{x as i,b as a,i as t,p as e}from"./chunks/framework.Dl5MHC_T.js";const g=JSON.parse('{"title":"ADR-030: Context Methods Design","description":"","frontmatter":{},"headers":[],"relativePath":"adr/030-context-methods-design.md","filePath":"adr/030-context-methods-design.md","lastUpdated":1763305236000}'),n={name:"adr/030-context-methods-design.md"};function l(h,s,r,p,k,d){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="adr-030-context-methods-design" tabindex="-1">ADR-030: Context Methods Design <a class="header-anchor" href="#adr-030-context-methods-design" aria-label="Permalink to “ADR-030: Context Methods Design”">​</a></h1><p><strong>Status</strong>: Proposed <strong>Date</strong>: 2025-11-14 <strong>Tags</strong>: [api-design, messaging, async, error-handling, developer-experience]</p><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to “Context”">​</a></h2><p>The router&#39;s context methods (<code>.send()</code>, <code>.reply()</code>, <code>.progress()</code>, <code>.publish()</code>) are core to the handler API. Current design decisions affect:</p><ol><li><strong>Developer Experience</strong> — Should unicast be sync or async by default?</li><li><strong>Composability</strong> — How should errors flow (throws vs events vs results)?</li><li><strong>Performance</strong> — Can we keep simple cases latency-minimal without losing power?</li><li><strong>Safety</strong> — How do we enforce terminal/non-terminal semantics (<code>.reply()</code> vs <code>.progress()</code>)?</li><li><strong>Scalability</strong> — How should distributed pub/sub behave (guaranteed vs eventual)?</li><li><strong>Plugin Architecture</strong> — Which methods require validators or pub/sub plugins?</li></ol><h3 id="problem" tabindex="-1">Problem <a class="header-anchor" href="#problem" aria-label="Permalink to “Problem”">​</a></h3><p>Existing designs create friction:</p><ul><li><strong>All-async</strong> — Developers await everything, even simple sends (noise, latency impact)</li><li><strong>All-sync</strong> — Distributed pub/sub blocks; unscalable</li><li><strong>Throws for I/O</strong> — Handler crashes on connection close; harder to compose</li><li><strong>Silent failures</strong> — No clear error reporting; hard to debug</li><li><strong>Unclear when to use what</strong> — Is <code>.publish()</code> ordered? Do subscribers always get the message?</li><li><strong>No backpressure control</strong> — Can&#39;t wait for buffer drain; can&#39;t observe delivery metrics</li></ul><h3 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to “Requirements”">​</a></h3><ul><li>✅ <strong>Lean handlers</strong> — Typical cases should be simple (no unnecessary awaits)</li><li>✅ <strong>Powerful</strong> — Advanced cases (streaming, backpressure, metrics) must be expressible</li><li>✅ <strong>Safe</strong> — Type system enforces RPC sequencing (no <code>.reply()</code> twice)</li><li>✅ <strong>Observable</strong> — Errors and metrics visible without breaking handler flow</li><li>✅ <strong>Scalable</strong> — Distributed pub/sub must work without I/O blocking</li><li>✅ <strong>Plugin-gated</strong> — Capabilities clearly tied to required plugins</li></ul><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><h3 id="core-philosophy" tabindex="-1">Core Philosophy <a class="header-anchor" href="#core-philosophy" aria-label="Permalink to “Core Philosophy”">​</a></h3><ol><li><strong>Sync-first for unicast</strong> — <code>.send()</code>, <code>.reply()</code>, <code>.error()</code>, <code>.progress()</code> enqueue synchronously (fast, simple)</li><li><strong>Async for broadcast</strong> — <code>.publish()</code> is <code>Promise&lt;PublishResult&gt;</code> (coordination in distributed systems)</li><li><strong>Opt-in async</strong> — Unicast methods accept <code>{waitFor}</code> option for advanced control (backpressure, confirmation)</li><li><strong>No runtime throws</strong> — I/O errors via <code>onError</code> events or result objects; only dev-time throws <ul><li><code>.error()</code> treats application-level errors as structured payloads (not exceptions) to avoid crashing handlers</li></ul></li><li><strong>Plugin gating</strong> — Methods throw upfront (module load) if required plugin missing; runtime behavior then guaranteed</li><li><strong>One-shot RPC semantics</strong> — <code>.reply()</code> and <code>.error()</code> enforce terminal responses via one-shot guard (ADR-012); prevents duplicate or mixed terminals</li></ol><h3 id="method-specifications" tabindex="-1">Method Specifications <a class="header-anchor" href="#method-specifications" aria-label="Permalink to “Method Specifications”">​</a></h3><h4 id="ctx-send-schema-payload-opts-→-void-promise-boolean" tabindex="-1"><code>ctx.send(schema, payload, opts?)</code> → <code>void | Promise&lt;boolean&gt;</code> <a class="header-anchor" href="#ctx-send-schema-payload-opts-→-void-promise-boolean" aria-label="Permalink to “ctx.send(schema, payload, opts?) → void | Promise&lt;boolean&gt;”">​</a></h4><p><strong>Purpose</strong>: Send a one-way message to the current connection (unicast, 1-to-1).</p><p><strong>Signature</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  schema: Schema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  payload: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SendOptions,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boolean</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SendOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waitFor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;drain&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Makes return type Promise&lt;boolean&gt;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Behavior</strong>:</p><ul><li>Enqueues message to WebSocket send buffer immediately (sync)</li><li>Returns <code>void</code> unless <code>waitFor</code> specified</li><li>Connection closed → fires <code>onError</code> event (never throws)</li><li>Invalid payload → throws at dev time (type/validation); never at runtime</li><li>If <code>{waitFor: &#39;drain&#39;}</code>: waits for buffer to drain; returns <code>Promise&lt;boolean&gt;</code></li><li>If <code>{waitFor: &#39;ack&#39;}</code>: waits for server-side acknowledgment; returns <code>Promise&lt;boolean&gt;</code></li></ul><p><strong>Error Modes</strong>:</p><table tabindex="0"><thead><tr><th>Error</th><th>When</th><th>Handling</th></tr></thead><tbody><tr><td>Type mismatch</td><td>Compile time</td><td>TypeScript catches</td></tr><tr><td>Validation fails</td><td>Dev: throws; runtime: never</td><td>Dev fix payload before ship</td></tr><tr><td>Socket closed</td><td>Async (via onError event)</td><td>App logs; doesn&#39;t crash handler</td></tr><tr><td>Backpressure</td><td>Opt-in via waitFor</td><td>Returns false; app decides retry/backoff</td></tr></tbody></table><p><strong>Design Rationale</strong>:</p><ul><li>Sync by default keeps handlers fast and simple</li><li>Opt-in async via <code>{waitFor}</code> unlocks backpressure control without base complexity</li><li><code>onError</code> event ensures network failures don&#39;t crash handlers</li><li>Type safety prevents payload mismatches upfront</li></ul><p><strong>Why Async Backpressure Over Sync Status Codes?</strong></p><p>Alternatives like returning integers (e.g., <code>0=ok, 2=buffer-full</code>) require manual status checks in every call site, adding boilerplate and cognitive load. Instead, <code>await ctx.send(..., {waitFor: &#39;drain&#39;})</code> lets handlers naturally pause on slow clients using idiomatic <code>async/await</code>, yielding the event loop for better concurrency. This design keeps the base API simple (sync by default) while making backpressure composable and opt-in only where critical.</p><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simple: fire-and-forget</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PongMsg, { text: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pong&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Backpressure-sensitive (wait for buffer drain)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LargeMsg, buffer, { waitFor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;drain&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sent) console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;buffer full; client may have disconnected&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Cancellable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().signal;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Msg, data, { signal });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// With metadata</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Msg, payload, { meta: { timestamp: Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() } });</span></span></code></pre></div><hr><h4 id="ctx-reply-payload-opts-→-void-promise-void" tabindex="-1"><code>ctx.reply(payload, opts?)</code> → <code>void | Promise&lt;void&gt;</code> <a class="header-anchor" href="#ctx-reply-payload-opts-→-void-promise-void" aria-label="Permalink to “ctx.reply(payload, opts?) → void | Promise&lt;void&gt;”">​</a></h4><p><strong>Purpose</strong>: Send a terminal response in an RPC handler (unicast, 1-to-1, RPC-only).</p><p><strong>Signature</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  payload: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ReplyOptions,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;void&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReplyOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waitFor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;drain&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Behavior</strong>:</p><ul><li>Terminal: calling <code>.reply()</code> twice throws error (enforced at compile time via type system)</li><li>Sends response to RPC caller; resolves client-side <code>.request()</code> Promise</li><li>If called after <code>.progress()</code>: valid; marks end of streaming</li><li>If called outside <code>.rpc()</code> handler: throws error</li><li>Enqueues immediately (sync); opt-in async via <code>{waitFor}</code></li><li>Socket closed → fires <code>onError</code>; client&#39;s Promise rejects</li></ul><p><strong>Error Modes</strong>:</p><table tabindex="0"><thead><tr><th>Error</th><th>When</th><th>Handling</th></tr></thead><tbody><tr><td>Called outside .rpc()</td><td>Handler call</td><td>Throws: &quot;reply() requires RPC context&quot;</td></tr><tr><td>Called twice</td><td>Handler call</td><td>Ignored by one-shot guard (optional dev-mode log); type system helps prevent at compile time</td></tr><tr><td>Invalid payload</td><td>Compile time</td><td>TypeScript catches schema mismatch</td></tr><tr><td>Socket closed</td><td>Async</td><td>onError event; client rejects</td></tr></tbody></table><p><strong>Design Rationale</strong>:</p><ul><li>Sync by default matches RPC caller expectation (response queued immediately)</li><li>Type system enforces terminal semantics (can&#39;t call twice)</li><li>Opt-in <code>{waitFor}</code> for critical paths where client-side action depends on receipt</li><li>Auto-correlation with request ensures client resolves correctly</li></ul><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simple RPC response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GetUser, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload.id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ id: user.id, name: user.name });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Client side</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GetUser, { id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// With streaming (progress then reply)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(LongOp, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> step</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> steps) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ progress: step });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Terminal marker</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wait for server-side confirmation (rare)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ok&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }, { waitFor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ack&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><hr><h3 id="terminal-semantics-one-shot-reply-guard" tabindex="-1">Terminal Semantics: One-Shot Reply Guard <a class="header-anchor" href="#terminal-semantics-one-shot-reply-guard" aria-label="Permalink to “Terminal Semantics: One-Shot Reply Guard”">​</a></h3><p>To ensure RPC reliability and prevent duplicate responses (e.g., from handler bugs, incomplete error handling, or retries), the router uses per-correlationId state (via RpcManager) to enforce &quot;one-shot&quot; terminals.</p><p><strong>Behavior</strong>:</p><ul><li><strong>First call</strong> to <code>.reply()</code> or <code>.error()</code> is terminal: Sends the response and marks the RPC as complete.</li><li><strong>Subsequent calls</strong> to <code>.reply()</code> or <code>.error()</code>: Ignored (no send); optionally logged in dev mode for debugging.</li><li><strong><code>.progress()</code> before terminal</strong>: Allowed multiple times; all sent (or throttled).</li><li><strong><code>.progress()</code> after terminal</strong>: Ignored; optionally logged in dev mode.</li><li><strong>Type system</strong>: Helps prevent duplicates at compile time where possible (e.g., RpcContext inference).</li></ul><p><strong>Rationale</strong>:</p><ul><li>Suppresses duplicates safely without runtime throws, preserving handler composability.</li><li>Aligns with idempotency (prevents duplicate wire messages), reliability (ADR-012), and incomplete handling patterns.</li><li>Handlers remain robust against edge cases (bugs, incomplete error paths, retries).</li></ul><p><strong>Testing</strong>:</p><p>See <code>packages/core/test/features/rpc-reliability.test.ts</code> for duplicate suppression behavior; <code>rpc-incomplete-warning.test.ts</code> for incomplete handling.</p><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Valid: Progress then terminal</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ step: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Sent ✅</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Duplicate terminal: Ignored (no send, optional dev log)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;oops&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Ignored; dev log: &quot;Duplicate reply for RPC; use .error() for failure&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Post-terminal progress: Ignored (no send, optional dev log)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ step: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Ignored; dev log if enabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Mixed terminals: First wins, second ignored</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;FAILED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Something went wrong&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ result: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ok&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Ignored; only error was sent</span></span></code></pre></div><hr><h4 id="ctx-error-code-message-details-opts-→-void-promise-void" tabindex="-1"><code>ctx.error(code, message, details?, opts?)</code> → <code>void | Promise&lt;void&gt;</code> <a class="header-anchor" href="#ctx-error-code-message-details-opts-→-void-promise-void" aria-label="Permalink to “ctx.error(code, message, details?, opts?) → void | Promise&lt;void&gt;”">​</a></h4><p><strong>Purpose</strong>: Terminal application-level error response for RPC (symmetric to <code>.reply()</code>).</p><p><strong>Signature</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unknown</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  code: string,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Standardized error code (e.g., &quot;NOT_FOUND&quot;, &quot;PERMISSION_DENIED&quot;)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  message: string,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Human-readable error description</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  details</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,                </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Optional structured error details (type-inferred)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ReplyOptions,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Reuse: signal, waitFor, meta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;void&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p><strong>Behavior</strong>:</p><ul><li>Only valid inside <code>.rpc()</code> handlers; throws if called outside (enforced by type system and runtime).</li><li>Terminal: Uses the same one-shot guard as <code>.reply()</code>—first call to either <code>.reply()</code> or <code>.error()</code> marks the RPC as responded; further calls are suppressed (no-ops, logged in dev mode).</li><li>Enqueues immediately (sync); opt-in async via <code>{waitFor}</code>.</li><li>Sends structured <code>RPC_ERROR</code> wire frame per ADR-012: <code>{code, message, details, retryable, retryAfterMs}</code>.</li><li>Connection closed: Fires <code>onError</code> event; client&#39;s RPC Promise rejects with <code>RpcError</code>.</li><li>Never throws for I/O—errors are semantic payloads, not exceptions.</li></ul><p><strong>Error Modes</strong>:</p><table tabindex="0"><thead><tr><th>Error</th><th>Type</th><th>When</th><th>Handling</th></tr></thead><tbody><tr><td>Called outside .rpc()</td><td>Dev</td><td>Handler call</td><td>Throws: &quot;error() requires RPC context&quot;</td></tr><tr><td>Called after .reply()</td><td>Runtime</td><td>Handler call</td><td>Ignored by one-shot guard (optional dev-mode log)</td></tr><tr><td>Called after terminal</td><td>Runtime</td><td>Handler call</td><td>Ignored by one-shot guard (optional dev-mode log); first terminal wins</td></tr><tr><td>Invalid details</td><td>Dev</td><td>Compile time</td><td>TypeScript catches schema mismatch</td></tr><tr><td>Socket closed</td><td>Runtime</td><td>Async</td><td>onError event; client rejects</td></tr></tbody></table><p><strong>Design Rationale</strong>:</p><ul><li>Sync by default keeps error handling simple and symmetric with <code>.reply()</code>.</li><li>One-shot guard (shared with <code>.reply()</code>) prevents duplicate or mixed terminals (success then error, or vice versa).</li><li>Reuse <code>.reply()</code> options for composability; no new surface area.</li><li>Structured <code>RPC_ERROR</code> payload (code, message, details) allows clients to distinguish retryable failures (e.g., &quot;RESOURCE_EXHAUSTED&quot;) from fatal ones (e.g., &quot;NOT_FOUND&quot;).</li><li>Treats errors as payloads (not exceptions) to avoid crashing handlers—aligns with ADR-012 reliability principles.</li></ul><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simple error response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GetUserMsg, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload.id);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;NOT_FOUND&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User not found&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { id: ctx.payload.id });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ id: user.id, name: user.name });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Error with retry hint</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(FetchDataMsg, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> externalApi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload.url);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ data });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err.isRetryable) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // Client-side can retry after backoff</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;TEMPORARY_ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Service temporarily unavailable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        { retryAfterMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PERMANENT_ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid request&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { reason: err.message });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Permission error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(DeleteUserMsg, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.data.roles?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PERMISSION_DENIED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Only admins can delete users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deleteUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload.id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wait for confirmation (rare, like .reply)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(CriticalMsg, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (validation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">failed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;VALIDATION_ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid input&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { errors: [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] }, { waitFor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ ok: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h4 id="ctx-progress-update-opts-→-void-promise-void" tabindex="-1"><code>ctx.progress(update, opts?)</code> → <code>void | Promise&lt;void&gt;</code> <a class="header-anchor" href="#ctx-progress-update-opts-→-void-promise-void" aria-label="Permalink to “ctx.progress(update, opts?) → void | Promise&lt;void&gt;”">​</a></h4><p><strong>Purpose</strong>: Send non-terminal updates in an RPC streaming handler (unicast, 1-to-1, RPC-only).</p><p><strong>Signature</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  update: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ProgressOptions,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;void&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ProgressOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waitFor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;drain&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ack&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  throttleMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Optional rate limiting</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Behavior</strong>:</p><ul><li>Non-terminal: calling multiple times is valid; all sent (or throttled)</li><li>Must precede <code>.reply()</code> in same handler; calling after <code>.reply()</code> throws error</li><li>Enqueues immediately (sync); opt-in async via <code>{waitFor}</code></li><li>Client receives via <code>.onProgress(callback)</code> on the Promise</li><li>If <code>{throttleMs}</code> set: batches rapid updates (e.g., 100ms throttle = max 10/sec)</li><li>Socket closed → fires <code>onError</code>; further calls are no-ops</li></ul><p><strong>Error Modes</strong>:</p><table tabindex="0"><thead><tr><th>Error</th><th>When</th><th>Handling</th></tr></thead><tbody><tr><td>Called outside .rpc()</td><td>Handler call</td><td>Throws: &quot;progress() requires RPC context&quot;</td></tr><tr><td>Called after .reply()</td><td>Handler call</td><td>Ignored by one-shot guard (optional dev-mode log)</td></tr><tr><td>Invalid payload</td><td>Compile time</td><td>TypeScript catches schema mismatch</td></tr><tr><td>Throttle delay</td><td>On opt-in</td><td>Update queued; sent in batch</td></tr></tbody></table><p><strong>Design Rationale</strong>:</p><ul><li>Sync by default keeps streaming handlers simple</li><li>Non-terminal semantics allow multiple calls without error</li><li>Type system enforces ordering (progress before reply)</li><li>Optional throttling reduces network/processing load on rapid updates</li><li>Client-side <code>.onProgress()</code> callback integrates naturally with Promise pattern</li></ul><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Streaming large response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ProcessFile, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> chunks</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.payload.path);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> chunk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunks) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ processed: chunk.bytes, total: chunks.total });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ success: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, itemsProcessed: chunks.count });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Client side</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ProcessFile, { path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/data.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Done:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// .reply</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Connection error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateProgressBar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(update.processed), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// .progress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Throttle rapid updates (10 per second)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> frame</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> animation) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ frameNum: frame }, { throttleMs: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h4 id="ctx-publish-topic-schema-payload-opts-→-promise-publishresult" tabindex="-1"><code>ctx.publish(topic, schema, payload, opts?)</code> → <code>Promise&lt;PublishResult&gt;</code> <a class="header-anchor" href="#ctx-publish-topic-schema-payload-opts-→-promise-publishresult" aria-label="Permalink to “ctx.publish(topic, schema, payload, opts?) → Promise&lt;PublishResult&gt;”">​</a></h4><p><strong>Purpose</strong>: Broadcast a message to all subscribers of a topic (1-to-many, async, requires PubSub plugin).</p><p><strong>Signature</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  topic: string,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  schema: Schema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  payload: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PublishOptions,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">): </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PublishResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PublishResult</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Error code: &#39;INVALID_PAYLOAD&#39;, &#39;ADAPTER_ERROR&#39;, etc.</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  matched</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Approximate subscriber count reached</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  capability</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;local&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;distributed&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;partial&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Delivery guarantee level</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PublishOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  signal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortSignal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  excludeSelf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: false</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  partitionKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// For distributed consistency</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  waitFor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;enqueued&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;settled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: &#39;enqueued&#39;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Behavior</strong>:</p><ul><li>Always async (returns Promise immediately)</li><li>Broadcasts to all subscribers of <code>topic</code> (distributed or local, adapter-dependent)</li><li>Returns structured result; never throws at runtime (throws upfront if plugin missing)</li><li><code>{waitFor: &#39;enqueued&#39;}</code> (default): returns when message enqueued by adapter; fast feedback</li><li><code>{waitFor: &#39;settled&#39;}</code>: returns when message delivered to all subscribers (slower, more certain)</li><li><code>{excludeSelf: true}</code>: skips current connection (common in broadcast scenarios)</li><li><code>{partitionKey}</code>: ensures order within partition for distributed systems (e.g., Redis Streams)</li><li><code>{signal}</code>: aborts if provided AbortController fires before publish starts</li></ul><p><strong>Error Modes</strong>:</p><table tabindex="0"><thead><tr><th>Error</th><th>Result</th></tr></thead><tbody><tr><td>Missing <code>withPubSub()</code> plugin</td><td>Throws upfront: &quot;PubSub plugin required&quot;</td></tr><tr><td>Validation fails</td><td><code>{ok: false, error: &#39;INVALID_PAYLOAD&#39;}</code></td></tr><tr><td>Adapter error</td><td><code>{ok: false, error: &#39;ADAPTER_ERROR&#39;}</code></td></tr><tr><td>No subscribers</td><td><code>{ok: true, matched: 0, capability: &#39;local&#39;}</code></td></tr><tr><td>Successful (local)</td><td><code>{ok: true, matched: N, capability: &#39;local&#39;}</code></td></tr><tr><td>Partial delivery (distributed)</td><td><code>{ok: true, matched: N, capability: &#39;partial&#39;}</code></td></tr></tbody></table><p><strong>Design Rationale</strong>:</p><ul><li>Async by default because distributed coordination can&#39;t be sync</li><li>Structured result allows apps to observe success/failure/metrics without exceptions</li><li><code>waitFor</code> option lets critical paths wait for settlement; typical cases use default (fast)</li><li><code>capability</code> field reports delivery guarantee level (local = definite; distributed = eventual)</li><li><code>partitionKey</code> enables ordering guarantees in distributed setups</li><li>Plugin gating ensures pub/sub is explicitly enabled upfront</li></ul><p><strong>Examples</strong>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Basic broadcast: fire-and-forget</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;users:online&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, UserEvent, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  userId: ctx.data.userId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  action: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;joined&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Reached \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">matched</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} subscribers\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Exclude self (chat pattern: don&#39;t echo back to sender)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;room:123:chat&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ChatMsg, message, { excludeSelf: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Critical path: wait for settlement</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;payments&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, PaymentMsg, txn, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  waitFor: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;settled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  partitionKey: ctx.data.userId, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Ensure order per user</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">res.ok) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ErrorMsg, { reason: res.error });</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Optionally retry or escalate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Cancellable with timeout</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> controller</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AbortController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> timeout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> controller.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">abort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, schema, data, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  signal: controller.signal,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clearTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(timeout);</span></span></code></pre></div><hr><h3 id="decision-matrix" tabindex="-1">Decision Matrix <a class="header-anchor" href="#decision-matrix" aria-label="Permalink to “Decision Matrix”">​</a></h3><p>Quick reference for choosing the right method:</p><table tabindex="0"><thead><tr><th>Aspect</th><th><code>.send()</code></th><th><code>.reply()</code></th><th><code>.error()</code></th><th><code>.progress()</code></th><th><code>.publish()</code></th></tr></thead><tbody><tr><td><strong>Scope</strong></td><td>1-to-1</td><td>1-to-1 RPC</td><td>1-to-1 RPC</td><td>1-to-1 RPC</td><td>1-to-many</td></tr><tr><td><strong>Use When</strong></td><td>Fire-and-forget</td><td>RPC success</td><td>RPC failure (expected)</td><td>Long-running ops</td><td>Broadcast</td></tr><tr><td><strong>Default Async</strong></td><td>No (sync)</td><td>No (sync)</td><td>No (sync)</td><td>No (sync)</td><td>Yes (Promise)</td></tr><tr><td><strong>Opt-in Async</strong></td><td>Yes (<code>{waitFor}</code>)</td><td>Yes (<code>{waitFor}</code>)</td><td>Yes (<code>{waitFor}</code>)</td><td>Yes (<code>{waitFor}</code>)</td><td>N/A</td></tr><tr><td><strong>Terminal</strong></td><td>N/A</td><td>Yes (one-shot)</td><td>Yes (one-shot)</td><td>No (multiple ok)</td><td>N/A</td></tr><tr><td><strong>Plugin Required</strong></td><td>None</td><td>Validator</td><td>Validator</td><td>Validator</td><td>PubSub</td></tr><tr><td><strong>Error Reporting</strong></td><td>onError event</td><td>onError event</td><td>onError event</td><td>onError event</td><td>Result object</td></tr><tr><td><strong>Type Inference</strong></td><td>From schema</td><td>From RPC schema</td><td>From RPC schema</td><td>From RPC schema</td><td>From schema</td></tr><tr><td><strong>Returns</strong></td><td>void</td><td>void</td><td>void</td><td>void</td><td>Promise</td></tr><tr><td><strong>Throw at Runtime</strong></td><td>Never</td><td>Never</td><td>Never</td><td>Never</td><td>Never</td></tr></tbody></table><hr><h3 id="error-handling-philosophy" tabindex="-1">Error Handling Philosophy <a class="header-anchor" href="#error-handling-philosophy" aria-label="Permalink to “Error Handling Philosophy”">​</a></h3><p><strong>Dev-Time Errors (Throws)</strong>:</p><ul><li>Type mismatches (TypeScript compile time)</li><li>Validation failures (dev must fix payload)</li><li>API misuse (e.g., <code>.reply()</code> outside <code>.rpc()</code> context)</li><li>Missing plugin (e.g., <code>.publish()</code> without <code>withPubSub()</code>)</li></ul><p><strong>Runtime Errors (No Throw)</strong>:</p><ul><li>Connection closed (via <code>onError</code> event)</li><li>Adapter failure (via result object for publish; onError for unicast)</li><li>Backpressure (opt-in <code>{waitFor}</code> return value or onError)</li></ul><p><strong>Rationale</strong>: Handlers should never crash due to I/O or network failures. Events and result objects keep handler flow composable and observable.</p><p>For detailed error catalogs by method, see <a href="./../specs/context-methods#error-handling">docs/specs/context-methods.md#Error-Handling</a>.</p><p><strong>Rule of Thumb: Mutations Throw, Actions Return</strong></p><p>This aligns with the pub/sub spec (docs/specs/pubsub.md): state-changing mutations (e.g., <code>ctx.topics.subscribe()</code>) throw on failures like invalid topics or ACL denials for fail-fast safety. The context methods here (<code>ctx.send()</code>, <code>ctx.reply()</code>, <code>ctx.progress()</code>, <code>ctx.publish()</code>) are action-oriented and never throw at runtime for I/O or transient issues—they use <code>onError</code> events (unicast) or structured results like <code>PublishResult</code> (broadcast) for graceful, observable handling.</p><hr><h3 id="why-this-design" tabindex="-1">Why This Design <a class="header-anchor" href="#why-this-design" aria-label="Permalink to “Why This Design”">​</a></h3><h4 id="sync-first-for-unicast" tabindex="-1">Sync-First for Unicast <a class="header-anchor" href="#sync-first-for-unicast" aria-label="Permalink to “Sync-First for Unicast”">​</a></h4><table tabindex="0"><thead><tr><th>Alternative</th><th>Tradeoff</th></tr></thead><tbody><tr><td>All async</td><td>Simpler mental model; but adds noise (await everywhere) and latency for simple sends</td></tr><tr><td>All sync</td><td>Can&#39;t do distributed pub/sub; blocks on I/O</td></tr><tr><td><strong>Sync + opt-in async</strong></td><td>✅ Minimal boilerplate for 90% of cases; power available when needed</td></tr></tbody></table><h4 id="async-for-broadcast" tabindex="-1">Async for Broadcast <a class="header-anchor" href="#async-for-broadcast" aria-label="Permalink to “Async for Broadcast”">​</a></h4><table tabindex="0"><thead><tr><th>Alternative</th><th>Tradeoff</th></tr></thead><tbody><tr><td>Sync publish</td><td>Blocks entire handler on distributed I/O; unscalable</td></tr><tr><td>Fire-and-forget (no return)</td><td>Can&#39;t observe success/failure/metrics</td></tr><tr><td><strong><code>Promise&lt;PublishResult&gt;</code></strong></td><td>✅ Non-blocking; apps can opt to await or fire-and-forget</td></tr></tbody></table><h4 id="no-runtime-throws" tabindex="-1">No Runtime Throws <a class="header-anchor" href="#no-runtime-throws" aria-label="Permalink to “No Runtime Throws”">​</a></h4><table tabindex="0"><thead><tr><th>Alternative</th><th>Tradeoff</th></tr></thead><tbody><tr><td>Throws on I/O failure</td><td>Crashes handler; hard to recover or compose</td></tr><tr><td>Silent failures</td><td>No visibility; hard to debug</td></tr><tr><td><strong>Events + results</strong></td><td>✅ Observable, composable, debuggable; handler flow preserved</td></tr></tbody></table><h4 id="plugin-gating" tabindex="-1">Plugin Gating <a class="header-anchor" href="#plugin-gating" aria-label="Permalink to “Plugin Gating”">​</a></h4><table tabindex="0"><thead><tr><th>Alternative</th><th>Tradeoff</th></tr></thead><tbody><tr><td>No gating (all methods always available)</td><td>Runtime errors if plugin missing; confusing</td></tr><tr><td>Runtime checks (hasCapability)</td><td>Verbose; requires if-guards in handlers</td></tr><tr><td><strong>Throw upfront if plugin missing</strong></td><td>✅ Clear error at startup; guaranteed availability in handlers</td></tr></tbody></table><hr><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to “Consequences”">​</a></h2><h3 id="positive" tabindex="-1">Positive <a class="header-anchor" href="#positive" aria-label="Permalink to “Positive”">​</a></h3><ul><li>✅ <strong>Simple handlers</strong>: Minimal noise; typical cases are <code>ctx.send(schema, data)</code> with no await</li><li>✅ <strong>Powerful composability</strong>: Opt-in async (<code>{waitFor}</code>) unlocks backpressure, metrics, confirmation without complicating base API</li><li>✅ <strong>Safe by default</strong>: Type system enforces RPC sequencing; no duplicate <code>.reply()</code> calls</li><li>✅ <strong>Observable</strong>: Errors and metrics visible through events/results; handler flow never interrupted</li><li>✅ <strong>Testable</strong>: Sync methods are easy to mock; async results are inspectable</li><li>✅ <strong>Scalable</strong>: Async pub/sub doesn&#39;t block; distributed systems can coordinate via result.capability</li></ul><h3 id="negative" tabindex="-1">Negative <a class="header-anchor" href="#negative" aria-label="Permalink to “Negative”">​</a></h3><ul><li><strong>Learning curve</strong>: Developers must understand sync vs async distinction; mitigate with examples and docs</li><li><strong>Eventual consistency</strong>: Distributed pub/sub results are eventually consistent; mitigate with <code>partitionKey</code> and <code>waitFor: &#39;settled&#39;</code></li><li><strong>Opt-in async complexity</strong>: <code>{waitFor}</code> adds surface area; most users won&#39;t need it</li></ul><h3 id="risks" tabindex="-1">Risks <a class="header-anchor" href="#risks" aria-label="Permalink to “Risks”">​</a></h3><ul><li><strong>Silent backpressure</strong>: If developer ignores <code>waitFor</code>, high-throughput handlers may lose messages; mitigate with monitoring and docs</li><li><strong>Distributed race conditions</strong>: Pub/sub can have partial delivery or ordering issues; mitigate with adapter guarantees and <code>partitionKey</code></li></ul><h3 id="event-correlation-helper-preservecorrelation-true-option" tabindex="-1">Event Correlation Helper: <code>{preserveCorrelation: true}</code> Option <a class="header-anchor" href="#event-correlation-helper-preservecorrelation-true-option" aria-label="Permalink to “Event Correlation Helper: {preserveCorrelation: true} Option”">​</a></h3><p><strong>Rationale</strong>: Event handlers sometimes need to respond with acknowledgments for correlated messages (e.g., optional acks for tracing/observability). The RPC design (ADR-015) auto-preserves <code>correlationId</code> in <code>.reply()</code> and <code>.progress()</code> via <code>baseMeta()</code>, but event handlers (<code>.send()</code>) lack this convenience. The <code>{preserveCorrelation: true}</code> option on <code>SendOptions</code> fills this gap without introducing RPC semantics.</p><p><strong>Design</strong>: Lightweight opt-in flag that auto-copies <code>ctx.meta.correlationId</code> to outgoing meta if present. Graceful no-op if no correlation ID (silent, not an error). Fully composable with other options (<code>meta</code>, <code>waitFor</code>, <code>signal</code>).</p><p><strong>Use Cases</strong>:</p><ul><li>Acknowledging fire-and-forget events that request optional acks</li><li>Tracing/observability: client includes correlationId, server echoes it back</li><li>Best-effort round-trips: no guarantee client receives ack, unlike RPC (which uses one-shot guard)</li></ul><p><strong>Benefits</strong>:</p><ul><li>✅ <strong>Zero API bloat</strong>: Adds single boolean option, not a new method</li><li>✅ <strong>Composable</strong>: Works with <code>meta</code>, <code>waitFor</code>, <code>signal</code> without forcing manual copy</li><li>✅ <strong>Respects event/RPC boundary</strong>: No new semantics, purely convenience for correlation preservation</li><li>✅ <strong>Low implementation cost</strong>: ~20 LOC in plugin, reuses <code>.send()</code> validation chain</li><li>✅ <strong>Easy deprecation</strong>: If unused, can mark deprecated and retire in next major version</li><li>✅ <strong>Self-documenting</strong>: Name clearly indicates &quot;preserve the correlation ID from request&quot;</li></ul><p><strong>When NOT to Use</strong>: If you need guaranteed request-response semantics, use <code>router.rpc()</code> and <code>ctx.reply()</code> (provides one-shot guard, deadlines, client-side integration).</p><hr><h2 id="alternatives-considered" tabindex="-1">Alternatives Considered <a class="header-anchor" href="#alternatives-considered" aria-label="Permalink to “Alternatives Considered”">​</a></h2><h3 id="_1-all-async-everything-returns-promise" tabindex="-1">1. All Async (Everything Returns Promise) <a class="header-anchor" href="#_1-all-async-everything-returns-promise" aria-label="Permalink to “1. All Async (Everything Returns Promise)”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema, payload)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payload)         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → Promise&lt;void&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → Promise&lt;PublishResult&gt;</span></span></code></pre></div><p><strong>Pros</strong>: Single mental model (always await); eliminates return-type overloading complexity at compile-time <strong>Cons</strong>:</p><ul><li>Noise for 90% of unicast cases (fire-and-forget doesn&#39;t need confirmation)</li><li>Unnecessary Promise allocations for zero-async-work sends</li><li>Return-type overloading trade-off: Current design trades the cognitive load of overloading for minimal boilerplate in the happy path. If metrics show developers find overloading more confusing than <code>await</code> noise, this should be revisited (see Future Considerations).</li><li>Latency penalty from awaiting sends that complete synchronously <strong>Rejected</strong>: Overkill for unicast; type safety via schema-driven inference mitigates overloading confusion in practice</li></ul><h3 id="_2-all-sync-everything-returns-void" tabindex="-1">2. All Sync (Everything Returns void) <a class="header-anchor" href="#_2-all-sync-everything-returns-void" aria-label="Permalink to “2. All Sync (Everything Returns void)”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → void (no observability)</span></span></code></pre></div><p><strong>Pros</strong>: Simplicity; no awaits <strong>Cons</strong>: Can&#39;t do distributed pub/sub; blocks on I/O; no metrics or error feedback <strong>Rejected</strong>: Unscalable for broadcast</p><h3 id="_3-throws-for-runtime-errors" tabindex="-1">3. Throws for Runtime Errors <a class="header-anchor" href="#_3-throws-for-runtime-errors" aria-label="Permalink to “3. Throws for Runtime Errors”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema, data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Handle connection closed, backpressure, etc.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Pros</strong>: Familiar error handling pattern <strong>Cons</strong>: Breaks handler flow; exception-based control is error-prone; handlers crash on I/O <strong>Rejected</strong>: Not composable; violates principle that I/O failures shouldn&#39;t crash handler</p><h3 id="_4-no-opt-in-async-no-waitfor-option" tabindex="-1">4. No Opt-In Async (No <code>{waitFor}</code> option) <a class="header-anchor" href="#_4-no-opt-in-async-no-waitfor-option" aria-label="Permalink to “4. No Opt-In Async (No {waitFor} option)”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema, data); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Always void; no way to wait for drain</span></span></code></pre></div><p><strong>Pros</strong>: Simpler API <strong>Cons</strong>: Can&#39;t handle backpressure; no way to observe delivery in critical paths <strong>Rejected</strong>: Loses power; forces wrappers for advanced cases</p><h3 id="_5-always-use-result-objects" tabindex="-1">5. Always Use Result Objects <a class="header-anchor" href="#_5-always-use-result-objects" aria-label="Permalink to “5. Always Use Result Objects”">​</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema, data); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// → {ok: boolean, error?: string}</span></span></code></pre></div><p><strong>Pros</strong>: Consistent error handling <strong>Cons</strong>: Every send requires null-check; noisy; most sends succeed (result checking is waste) <strong>Rejected</strong>: Terrible DX for happy path</p><hr><h2 id="implementation-notes" tabindex="-1">Implementation Notes <a class="header-anchor" href="#implementation-notes" aria-label="Permalink to “Implementation Notes”">​</a></h2><h3 id="plugin-gating-1" tabindex="-1">Plugin Gating <a class="header-anchor" href="#plugin-gating-1" aria-label="Permalink to “Plugin Gating”">​</a></h3><p>Each method checks for required plugin at module load:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In @ws-kit/core/src/handler/context.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HandlerContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Always available; no check needed</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ws.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  reply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.router.pluginHost.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasCapability</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;validator&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;reply() requires validation plugin (withZod/withValibot)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.router.pluginHost.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasCapability</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;validator&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;progress() requires validation plugin&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">opts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.router.pluginHost.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasCapability</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pubsub&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;publish() requires pubsub plugin (withPubSub)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This fail-fast approach at module load ensures missing plugins are caught during startup (e.g., tests or boot), guaranteeing method availability in handlers without runtime guards or fallbacks.</p><h3 id="type-level-rpc-enforcement" tabindex="-1">Type-Level RPC Enforcement <a class="header-anchor" href="#type-level-rpc-enforcement" aria-label="Permalink to “Type-Level RPC Enforcement”">​</a></h3><p><code>.reply()</code> and <code>.progress()</code> are only typed when inside <code>.rpc()</code> handler. Attempting them in <code>.on()</code> fails at compile time.</p><h3 id="optional-metadata" tabindex="-1">Optional Metadata <a class="header-anchor" href="#optional-metadata" aria-label="Permalink to “Optional Metadata”">​</a></h3><p>All methods accept <code>meta</code> for tracing, correlation, and custom context:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Msg, data, { meta: { traceId: req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;x-trace-id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) } });</span></span></code></pre></div><h3 id="validation" tabindex="-1">Validation <a class="header-anchor" href="#validation" aria-label="Permalink to “Validation”">​</a></h3><p>All methods validate payloads at dev time (compile-time types + runtime validation plugin). Never at runtime (throws only in dev).</p><hr><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to “References”">​</a></h2><ul><li><strong>ADR-015</strong>: RPC API design (rationale for <code>.reply()</code> vs <code>.send()</code>)</li><li><strong>ADR-014</strong>: RPC client-side design (<code>.request()</code> pattern)</li><li><strong>ADR-020</strong>: Method naming (send vs publish rationale)</li><li><strong>ADR-028</strong>: Plugin architecture (capability gating)</li><li><strong>docs/specs/context-methods.md</strong>: Full implementation specification</li><li><strong>docs/specs/error-handling.md</strong>: Error codes and patterns</li><li><strong>docs/specs/pubsub.md</strong>: Pub/sub guarantees and patterns</li><li><strong>docs/specs/router.md</strong>: Handler registration and middleware</li></ul><hr><h2 id="future-considerations" tabindex="-1">Future Considerations <a class="header-anchor" href="#future-considerations" aria-label="Permalink to “Future Considerations”">​</a></h2><ol><li><p><strong>Backpressure Middleware</strong>: Framework-level rate limiting based on socket buffer state</p></li><li><p><strong>Correlation IDs</strong>: Auto-injection of tracing IDs into meta</p></li><li><p><strong>Metrics</strong>: Built-in observability for send/reply/publish counts and latencies</p></li><li><p><strong>Batch Publishing</strong>: <code>ctx.publishBatch(topic, messages)</code> for efficiency</p></li><li><p><strong>Partial Replay</strong>: Resuming failed publishes after handler restarts</p></li><li><p><strong>Response Caching</strong>: Optional caching of RPC responses for deduplication</p></li><li><p><strong>Revisit &quot;Always Async&quot; for Unicast</strong>: Monitor real-world usage and adopter feedback. If return-type overloading (<code>void | Promise&lt;boolean&gt;</code>) proves more confusing than the <code>await</code> noise it eliminates, consider shifting unicast methods to always-async. Triggers for reconsideration:</p><ul><li>User error reports about forgetting <code>await</code> on <code>{waitFor}</code> in async contexts</li><li>Type confusion in IDE tooltips or type checking</li><li>Patterns emerging where sync-first introduces subtle bugs</li></ul><p>Data to collect: % of <code>{waitFor}</code> usage, handler complexity metrics from tests/examples, feedback from adopter projects. No change without evidence—current design is pragmatic and well-reasoned.</p></li></ol><p>These are future enhancements; the current design is sufficient for production use.</p>`,169)])])}const c=i(n,[["render",l]]);export{g as __pageData,c as default};

import{x as t,b as s,i,p as a}from"./chunks/framework.Dl5MHC_T.js";const u=JSON.parse('{"title":"Flow Control Application Pattern","description":"","frontmatter":{},"headers":[],"relativePath":"patterns/flow-control.md","filePath":"patterns/flow-control.md","lastUpdated":1764548345000}'),r={name:"patterns/flow-control.md"};function n(l,e,o,d,p,c){return i(),s("div",null,[...e[0]||(e[0]=[a(`<h1 id="flow-control-application-pattern" tabindex="-1">Flow Control Application Pattern <a class="header-anchor" href="#flow-control-application-pattern" aria-label="Permalink to “Flow Control Application Pattern”">​</a></h1><p>Backpressure strategies (drop-oldest, drop-new, queue) with server retry hints.</p><p><strong>Spec-Version:</strong> 1.0.0 | <strong>Schema:</strong> <code>examples/flow-control/contract.json</code><strong>Fixtures:</strong> <code>examples/flow-control/fixtures/</code> | <strong>Tests:</strong> <code>conformance.test.ts</code><strong>Invariants:</strong> <a href="./../invariants">docs/invariants.md</a></p><h2 id="server-must" tabindex="-1">Server MUST <a class="header-anchor" href="#server-must" aria-label="Permalink to “Server MUST”">​</a></h2><ol><li>Define <code>policy</code> (e.g., &quot;drop-oldest&quot;, &quot;drop-new&quot;, &quot;queue&quot;) at router startup</li><li>For drop policies: on queue overflow, emit <code>RESOURCE_EXHAUSTED</code> error with <code>retryAfterMs</code> hint</li><li>Never drop messages silently (drop policies must emit error); queue policy accumulates without bound</li><li>Track queue depth per client (for monitoring)</li><li>Send <code>DATA_ACK</code> on successful message receipt (contains message <code>id</code> for correlation)</li></ol><h2 id="client-must" tabindex="-1">Client MUST <a class="header-anchor" href="#client-must" aria-label="Permalink to “Client MUST”">​</a></h2><ol><li>On receiving <code>RESOURCE_EXHAUSTED</code>, back off by at least <code>retryAfterMs</code></li><li>Do not queue messages if policy is &quot;drop-new&quot;</li><li>For policy &quot;queue&quot;, monitor <code>queueDepth</code> from server signals to gauge backlog</li></ol><h2 id="message-types" tabindex="-1">Message Types <a class="header-anchor" href="#message-types" aria-label="Permalink to “Message Types”">​</a></h2><table tabindex="0"><thead><tr><th>Message</th><th>Direction</th><th>Purpose</th></tr></thead><tbody><tr><td><code>SEND_DATA</code></td><td>Client → Server</td><td>Client sends data payload</td></tr><tr><td><code>DATA_ACK</code></td><td>Server → Client</td><td>Server acknowledges successful receipt (includes message id)</td></tr><tr><td><code>RESOURCE_EXHAUSTED</code></td><td>Server → Client</td><td>Queue overflow error with retry hint</td></tr></tbody></table><h2 id="failure-modes" tabindex="-1">Failure Modes <a class="header-anchor" href="#failure-modes" aria-label="Permalink to “Failure Modes”">​</a></h2><table tabindex="0"><thead><tr><th>Condition</th><th>Error</th><th>Retryable</th><th>Client Action</th></tr></thead><tbody><tr><td>Queue full (drop-oldest)</td><td>RESOURCE_EXHAUSTED</td><td>yes</td><td>back off by <code>retryAfterMs</code></td></tr><tr><td>Queue full (drop-new)</td><td>RESOURCE_EXHAUSTED</td><td>yes</td><td>drop new msg locally, back off</td></tr><tr><td>Queue unbounded (queue)</td><td>(none)</td><td>—</td><td>monitor <code>queueDepth</code> from ACKs or errors on other policies</td></tr></tbody></table><h2 id="timelines" tabindex="-1">Timelines <a class="header-anchor" href="#timelines" aria-label="Permalink to “Timelines”">​</a></h2><p><strong>Drop policy on overflow:</strong></p><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as Server (capacity=10)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Server: queue fills...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 11</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Server: queue full!&lt;br/&gt;apply policy&lt;br/&gt;drop-oldest: remove msg 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Client: RESOURCE_EXHAUSTED&lt;br/&gt;retryAfterMs=100</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Client: back off 100ms, retry</span></span></code></pre></div><p><strong>Queue policy (no drop):</strong></p><div class="language-mermaid"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    participant Server as Server (backlog)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Server: fast sends...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Client-&gt;&gt;Server: msg 50</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Server: queue=50&lt;br/&gt;processing slow</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Server-&gt;&gt;Client: DATA_ACK (queueDepth in metadata if supported)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Note over Client: client may wait&lt;br/&gt;or send based on&lt;br/&gt;observed queueDepth</span></span></code></pre></div><h2 id="conformance" tabindex="-1">Conformance <a class="header-anchor" href="#conformance" aria-label="Permalink to “Conformance”">​</a></h2><p><code>examples/flow-control/conformance.test.ts</code> currently verifies:</p><ul><li>Contract and fixture schema versions match</li><li>Fixtures are numbered sequentially</li><li>Fixtures expose the required structural fields (<code>steps</code>, <code>assertions</code>, etc.)</li></ul><p>Fixtures ship at:</p><ol><li><strong>001-drop-oldest</strong> — Queue full, policy=&quot;drop-oldest&quot;, msg 1 discarded, client gets error</li><li><strong>002-drop-new</strong> — Queue full, policy=&quot;drop-new&quot;, new msg dropped, client backs off</li><li><strong>003-queue-unlimited</strong> — policy=&quot;queue&quot;, messages accumulated, no error until recovery</li><li><strong>004-retry-hints</strong> — <code>RESOURCE_EXHAUSTED</code> includes <code>retryAfterMs</code>, client backs off correctly</li></ol><p>See <a href="https://github.com/kriasoft/ws-kit/tree/main/examples/flow-control/fixtures/" target="_blank" rel="noreferrer">examples/flow-control/fixtures/</a> for definitions. Executable replay tests are a future enhancement.</p>`,22)])])}const g=t(r,[["render",n]]);export{u as __pageData,g as default};

import{x as i,b as a,i as t,p as e}from"./chunks/framework.Dl5MHC_T.js";const k=JSON.parse('{"title":"ADR-022: Namespace-First Pub/Sub API with ReadonlySet State","description":"","frontmatter":{},"headers":[],"relativePath":"adr/022-namespace-first-pubsub-api.md","filePath":"adr/022-namespace-first-pubsub-api.md","lastUpdated":1762986796000}'),n={name:"adr/022-namespace-first-pubsub-api.md"};function l(r,s,o,p,h,c){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="adr-022-namespace-first-pub-sub-api-with-readonlyset-state" tabindex="-1">ADR-022: Namespace-First Pub/Sub API with ReadonlySet State <a class="header-anchor" href="#adr-022-namespace-first-pub-sub-api-with-readonlyset-state" aria-label="Permalink to ‚ÄúADR-022: Namespace-First Pub/Sub API with ReadonlySet State‚Äù">‚Äã</a></h1><p><strong>Status</strong>: Accepted <strong>Date</strong>: 2025-11-09 <strong>Tags</strong>: pub/sub, api-design, state-management</p><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to ‚ÄúContext‚Äù">‚Äã</a></h2><p>WS-Kit needed a pub/sub API that is:</p><ol><li><strong>Portable</strong> across adapters (Bun native, Node/uWS polyfill, Cloudflare DO, etc.)</li><li><strong>Type-safe</strong> (consistent with WS-Kit&#39;s philosophy of compile-time guarantees)</li><li><strong>Ergonomic</strong> (minimal ceremony, intuitive semantics)</li><li><strong>Extensible</strong> (room for patterns, presence, multi-process adapters)</li></ol><h3 id="prior-design-issues" tabindex="-1">Prior Design Issues <a class="header-anchor" href="#prior-design-issues" aria-label="Permalink to ‚ÄúPrior Design Issues‚Äù">‚Äã</a></h3><p>The initial draft spec (<code>docs/specs/pubsub.md</code> v1) had several problems:</p><ol><li><strong>Namespace confusion</strong> ‚Äî <code>ctx.pubsub.subscribe()</code> with nested <code>ctx.pubsub.subscriptions.list()</code> felt awkward and incoherent</li><li><strong>Boolean return semantics</strong> ‚Äî <code>Promise&lt;boolean&gt;</code> on idempotent operations was anti-idiomatic. Returns <code>false</code> on duplicate subscribe created ambiguity: &quot;what does false mean? Error? Already subscribed? Both?&quot;</li><li><strong>No batch operations</strong> ‚Äî Required O(n) awaits for room join patterns. Partial failure possible (topics 1-5 succeed, 6 fails, inconsistent state)</li><li><strong>Zero type safety</strong> ‚Äî Topics were opaque strings. No schema validation, no compile-time safety (vs message routing which is fully typed)</li><li><strong>Heavy middleware</strong> ‚Äî Proposed middleware pattern felt over-engineered for common case</li><li><strong>Unclear authorization timing</strong> ‚Äî When do hooks run relative to idempotency checks?</li><li><strong>Subscribe/unsubscribe asymmetry unclear</strong> ‚Äî State mutation (subscribe) vs transient action (publish) conflated in same namespace</li></ol><h3 id="design-space-explored" tabindex="-1">Design Space Explored <a class="header-anchor" href="#design-space-explored" aria-label="Permalink to ‚ÄúDesign Space Explored‚Äù">‚Äã</a></h3><p>We evaluated 9+ architectural approaches (documented in detailed analysis), including:</p><ul><li>Flat methods (<code>ctx.subscribe()</code> - deprecated in favor of namespaced approach)</li><li>Fluent chains (<code>ctx.topics.subscribe().with().commit()</code>)</li><li>Heavy router registration (like <code>.on()</code> and <code>.rpc()</code>)</li><li>Boolean returns vs void</li><li>Custom <code>subscriptions</code> interface vs native Set</li><li><code>subscriberCount()</code> API vs capability hints</li><li>Mandatory typed topics vs optional</li><li>Complex middleware vs lightweight hooks</li></ul><p><strong>Key constraint</strong>: Must feel idiomatic in modern JavaScript/TypeScript, align with WS-Kit&#39;s existing patterns (message routing, validator adapters), and leave room for future extensions (patterns, presence, Redis adapter).</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to ‚ÄúDecision‚Äù">‚Äã</a></h2><blockquote><p><strong>üéØ Rule of Thumb: Mutations throw; actions return.</strong></p><p>State changes (subscribe/unsubscribe) signal errors via exceptions. Transient operations (publish) return results for pattern matching on remediation. Single rule, easy to remember.</p></blockquote><h3 id="canonical-references" tabindex="-1">Canonical References <a class="header-anchor" href="#canonical-references" aria-label="Permalink to ‚ÄúCanonical References‚Äù">‚Äã</a></h3><p>For the <strong>authoritative API surface and implementation invariants</strong>, see <a href="./../specs/pubsub"><code>docs/specs/pubsub.md</code></a>:</p><ul><li><strong>Sections 1-10</strong>: API surface, semantics, examples, invariants (normative)</li><li><strong>Section 11</strong>: Implementation invariants for adapter authors (canonical)</li><li><strong>Sections 12-15</strong>: Adapter compliance, concurrency, future extensions</li></ul><p>This ADR provides the <strong>design rationale</strong> behind these decisions (why we chose this approach).</p><hr><h3 id="_1-namespace-ctx-topics-state-flat-ctx-publish-action" tabindex="-1">1. Namespace: <code>ctx.topics</code> (State) + Flat <code>ctx.publish()</code> (Action) <a class="header-anchor" href="#_1-namespace-ctx-topics-state-flat-ctx-publish-action" aria-label="Permalink to ‚Äú1. Namespace: ctx.topics (State) + Flat ctx.publish() (Action)‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// State mutation: isolated in namespace</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribeMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.topics]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Iterable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Action: flat, asymmetry intentional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, schema, payload);</span></span></code></pre></div><p><strong>Why this split:</strong></p><ul><li><strong>Conceptual clarity</strong>: Subscribe = state change (persistent, tracked), Publish = transient action (fire-and-forget broadcast)</li><li><strong>Context cleanliness</strong>: <code>ctx.*</code> not polluted with subscription methods; preserves room for future state (presence, session info, etc.)</li><li><strong>Asymmetry is intentional</strong>: Encourages correct mental model‚Äîyou manage subscriptions, you send messages</li></ul><h3 id="_2-state-type-readonlyset-string-not-custom-interface" tabindex="-1">2. State Type: <code>ReadonlySet&lt;string&gt;</code> (Not Custom Interface) <a class="header-anchor" href="#_2-state-type-readonlyset-string-not-custom-interface" aria-label="Permalink to ‚Äú2. State Type: ReadonlySet&lt;string&gt; (Not Custom Interface)‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Topics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReadonlySet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  unsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  subscribeMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    topics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Iterable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">added</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  unsubscribeMany</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    topics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Iterable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">removed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">total</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  clear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">removed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Why native Set:</strong></p><ul><li><strong>Zero overhead</strong>: No wrapper serialization, caching, or custom interface to learn</li><li><strong>Familiar API</strong>: <code>.has()</code>, <code>.size</code>, <code>.forEach()</code>, <code>for...of</code>, spread operator work natively</li><li><strong>Immutable contract</strong>: <code>ReadonlySet</code> enforces &quot;don&#39;t mutate directly; use methods&quot;</li><li><strong>Type clarity</strong>: TypeScript automatically knows <code>.has()</code> exists; no custom interface doc needed</li><li><strong>Scalable</strong>: Other state management (presence, session) can follow same pattern</li></ul><p><strong>Not a custom interface:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå Rejected: Custom interface forces custom implementation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Subscriptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This required users to learn a one-off API; <code>ReadonlySet</code> is already known.</p><h3 id="_3-return-type-promise-void-throw-on-error" tabindex="-1">3. Return Type: <code>Promise&lt;void&gt;</code> + Throw on Error <a class="header-anchor" href="#_3-return-type-promise-void-throw-on-error" aria-label="Permalink to ‚Äú3. Return Type: Promise&lt;void&gt; + Throw on Error‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Idempotent: safe to call multiple times, no error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;room:123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;room:123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚úÖ No-op, no error</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Error: throw, always</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;room:INVALID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PubSubError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Handle authorization, validation, connection errors</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Why <code>Promise&lt;void&gt;</code> + throw:</strong></p><ul><li><strong>Idiomatic async/await</strong>: Callers don&#39;t inspect return values; they await or error-handle</li><li><strong>Boolean returns are anti-pattern</strong>: <code>const changed = await subscribe()</code> ‚Äî what does <code>false</code> mean? Not an error, but not a success either. Ambiguous.</li><li><strong>Errors are exceptional</strong>: Validation failures, authorization denials, connection closures‚Äîthese should throw</li><li><strong>No defensive checks needed</strong>: Apps can unconditionally call <code>subscribe()</code> without <code>if (!has(topic))</code> guards</li><li><strong>Idempotency is implicit contract</strong>: Not signaled by return value; documented as behavior</li></ul><p><strong>Comparison:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå Rejected: Boolean return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> stateChanged</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Callers ask: &quot;What does false mean? Already subscribed? Error? Both?&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚úÖ Selected: Void return + throw</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Always succeeds (idempotent) or throws</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Handle error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-batch-operations-atomic-all-or-nothing" tabindex="-1">4. Batch Operations: Atomic (All-or-Nothing) <a class="header-anchor" href="#_4-batch-operations-atomic-all-or-nothing" aria-label="Permalink to ‚Äú4. Batch Operations: Atomic (All-or-Nothing)‚Äù">‚Äã</a></h3><p><strong>Guarantee</strong>: <code>subscribeMany()</code> and <code>unsubscribeMany()</code> are atomic. Either all succeed or all fail; no partial state.</p><p><strong>Why atomic:</strong></p><ul><li><strong>Prevents inconsistent state</strong>: Partial failure (some subscribed, others failed) leaves app in undefined state</li><li><strong>Single round-trip</strong>: One await for many operations (vs O(n) awaits in loop)</li><li><strong>Consistent with database transactions</strong>: Apps expect atomic or nothing</li><li><strong>Simplifies error handling</strong>: One error means entire batch failed; no need to track partial success</li></ul><p><strong>Complete specification</strong>: See <a href="./../specs/pubsub#_63-batch-atomicity">docs/specs/pubsub.md ¬ß 6.3</a> for rollback semantics, atomicity flow, and monitoring patterns.</p><h3 id="_5-optional-typed-topics-via-topic-helper" tabindex="-1">5. Optional Typed Topics via <code>topic()</code> Helper <a class="header-anchor" href="#_5-optional-typed-topics-via-topic-helper" aria-label="Permalink to ‚Äú5. Optional Typed Topics via topic() Helper‚Äù">‚Äã</a></h3><p><strong>Design</strong>: Type-safe topic definitions are optional, not mandatory. Apps can use plain strings or use the <code>topic()</code> helper for validation and type inference.</p><p><strong>Why optional:</strong></p><ul><li><strong>Zero runtime cost if unused</strong>: <code>topic()</code> compiles to strings; no wrapper overhead</li><li><strong>Progressive adoption</strong>: Start simple (strings), migrate to types incrementally</li><li><strong>No false ceremony</strong>: Not forcing schema for every topic when <code>&quot;room:123&quot;</code> is self-explanatory</li><li><strong>Aligns with WS-Kit philosophy</strong>: Type safety when you need it, not mandatory</li></ul><p><strong>Examples</strong>: See <a href="./../specs/pubsub#_4-typed-topic-helper-optional-convenience">docs/specs/pubsub.md ¬ß 4</a> for detailed examples, patterns, and use cases.</p><h3 id="_6-single-extension-point-usepubsub-as-canonical-authority" tabindex="-1">6. Single Extension Point: <code>usePubSub()</code> as Canonical Authority <a class="header-anchor" href="#_6-single-extension-point-usepubsub-as-canonical-authority" aria-label="Permalink to ‚Äú6. Single Extension Point: usePubSub() as Canonical Authority‚Äù">‚Äã</a></h3><p><strong>üéØ Core Policy: Eliminate &quot;Where Do I Put This?&quot; Confusion</strong></p><p>There is <strong>exactly one place</strong> where applications configure pub/sub authorization, normalization, and lifecycle hooks: <strong><code>usePubSub()</code> middleware</strong>. The router constructor is <strong>never</strong> used for pub/sub policy.</p><p><strong>Architecture (Clean Split):</strong></p><table tabindex="0"><thead><tr><th>Layer</th><th>Responsibility</th><th>Code</th></tr></thead><tbody><tr><td><strong>Router constructor</strong></td><td>Structural shape only</td><td><code>new WebSocketRouter({ limits: { topicPattern, maxTopicLength, maxTopicsPerConnection } })</code></td></tr><tr><td><strong><code>usePubSub()</code> middleware</strong></td><td>All context-aware policy</td><td><code>usePubSub({ normalize, authorizeSubscribe, authorizePublish, onSubscribe, onUnsubscribe, invalidateAuth })</code></td></tr><tr><td><strong>Internal implementation</strong></td><td>Testing hooks only (not public)</td><td>(Hidden from users; developers never configure this)</td></tr></tbody></table><p><strong>Why Single Extension Point Eliminates Confusion:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå CONFUSION: Split responsibility</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;Do I put authorization in router constructor or middleware?&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WebSocketRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  limits: { topicPattern:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[a-z0-9:_./-]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">{1,128}$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pubsubHooks: {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Where to put auth?</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authorizeSubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* ... */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  usePubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authorizeSubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* ... */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Or here?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚úÖ CLARITY: Single canonical point</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;Where do I put authorization?&quot; Answer: &quot;Always in usePubSub() middleware.&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WebSocketRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  limits: { topicPattern:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">[a-z0-9:_./-]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">{1,128}$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Structural only; no hooks here</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  usePubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // All policy goes here:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    normalize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> t.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toLowerCase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authorizeSubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> canAccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.user, topic),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    authorizePublish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> canPublish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.user, topic),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onSubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Subscribed: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    onUnsubscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cleanup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, topic),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// One place, clear intent</span></span></code></pre></div><p><strong>Rationale:</strong></p><ul><li><strong>Eliminates confusion</strong>: One canonical answer to &quot;Where do I put this?&quot;</li><li><strong>Clear separation of concerns</strong>: Router limits = shape, middleware = policy</li><li><strong>Prevents accidental split</strong>: Can&#39;t scatter auth logic across two config points</li><li><strong>Scalability</strong>: Apps add multiple hooks in one middleware; no hunting for multiple config places</li><li><strong>Testability</strong>: Tests override middleware; constructor is fixed at deploy time</li><li><strong>No dual responsibility</strong>: Implementation never has public constructor hooks; only <code>usePubSub()</code> is the public extension point</li></ul><h3 id="_7-semantics-idempotency-first-order-critical-for-dx-correctness" tabindex="-1">7. Semantics: Idempotency-First Order (Critical for DX &amp; Correctness) <a class="header-anchor" href="#_7-semantics-idempotency-first-order-critical-for-dx-correctness" aria-label="Permalink to ‚Äú7. Semantics: Idempotency-First Order (Critical for DX &amp; Correctness)‚Äù">‚Äã</a></h3><p><strong>üî¥ CRITICAL</strong>: Idempotency-first is non-negotiable. Every operation must return early on idempotent calls with <strong>ZERO side effects</strong>.</p><p><strong>Normative specification: See <a href="./../specs/pubsub#_61-canonical-operation-order-normative">docs/specs/pubsub.md ¬ß 6.1</a></strong></p><p>This section explains the design rationale. For the complete specification with flowchart and implementation details, see the reference above.</p><p><strong>Why idempotency-first (not validation-first):</strong></p><ul><li><strong>Duplicate calls are guaranteed clean no-ops</strong>: Calling <code>subscribe()</code> twice on same topic never errors, never validates, never hits ACL. This eliminates spurious failures on transient duplicates and race conditions. <strong>This is a promise to app developers.</strong></li><li><strong>Simplifies error semantics</strong>: Errors only occur when attempting a state change. &quot;Idempotent&quot; truly means &quot;safe to repeat unconditionally‚Äîno side effects, no validation, no errors.&quot;</li><li><strong>Matches <code>unsubscribe()</code> semantics</strong>: <code>unsubscribe()</code> on non-subscribed topic is soft no-op (no validation, no error). Idempotency-first makes both consistent and predictable.</li><li><strong>Better for concurrency</strong>: Concurrent duplicate calls linearize safely without spurious failures.</li><li><strong>DX improvement</strong>: Apps don&#39;t need defensive <code>if (!has(topic))</code> checks before unsubscribing or worry about spurious ACL failures on duplicates.</li><li><strong>Cost is pure win</strong>: Validation/authorization happen early, but only on actual state changes. Skip unnecessary validation on no-ops = no downside.</li></ul><h3 id="_8-error-model-subscribe-throws-publish-returns-with-retryability-hint" tabindex="-1">8. Error Model: Subscribe Throws, Publish Returns (with Retryability Hint) <a class="header-anchor" href="#_8-error-model-subscribe-throws-publish-returns-with-retryability-hint" aria-label="Permalink to ‚Äú8. Error Model: Subscribe Throws, Publish Returns (with Retryability Hint)‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Subscriptions throw on error (state mutations need strong signals)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PubSubError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Handle: validation, ACL, state, connection errors</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Publish returns result with actionable retryability hint</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, schema, data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`published to \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">matchedLocal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;?&quot;} local subscribers\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.retryable) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Schedule retry with exponential backoff</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  scheduleRetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, data, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">exponentialBackoff</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Fail-fast: don&#39;t retry validation, ACL, or unsupported errors</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`publish failed (\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">})\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.details);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Rationale:</strong></p><ul><li><strong>State mutations throw</strong>: <code>subscribe()</code> changes connection state; throw provides strong, explicit error signal</li><li><strong>Transient actions return</strong>: <code>publish()</code> broadcasts messages; return enables predictable, result-based error handling</li><li><strong>Memorable pattern</strong>: &quot;Mutations throw, actions return&quot;‚Äîsingle rule users can memorize</li><li><strong>Retryable hint is actionable</strong>: <code>retryable: boolean</code> tells callers whether to retry without switch statements. Eliminates boilerplate in every publish call.</li><li><strong>Never throws</strong>: <code>publish()</code> won&#39;t reject for runtime conditions (validation, ACL, state, backpressure), reducing try/catch ceremony for normal operation</li></ul><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to ‚ÄúConsequences‚Äù">‚Äã</a></h2><h3 id="benefits" tabindex="-1">Benefits <a class="header-anchor" href="#benefits" aria-label="Permalink to ‚ÄúBenefits‚Äù">‚Äã</a></h3><p>‚úÖ <strong>üî¥ Idempotency-first guarantee</strong> ‚Äî Duplicate calls return immediately with zero side effects (no validation, no auth, no adapter calls, no hooks). Eliminates spurious failures on transient duplicates. <strong>This is the most important DX win.</strong></p><p>‚úÖ <strong>Single extension point eliminates confusion</strong> ‚Äî Developers ask &quot;where do I put authorization?&quot; Answer: always <code>usePubSub()</code> middleware. Router constructor is structural shape only. No more hunting through documentation or asking &quot;should this go in the router or in middleware?&quot;</p><p>‚úÖ <strong>Clear semantic separation</strong> ‚Äî State (topics) vs action (publish) are distinct concepts</p><p>‚úÖ <strong>Predictable error handling</strong> ‚Äî Subscribe throws; publish returns; &quot;mutations throw, actions return&quot;</p><p>‚úÖ <strong>Idiomatic async/await</strong> ‚Äî <code>Promise&lt;void&gt;</code> + throw matches modern JS</p><p>‚úÖ <strong>Zero overhead</strong> ‚Äî <code>ReadonlySet&lt;string&gt;</code> is native; no wrapper</p><p>‚úÖ <strong>Prevents inconsistent state</strong> ‚Äî Atomic batches, strict operation order, per-topic idempotency checks within batches</p><p>‚úÖ <strong>Actionable remediation</strong> ‚Äî <code>retryable: boolean</code> eliminates boilerplate; no switch statements needed</p><p>‚úÖ <strong>Progressive type safety</strong> ‚Äî Optional <code>topic()</code> helper, not mandatory</p><p>‚úÖ <strong>Safe concurrent calls</strong> ‚Äî Idempotency-first + per-topic in-flight serialization prevents race conditions</p><p>‚úÖ <strong>No defensive code needed</strong> ‚Äî Apps don&#39;t need <code>if (!has(topic))</code> checks; can call subscribe/unsubscribe unconditionally</p><p>‚úÖ <strong>Clean separation of concerns</strong> ‚Äî Deployment-time config (limits) vs runtime policy (middleware) never conflict</p><p>‚úÖ <strong>Extensible</strong> ‚Äî Room for patterns, presence, Redis adapters (separate ADRs)</p><p>‚úÖ <strong>Portable</strong> ‚Äî Identical semantics across Bun, Node/uWS, Cloudflare DO</p><h3 id="trade-offs" tabindex="-1">Trade-offs <a class="header-anchor" href="#trade-offs" aria-label="Permalink to ‚ÄúTrade-offs‚Äù">‚Äã</a></h3><p>‚ö†Ô∏è <strong>Breaking change from draft spec</strong> ‚Äî Apps using draft API must migrate ‚ö†Ô∏è <strong>Adapters need transactional semantics</strong> ‚Äî Batch atomicity requires careful implementation (but pays off with correctness) ‚ö†Ô∏è <strong><code>ReadonlySet</code> immutability must be enforced</strong> ‚Äî Adapters must prevent direct mutation (via freeze, proxy, or wrapper) ‚ö†Ô∏è <strong>Hooks fire after mutation</strong> ‚Äî If hook throws, state is already changed (no automatic rollback). Exceptions propagate to caller; apps requiring rollback must implement try/catch at handler/middleware level. ‚ö†Ô∏è <strong>No <code>subscriberCount()</code> API</strong> ‚Äî Unreliable across adapters; <code>publish()</code> result provides capability hint instead ‚ö†Ô∏è <strong>Single extension point means no per-topic hooks</strong> ‚Äî All auth/lifecycle is global via <code>usePubSub()</code>. Per-topic hooks are future extension (ADR-023+)</p><p><strong>Not a trade-off (non-negotiable invariant):</strong></p><ul><li>‚úì <strong>Idempotency-first is guaranteed, not optional</strong> ‚Äî Duplicate calls ALWAYS return with zero side effects (no validation, no auth, no adapter, no hooks). This is a promise to developers, not a performance optimization that can be relaxed.</li></ul><h2 id="alternatives-considered" tabindex="-1">Alternatives Considered <a class="header-anchor" href="#alternatives-considered" aria-label="Permalink to ‚ÄúAlternatives Considered‚Äù">‚Äã</a></h2><h3 id="_1-flat-methods-ctx-subscribe-ctx-unsubscribe-deprecated" tabindex="-1">1. Flat Methods: <code>ctx.subscribe()</code>, <code>ctx.unsubscribe()</code> (DEPRECATED) <a class="header-anchor" href="#_1-flat-methods-ctx-subscribe-ctx-unsubscribe-deprecated" aria-label="Permalink to ‚Äú1. Flat Methods: ctx.subscribe(), ctx.unsubscribe() (DEPRECATED)‚Äù">‚Äã</a></h3><p>No namespace, just add methods to context directly.</p><p><strong>Pros:</strong></p><ul><li>Simpler initial API</li><li>Fewer characters to type</li></ul><p><strong>Cons:</strong></p><ul><li>Pollutes <code>ctx.*</code> namespace (no room for future state like presence, session info)</li><li>No conceptual separation between messaging and subscriptions</li><li>Harder to discover all subscription operations (scattered in context)</li></ul><p><strong>Why rejected:</strong> Context grows unbounded; namespace separation is better architecture.</p><p><strong>Migration:</strong> All flat methods have been deprecated in favor of the namespaced <code>ctx.topics.*</code> API.</p><hr><h3 id="_2-fluent-chains-ctx-topics-subscribe-with-metadata-auth-fn-commit" tabindex="-1">2. Fluent Chains: <code>ctx.topics.subscribe().with(metadata).auth(fn).commit()</code> <a class="header-anchor" href="#_2-fluent-chains-ctx-topics-subscribe-with-metadata-auth-fn-commit" aria-label="Permalink to ‚Äú2. Fluent Chains: ctx.topics.subscribe().with(metadata).auth(fn).commit()‚Äù">‚Äã</a></h3><p>Builder pattern with chaining for expressiveness.</p><p><strong>Pros:</strong></p><ul><li>Expressive for complex operations</li></ul><p><strong>Cons:</strong></p><ul><li>Boilerplate for simple cases: <code>await ctx.topics.subscribe(topic).commit();</code></li><li>Unusual pattern for pub/sub (RPC uses it, but subscribe/publish are simpler)</li><li>More surface area to test and maintain</li></ul><p><strong>Why rejected:</strong> Simple operations should be simple. Fluent chains add ceremony.</p><hr><h3 id="_3-heavy-router-registration-router-topic-schema-onsubscribe-authorize" tabindex="-1">3. Heavy Router Registration: <code>router.topic(schema, { onSubscribe, authorize, ... })</code> <a class="header-anchor" href="#_3-heavy-router-registration-router-topic-schema-onsubscribe-authorize" aria-label="Permalink to ‚Äú3. Heavy Router Registration: router.topic(schema, { onSubscribe, authorize, ... })‚Äù">‚Äã</a></h3><p>Like <code>router.on()</code> and <code>router.rpc()</code>, register topics at router level.</p><p><strong>Pros:</strong></p><ul><li>Centralized topic definitions</li><li>Per-topic lifecycle hooks and authorization</li></ul><p><strong>Cons:</strong></p><ul><li>Boilerplate for simple topics without special ACL</li><li>Topics aren&#39;t first-class like message types (asymmetry)</li><li>Requires pre-registration; dynamic topics less natural</li></ul><p><strong>Why rejected:</strong> Common case (simple pub/sub) shouldn&#39;t require ceremony. Hooks via middleware suffice; heavy patterns are future extension.</p><hr><h3 id="_4-boolean-returns-promise-boolean-state-changed" tabindex="-1">4. Boolean Returns: <code>Promise&lt;boolean&gt;</code> (State Changed?) <a class="header-anchor" href="#_4-boolean-returns-promise-boolean-state-changed" aria-label="Permalink to ‚Äú4. Boolean Returns: Promise&lt;boolean&gt; (State Changed?)‚Äù">‚Äã</a></h3><p>Subscribe/unsubscribe return <code>boolean</code> indicating if state actually changed.</p><p><strong>Pros:</strong></p><ul><li>Can distinguish duplicate subscribe from first-time</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Anti-idiomatic</strong> ‚Äî Idempotent operations returning false create ambiguity</li><li>Apps don&#39;t typically care about &quot;did state change?&quot;; they care about &quot;is it now subscribed?&quot;</li><li>Invites incorrect patterns: <code>if (await subscribe()) { /* ... */ }</code> ‚Äî unclear intent</li><li>Conflicts with throw semantics (error still thrown, but what about duplicate unsubscribe?)</li></ul><p><strong>Why rejected:</strong> <code>Promise&lt;void&gt;</code> + throw is the idiomatic pattern in modern JavaScript.</p><hr><h3 id="_5-custom-subscriptions-interface" tabindex="-1">5. Custom Subscriptions Interface <a class="header-anchor" href="#_5-custom-subscriptions-interface" aria-label="Permalink to ‚Äú5. Custom Subscriptions Interface‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Subscriptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Define a custom interface instead of using native <code>Set</code>.</p><p><strong>Pros:</strong></p><ul><li>Shields implementation details</li><li>Could add custom methods later</li></ul><p><strong>Cons:</strong></p><ul><li>Users learn a one-off interface (not discoverable from <code>ReadonlySet</code>)</li><li><code>ReadonlySet</code> is already immutable; custom wrapper adds confusion</li><li>No better than native, just more layers</li></ul><p><strong>Why rejected:</strong> Use native APIs when they fit. <code>ReadonlySet</code> is perfect for subscriptions.</p><hr><h3 id="_6-include-subscribercount-api" tabindex="-1">6. Include <code>subscriberCount()</code> API <a class="header-anchor" href="#_6-include-subscribercount-api" aria-label="Permalink to ‚Äú6. Include subscriberCount() API‚Äù">‚Äã</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.pubsub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscriberCount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic): number </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>Expose subscriber count for analytics/decisions.</p><p><strong>Pros:</strong></p><ul><li>Useful for some applications (load balancing, visibility)</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Unreliable across adapters</strong> ‚Äî Exact on Bun, estimate on Node/uWS, unavailable on others</li><li>Apps shouldn&#39;t rely on approximate numbers for correctness</li><li>Spec says &quot;don&#39;t rely on this in portable code&quot; ‚Äî then why expose it?</li><li><code>publish()</code> result already provides capability hint (<code>exact/estimate/unknown</code>) and matched count (if available)</li></ul><p><strong>Why rejected:</strong> Avoid APIs that are unreliable across platforms. <code>publish()</code> result is sufficient signal.</p><hr><h3 id="_7-mandatory-typed-topics" tabindex="-1">7. Mandatory Typed Topics <a class="header-anchor" href="#_7-mandatory-typed-topics" aria-label="Permalink to ‚Äú7. Mandatory Typed Topics‚Äù">‚Äã</a></h3><p>All topics must be defined with schema before use.</p><p><strong>Pros:</strong></p><ul><li>Full type safety across application</li></ul><p><strong>Cons:</strong></p><ul><li>Boilerplate for simple, ephemeral topics</li><li>Higher barrier to entry for new projects</li><li>Doesn&#39;t match reality: some topics are dynamically constructed at runtime</li></ul><p><strong>Why rejected:</strong> Progressive type safety wins. Simple apps use strings; complex apps use <code>topic()</code> helper. Migration path is smooth.</p><hr><h3 id="_8-keep-separate-pub-sub-namespace-ctx-pubsub-publish" tabindex="-1">8. Keep Separate Pub/Sub Namespace: <code>ctx.pubsub.publish()</code> <a class="header-anchor" href="#_8-keep-separate-pub-sub-namespace-ctx-pubsub-publish" aria-label="Permalink to ‚Äú8. Keep Separate Pub/Sub Namespace: ctx.pubsub.publish()‚Äù">‚Äã</a></h3><p>Keep all pub/sub operations (subscribe, publish) in one namespace.</p><p><strong>Pros:</strong></p><ul><li>Everything related to pub/sub in one place</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Conflates state mutation with transient action</strong> ‚Äî Publish is not a state change; it&#39;s a broadcast</li><li>Suggests <code>publish()</code> is &quot;just another subscription operation&quot; (it&#39;s not)</li><li>Hard to reason about semantics (is this changing state or sending a message?)</li></ul><p><strong>Why rejected:</strong> Asymmetry is intentional. Subscribe = state, Publish = action. Separating them clarifies intent.</p><hr><h3 id="_9-non-atomic-batches-partial-success-allowed" tabindex="-1">9. Non-Atomic Batches (Partial Success Allowed) <a class="header-anchor" href="#_9-non-atomic-batches-partial-success-allowed" aria-label="Permalink to ‚Äú9. Non-Atomic Batches (Partial Success Allowed)‚Äù">‚Äã</a></h3><p><code>subscribeMany([a, b, c])</code> succeeds on [a, b], fails on c, returns partial result.</p><p><strong>Pros:</strong></p><ul><li>&quot;Best effort&quot; semantics</li><li>Flexibility for apps that want partial results</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Inconsistent state</strong> ‚Äî app now subscribed to some topics, failed on others; unclear how to handle</li><li>Error handling complex: &quot;Did it fail on one topic or all?&quot;</li><li>Partial success invites bugs (app thinks it&#39;s subscribed to [a,b,c], but only [a,b] succeeded)</li></ul><p><strong>Why rejected:</strong> Atomic all-or-nothing prevents bugs. Apps can loop individual ops if they need partial tolerance.</p><hr><h3 id="_10-error-result-switch-on-error-code-vs-direct-retryable-hint" tabindex="-1">10. Error Result: Switch on <code>error</code> Code vs Direct <code>retryable</code> Hint <a class="header-anchor" href="#_10-error-result-switch-on-error-code-vs-direct-retryable-hint" aria-label="Permalink to ‚Äú10. Error Result: Switch on error Code vs Direct retryable Hint‚Äù">‚Äã</a></h3><p>How to signal retry logic in <code>PublishResult</code>?</p><p><strong>Alternative A: Switch on error code (rejected)</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, schema, data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.error) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;VALIDATION&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ACL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;PAYLOAD_TOO_LARGE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;UNSUPPORTED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;STATE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // Don&#39;t retry</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Publish failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;BACKPRESSURE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;CONNECTION_CLOSED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ADAPTER_ERROR&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // Retry with backoff</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      scheduleRetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Cons of switch approach:</strong></p><ul><li>Boilerplate: every publish call needs this logic (or a wrapper)</li><li>Error-prone: forgetting a case means wrong retry behavior</li><li>Hard to maintain: adding new errors requires hunting down all switch statements</li><li>Doesn&#39;t scale: different apps may have different retry policies for same error</li></ul><p><strong>Selected: Direct <code>retryable: boolean</code> hint</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, schema, data);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.ok) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Success</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (result.retryable) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  scheduleRetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, data, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">exponentialBackoff</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Publish failed: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">error</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.details);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Pros:</strong></p><ul><li>Zero boilerplate: two-way split is universal (retry vs fail-fast)</li><li>Self-documenting: <code>retryable</code> directly answers &quot;should I retry?&quot;</li><li>Scales: adapter sets retryability based on error semantics; app doesn&#39;t need to know error codes</li><li>Composable: retry logic is orthogonal to error details (which live in <code>details</code> object)</li><li>Portable: two-way split works across all adapters; switch logic would be adapter-specific</li></ul><p><strong>Trade-off:</strong></p><ul><li>Apps lose fine-grained per-error-code control</li><li><strong>Mitigation</strong>: Apps that need custom logic per error can still inspect <code>result.error</code> and <code>result.details</code>; <code>retryable</code> is just a helpful default</li></ul><p><strong>Why selected:</strong> Progressive disclosure. Common case (retry vs fail-fast) is trivial; uncommon case (custom per-error logic) still available via error code inspection.</p><h2 id="implementation-invariants-for-adapters" tabindex="-1">Implementation Invariants for Adapters <a class="header-anchor" href="#implementation-invariants-for-adapters" aria-label="Permalink to ‚ÄúImplementation Invariants for Adapters‚Äù">‚Äã</a></h2><p>These must hold for all adapters:</p><ol><li><strong>Normalize before authorization</strong> ‚Äî App receives normalized topic in auth hooks; prevents TOCTOU</li><li><strong>Idempotency check before hooks</strong> ‚Äî Hooks only fire on state changes, not on duplicate calls</li><li><strong>Batch atomicity</strong> ‚Äî Validate all before mutating any state</li><li><strong>ReadonlySet immutability</strong> ‚Äî Prevent direct mutation via <code>.add()</code>, <code>.delete()</code>, etc.</li><li><strong>Hooks after mutation</strong> ‚Äî Hooks run only after state successfully changes</li><li><strong>Error codes</strong> ‚Äî Use <code>PubSubError</code> with correct code; never other error types</li><li><strong>Hook timing</strong> ‚Äî <code>onSubscribe</code> after subscribe, <code>onUnsubscribe</code> after unsubscribe; not called on idempotent no-ops</li></ol><p>See <a href="./../specs/pubsub#_11-implementation-invariants-for-adapter-authors">docs/specs/pubsub.md section 11</a> (Implementation Invariants for Adapter Authors) for detailed prescriptions.</p><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to ‚ÄúReferences‚Äù">‚Äã</a></h2><ul><li><p><strong>Spec</strong> (Normative &amp; Canonical): <a href="./../specs/pubsub"><code>docs/specs/pubsub.md</code></a></p><ul><li><strong>Sections 1-10</strong>: API surface, terminology, semantics, examples, invariants</li><li><strong>Section 11</strong>: Implementation invariants for adapter authors (authoritative)</li><li><strong>Sections 12-15</strong>: Adapter compliance checklist, concurrency model, edge cases</li></ul></li><li><p><strong>This ADR</strong> (Design Rationale):</p><ul><li><strong>Decision</strong>: Eight core decisions and their rationale</li><li><strong>Consequences</strong>: Benefits and trade-offs</li><li><strong>Alternatives Considered</strong>: Why we rejected other approaches</li><li><strong>Implementation Invariants</strong>: Design principles behind the spec</li></ul></li><li><p><strong>Related ADRs</strong> (API Design Philosophy):</p><ul><li>ADR-020: Send vs Publish (unicast vs multicast naming rationale)</li><li>ADR-015: Reply vs Send (RPC terminal response vs fire-and-forget)</li><li>ADR-014: Client-Side Request/Response (RPC auto-correlation)</li></ul></li><li><p><strong>Implementation</strong> (Upcoming):</p><ul><li><code>packages/core/src/types.ts</code> ‚Äî Context and Router interface extensions</li><li><code>packages/core/src/adapters/</code> ‚Äî Adapter implementations (Bun, uWS, etc.)</li><li><code>packages/core/test/features/</code> ‚Äî Feature tests for pub/sub semantics</li></ul></li></ul><hr><h2 id="appendix-a-design-trade-off-matrix" tabindex="-1">Appendix A: Design Trade-off Matrix <a class="header-anchor" href="#appendix-a-design-trade-off-matrix" aria-label="Permalink to ‚ÄúAppendix A: Design Trade-off Matrix‚Äù">‚Äã</a></h2><p>This table summarizes all major decisions and their trade-offs:</p><table tabindex="0"><thead><tr><th>Decision</th><th>Alternative</th><th>Cost of Chosen</th><th>Cost of Alternative</th><th>Winner</th></tr></thead><tbody><tr><td><strong>Namespace</strong> <code>ctx.topics</code></td><td>Flat <code>ctx.subscribe()</code></td><td>Context conceptually grouped</td><td>Namespace clutter</td><td>Namespace</td></tr><tr><td><strong>State</strong> <code>ReadonlySet&lt;string&gt;</code></td><td>Custom <code>subscriptions { list, has }</code></td><td>Immutability enforcement needed</td><td>User learns one-off interface</td><td>ReadonlySet</td></tr><tr><td><strong>Return</strong> <code>Promise&lt;void&gt;</code></td><td><code>Promise&lt;boolean&gt;</code></td><td>No state-change signal</td><td>Idiomatic ambiguity (false = error?)</td><td>void</td></tr><tr><td><strong>Publish</strong> Flat <code>ctx.publish()</code></td><td>Under <code>ctx.topics.publish()</code></td><td>Asymmetry not obvious</td><td>Conflates state + action</td><td>Flat</td></tr><tr><td><strong>Batch</strong> Atomic</td><td>Non-atomic (partial)</td><td>All-or-nothing contract</td><td>Apps need partial-tolerance code</td><td>Atomic</td></tr><tr><td><strong>Typed</strong> Optional via <code>topic()</code></td><td>Mandatory schema</td><td>Extra boilerplate on simple apps</td><td>Less safety on simple cases</td><td>Optional</td></tr><tr><td><strong>Hooks</strong> Lightweight</td><td>Heavy (like <code>.on()</code> / <code>.rpc()</code>)</td><td>Not first-class topics in router</td><td>Boilerplate for simple auth</td><td>Lightweight</td></tr><tr><td><strong>Error Retry Signal</strong> <code>retryable: boolean</code></td><td>Switch on error codes</td><td>Less fine-grained control; need custom logic for per-error policies</td><td>Every app needs switch boilerplate; hard to maintain</td><td><code>retryable</code> hint</td></tr></tbody></table><hr><h2 id="appendix-b-why-not-inline-authorization-in-methods" tabindex="-1">Appendix B: Why NOT Inline Authorization in Methods <a class="header-anchor" href="#appendix-b-why-not-inline-authorization-in-methods" aria-label="Permalink to ‚ÄúAppendix B: Why NOT Inline Authorization in Methods‚Äù">‚Äã</a></h2><p>An earlier proposal was to pass authorization inline:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ‚ùå Rejected: Inline authorization</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.topics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic, { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authorize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> canAccess</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx) });</span></span></code></pre></div><p><strong>Why this doesn&#39;t work:</strong></p><ol><li><strong>Authorization is global policy</strong> ‚Äî Same check should apply to all operations, not per-call</li><li><strong>Hooks are cleaner</strong> ‚Äî <code>usePubSub({ authorizeSubscribe: ... })</code> is DRY</li><li><strong>Precedent</strong> ‚Äî Handler routing doesn&#39;t take inline authorization; middleware applies it globally</li><li><strong>Scope creep</strong> ‚Äî Soon you want inline lifecycle hooks, normalization, validation‚Äîbecomes heavy fast</li></ol><hr><h2 id="appendix-c-reconnection-state-persistence" tabindex="-1">Appendix C: Reconnection &amp; State Persistence <a class="header-anchor" href="#appendix-c-reconnection-state-persistence" aria-label="Permalink to ‚ÄúAppendix C: Reconnection &amp; State Persistence‚Äù">‚Äã</a></h2><p><strong>Question:</strong> Should subscriptions persist across reconnection?</p><p><strong>Answer:</strong> No. Subscriptions are per-connection state.</p><p><strong>Rationale:</strong></p><ul><li>WebSocket connections are stateless from protocol perspective</li><li>Subscriptions should explicitly be re-requested on reconnection</li><li>Apps that want to restore state should maintain their own &quot;desired topics&quot; list and re-subscribe</li><li>This is explicit and controllable by the app, vs automatic but fragile</li></ul><p><strong>Recommended Patterns:</strong></p><p>See <a href="./../specs/pubsub#_9-reconnection-state-persistence-important-pattern">docs/specs/pubsub.md ¬ß 9</a> for two patterns:</p><ol><li><strong>Atomic resync using <code>replace()</code></strong> (recommended) ‚Äî Synchronize all subscriptions atomically without manual diffing</li><li><strong>Manual control using <code>subscribe()</code>/<code>unsubscribe()</code></strong> ‚Äî For fine-grained control over individual subscriptions</li></ol>`,199)])])}const g=i(n,[["render",l]]);export{k as __pageData,g as default};

import{x as s,a,f as e,p as n}from"./chunks/framework.DdttWuXo.js";const c=JSON.parse('{"title":"ADR-035: Bun Adapter Refinement","description":"","frontmatter":{},"headers":[],"relativePath":"adr/035-bun-adapter-refinement.md","filePath":"adr/035-bun-adapter-refinement.md","lastUpdated":1763305236000}'),t={name:"adr/035-bun-adapter-refinement.md"};function l(r,i,h,o,p,d){return e(),a("div",null,[...i[0]||(i[0]=[n(`<h1 id="adr-035-bun-adapter-refinement" tabindex="-1">ADR-035: Bun Adapter Refinement <a class="header-anchor" href="#adr-035-bun-adapter-refinement" aria-label="Permalink to “ADR-035: Bun Adapter Refinement”">​</a></h1><p><strong>Status</strong>: Proposed</p><p><strong>Date</strong>: 2025-11-16</p><p><strong>Related</strong>: <a href="./031-plugin-adapter-architecture">ADR-031 Plugin-Adapter Architecture</a>, <a href="./033-opaque-transport-canonical-connection-data">ADR-033 Opaque Transport &amp; Canonical Connection Data</a>, <a href="./034-bun-upgrade-return-semantics">ADR-034 Bun Upgrade Return Semantics</a></p><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to “Context”">​</a></h2><p>The <code>@ws-kit/bun</code> adapter has accumulated technical debt and DX issues:</p><ol><li><strong>Authentication doesn&#39;t actually gate connections</strong> — docs say <code>authenticate</code> should reject on <code>undefined</code>, but the implementation always upgrades regardless</li><li><strong>Dead options expose broken contracts</strong> — <code>context</code> and <code>onBroadcast</code> are in the public API but unused; <code>onError</code> is exposed but never called</li><li><strong>Inconsistency with core patterns</strong> — <code>createBunHandler()</code> doesn&#39;t unwrap typed routers like <code>serve()</code> does, creating asymmetric behavior</li><li><strong>Dependency bloat</strong> — Uses <code>uuid</code> package when Bun&#39;s native <code>crypto.randomUUID()</code> is available</li><li><strong>Stale documentation</strong> — Comments reference non-existent functions and older Pub/Sub initialization patterns</li><li><strong>Unclear error handling</strong> — No unified error hook strategy across upgrade, open, message, close phases</li></ol><p>These issues erode user trust (docs don&#39;t match code) and create DX traps (dead options, broken gatekeeping).</p><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>Apply four core refinements to align the Bun adapter with WS-Kit&#39;s philosophy (adapter-first, plugin-driven, minimal behavior):</p><h3 id="_1-authentication-gating-security-critical" tabindex="-1">1. Authentication Gating (Security Critical) <a class="header-anchor" href="#_1-authentication-gating-security-critical" aria-label="Permalink to “1. Authentication Gating (Security Critical)”">​</a></h3><p><strong>Move authentication decision to <code>fetch</code></strong>, before <code>upgradeConnection</code>:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In BunHandlerOptions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">authenticate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">authRejection</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { status?: number; message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> string }; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: 401 &quot;Unauthorized&quot;</span></span></code></pre></div><ul><li>If <code>authenticate</code> is <strong>absent</strong> → upgrade with minimal data (clientId, connectedAt)</li><li>If <code>authenticate</code> is <strong>present</strong>: <ul><li>Returns <code>undefined</code> → reject with configured status (default 401)</li><li>Returns object → merge into connection data and upgrade</li></ul></li><li>Call <code>authenticate</code> once in <code>fetch</code>, pass precomputed data to <code>upgradeConnection</code></li><li>This makes auth a true gatekeeper, matching documented behavior</li></ul><p><strong>Breaking Change</strong>: Apps that relied (incorrectly) on <code>authenticate</code> returning <code>undefined</code> to accept must now return <code>{}</code>.</p><p><strong>Rationale</strong>: Security and trust. Current behavior violates the principle of least surprise. Auth should reject or accept, not always accept. This aligns implementation with docs.</p><h3 id="_2-error-hook-sync-only-minimal" tabindex="-1">2. Error Hook (Sync-Only, Minimal) <a class="header-anchor" href="#_2-error-hook-sync-only-minimal" aria-label="Permalink to “2. Error Hook (Sync-Only, Minimal)”">​</a></h3><p><strong>Keep <code>onError</code> but make it sync-only with flat context:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ErrorContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;upgrade&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;open&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;message&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;close&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  clientId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Only for &#39;upgrade&#39;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Partial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BunHandlerOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  onError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ErrorContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li>Fire in all catch blocks (fetch, open, message, close)</li><li>Sync-only to avoid promise-handling footguns (no unawaited promises, no swallowing errors)</li><li>Flat object (not tagged union) for simplicity; extensible via optional fields</li><li>Use for logging and basic telemetry only</li><li>For async cleanup or recovery, users build plugins (more robust)</li></ul><p><strong>Rationale</strong>: Observability is a common need. Sync hooks are lightweight and predictable. Keeping it separate from router-level error handling avoids dual configuration. Flat context is easy to destructure and extend.</p><h3 id="_3-remove-dead-options" tabindex="-1">3. Remove Dead Options <a class="header-anchor" href="#_3-remove-dead-options" aria-label="Permalink to “3. Remove Dead Options”">​</a></h3><p><strong>Remove from <code>BunHandlerOptions</code>:</strong></p><ul><li><code>context</code> — Global context propagation belongs in plugins (e.g., <code>withGlobalContext({ db, config })</code>) or router constructor, not adapters</li><li><code>onBroadcast</code> — Observability hooks belong in telemetry plugins, not adapters; preserves adapter-first separation of concerns</li></ul><p><strong>Keep</strong>:</p><ul><li><code>authenticate</code>, <code>clientIdHeader</code> (mechanical, required for upgrade)</li><li><code>onError</code>, <code>onUpgrade</code>, <code>onOpen</code>, <code>onClose</code> (lifecycle hooks that fire)</li></ul><p>This shrinks the API surface and eliminates broken contracts.</p><p><strong>Rationale</strong>: Adapters should be mechanical bridges (Bun → router), not behavioral mini-frameworks. Per ADR-031, behavior lives in plugins, not adapters. Dead options confuse users and suggest features that don&#39;t work.</p><h3 id="_4-internal-consistency-polish" tabindex="-1">4. Internal Consistency &amp; Polish <a class="header-anchor" href="#_4-internal-consistency-polish" aria-label="Permalink to “4. Internal Consistency &amp; Polish”">​</a></h3><ul><li><strong>Router unwrapping in <code>createBunHandler</code></strong>: Mirror <code>serve()</code> logic to unwrap typed routers via <code>Symbol.for(&quot;ws-kit.core&quot;)</code> — ensures low-level and high-level usage are identical</li><li><strong>Fix JSDoc for <code>createDefaultBunFetch</code></strong>: Correct example to match actual API (no <code>defaultFetch</code> property)</li><li><strong>Update PubSub comments</strong>: Reference current <code>serve.ts</code> design, not non-existent <code>createBunAdapterWithServer()</code></li><li><strong>Replace <code>uuid</code> with native <code>crypto.randomUUID()</code></strong>: Drop external dependency, use Bun&#39;s built-in crypto</li></ul><h2 id="rationale" tabindex="-1">Rationale <a class="header-anchor" href="#rationale" aria-label="Permalink to “Rationale”">​</a></h2><h3 id="adapter-first-philosophy" tabindex="-1">Adapter-First Philosophy <a class="header-anchor" href="#adapter-first-philosophy" aria-label="Permalink to “Adapter-First Philosophy”">​</a></h3><p>Per ADR-031, adapters are mechanical bridges (platform-specific protocol ↔ core router). Behavioral concerns (auth decisions, observability, context propagation) belong in plugins or the core router, not adapters. This refinement removes adapter-specific hooks and defers complex concerns to the right layer.</p><h3 id="dx-trust" tabindex="-1">DX &amp; Trust <a class="header-anchor" href="#dx-trust" aria-label="Permalink to “DX &amp; Trust”">​</a></h3><p>Users expect docs and code to match. Current <code>authenticate</code> behavior (always upgrade) violates this. Sync-only <code>onError</code> prevents subtle promise bugs. Removing dead options simplifies the mental model. These changes reduce surprises and support confident usage.</p><h3 id="security" tabindex="-1">Security <a class="header-anchor" href="#security" aria-label="Permalink to “Security”">​</a></h3><p>Authentication must be a gatekeeper, not a side effect. Current behavior (always upgrade) is a security footgun masked by docs. This fix is non-negotiable.</p><h3 id="consistency" tabindex="-1">Consistency <a class="header-anchor" href="#consistency" aria-label="Permalink to “Consistency”">​</a></h3><p><code>serve()</code> and <code>createBunHandler()</code> should behave identically for the same input. Symmetric router unwrapping ensures no hidden breakage with typed routers.</p><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to “Consequences”">​</a></h2><h3 id="positive" tabindex="-1">Positive <a class="header-anchor" href="#positive" aria-label="Permalink to “Positive”">​</a></h3><ul><li>✅ <strong>Auth works as documented</strong> — <code>undefined</code> rejects, object accepts</li><li>✅ <strong>Leaner API</strong> — No dead options; clearer contract</li><li>✅ <strong>Safer error handling</strong> — Sync-only <code>onError</code> prevents promise footguns</li><li>✅ <strong>No external dependencies</strong> — Removes <code>uuid</code>, uses Bun&#39;s native crypto</li><li>✅ <strong>Consistency</strong> — Low-level and high-level APIs behave identically</li><li>✅ <strong>Stronger separation of concerns</strong> — Adapters are mechanical; plugins handle behavior</li></ul><h3 id="trade-offs" tabindex="-1">Trade-offs <a class="header-anchor" href="#trade-offs" aria-label="Permalink to “Trade-offs”">​</a></h3><ul><li><p>⚠️ <strong>Breaking Changes</strong> (minor):</p><ol><li><p><code>authenticate</code> now rejects on <code>undefined</code> (was always accepting; docs said reject)</p><ul><li>Impact: Only apps relying on broken behavior are affected</li><li>Mitigation: Clear CHANGELOG entry; error message on auth rejection</li><li>Fix: Return <code>{}</code> instead of <code>undefined</code> to accept</li></ul></li><li><p>Removed <code>context</code> from <code>BunHandlerOptions</code></p><ul><li>Impact: Apps passing global context via this option must use plugins instead</li><li>Mitigation: ADR-NNN (future) will define plugin-based context propagation</li><li>Fix: Use <code>router.plugin(withGlobalContext({ /* deps */ }))</code></li></ul></li><li><p>Removed <code>onBroadcast</code> from <code>BunHandlerOptions</code></p><ul><li>Impact: Apps tracking broadcasts via this hook must use telemetry plugins</li><li>Mitigation: Document plugin path in pubsub.md</li><li>Fix: Use <code>router.plugin(withTelemetry({ onPublish: ... }))</code></li></ul></li></ol></li><li><p>⚠️ <strong>Minor API Shape Change</strong>:</p><ul><li><code>onError</code> context is flat, not a tagged union (still extensible, simpler to use)</li><li><code>authRejection</code> is optional (defaults to 401), new in options</li><li>Upgrade failures → <code>400</code>, not <code>500</code> (per ADR-034, correct semantics)</li></ul></li><li><p>⚠️ <strong>Future ADRs Needed</strong>:</p><ul><li>ADR-036: Global Context Propagation (plugin-based path for <code>context</code>)</li><li>ADR-037: Observability Plugins (how to hook into broadcasts, errors across adapters)</li></ul></li></ul><h3 id="not-affected" tabindex="-1">Not Affected <a class="header-anchor" href="#not-affected" aria-label="Permalink to “Not Affected”">​</a></h3><ul><li><code>serve()</code> API remains unchanged (same high-level function)</li><li>Router core behavior unchanged</li><li>Pub/Sub mechanics unchanged</li><li>Message routing, validation, RPC all stable</li></ul><h2 id="migration-guide" tabindex="-1">Migration Guide <a class="header-anchor" href="#migration-guide" aria-label="Permalink to “Migration Guide”">​</a></h2><p><strong>For apps using <code>authenticate</code> returning <code>undefined</code>:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before (incorrectly relied on broken behavior)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> token </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { userId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Didn&#39;t actually reject</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After (correct)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Now properly rejects with 401</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { userId: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Or customize rejection:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authenticate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authRejection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">403</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Forbidden&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><p><strong>For apps using <code>context</code> option:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(router, { context: { db, config } });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After (with future plugin)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withGlobalContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ db, config }));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(router);</span></span></code></pre></div><p><strong>For apps using <code>onBroadcast</code>:</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Before</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(router, { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onBroadcast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg) });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// After (with future plugin)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withTelemetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onPublish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(topic) }));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">serve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(router);</span></span></code></pre></div><h2 id="scope" tabindex="-1">Scope <a class="header-anchor" href="#scope" aria-label="Permalink to “Scope”">​</a></h2><p><strong>This ADR applies to the Bun adapter only.</strong> Other adapters (Cloudflare, Node, etc.) may have different auth/error patterns. Each should be evaluated separately.</p><h2 id="version" tabindex="-1">Version <a class="header-anchor" href="#version" aria-label="Permalink to “Version”">​</a></h2><p>This is a <strong>minor breaking change</strong> (semantic: fixes broken behavior, but technically breaks apps relying on that broken behavior). Recommend <strong>v2.1.0 with strong migration note</strong> or <strong>v3.0.0 if doing other major bumps</strong>.</p><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to “References”">​</a></h2><ul><li><a href="./031-plugin-adapter-architecture">ADR-031: Plugin-Adapter Architecture</a></li><li><a href="./033-opaque-transport-canonical-connection-data">ADR-033: Opaque Transport &amp; Canonical Connection Data</a></li><li><a href="./034-bun-upgrade-return-semantics">ADR-034: Bun Upgrade Return Semantics</a></li><li><a href="https://bun.sh/docs/api/websockets" target="_blank" rel="noreferrer">Bun WebSocket API</a></li></ul>`,59)])])}const g=s(t,[["render",l]]);export{c as __pageData,g as default};

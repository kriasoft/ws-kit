import{x as a,a as s,f as e,p as t}from"./chunks/framework.DdttWuXo.js";const c=JSON.parse('{"title":"ADR-025: Validator Plugins with Configurable Options","description":"","frontmatter":{},"headers":[],"relativePath":"adr/025-validator-plugins-configurable.md","filePath":"adr/025-validator-plugins-configurable.md","lastUpdated":1762986796000}'),n={name:"adr/025-validator-plugins-configurable.md"};function l(r,i,o,d,p,h){return e(),s("div",null,[...i[0]||(i[0]=[t(`<h1 id="adr-025-validator-plugins-with-configurable-options" tabindex="-1">ADR-025: Validator Plugins with Configurable Options <a class="header-anchor" href="#adr-025-validator-plugins-with-configurable-options" aria-label="Permalink to “ADR-025: Validator Plugins with Configurable Options”">​</a></h1><h2 id="metadata" tabindex="-1">Metadata <a class="header-anchor" href="#metadata" aria-label="Permalink to “Metadata”">​</a></h2><ul><li><strong>Date</strong>: 2025-11-11</li><li><strong>Status</strong>: <strong>Accepted</strong></li><li><strong>Tags</strong>: architecture, validation, plugins, performance, DX</li></ul><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to “Context”">​</a></h2><p>Previously, validators (Zod, Valibot) were baked into the router factory and entry points, making it:</p><ul><li><strong>Tight coupling</strong>: Core router carried validator logic, expanding its surface area</li><li><strong>Inflexible</strong>: Switching validators (Zod ↔ Valibot) required changing imports across the codebase</li><li><strong>One-size-fits-all</strong>: No fine-grained control over validation behavior (e.g., whether to validate outbound payloads)</li></ul><p>Applications need:</p><ol><li><strong>Optional validation</strong>: Opt-in via plugins, not forced by default</li><li><strong>Performance tuning</strong>: Toggle outbound validation, coerce rules, error hooks</li><li><strong>Composable capabilities</strong>: Validators sit alongside pub/sub, rate limiting, telemetry plugins</li><li><strong>Developer ergonomics</strong>: Clear, configurable API that mirrors Zod and Valibot</li></ol><h2 id="decision" tabindex="-1">Decision <a class="header-anchor" href="#decision" aria-label="Permalink to “Decision”">​</a></h2><p>Implement <strong>validator plugins</strong> (<code>withZod()</code>, <code>withValibot()</code>) with configurable options:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> router</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createRouter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    withZod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      validateOutgoing: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Default: true; set false for hot paths</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      coerce: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Zod-specific; pass to schema.parse()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      onValidationError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Custom error handling (opt-in hook)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Validation failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          type: ctx.type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          direction: ctx.direction,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withPubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ adapter: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redisPubSub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() }))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ChatMessage, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ctx.payload validated and typed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span></code></pre></div><h3 id="key-features" tabindex="-1">Key Features <a class="header-anchor" href="#key-features" aria-label="Permalink to “Key Features”">​</a></h3><ol><li><p><strong>Plugin-based</strong>: Validators are pure functions that widen router type</p></li><li><p><strong>Idempotent</strong>: Same plugin applied twice is safely ignored</p></li><li><p><strong>Configurable</strong>:</p><ul><li><code>validateOutgoing?: boolean</code> — Validate <code>ctx.send()</code>, <code>ctx.reply()</code>, <code>ctx.publish()</code> payloads (default: true)</li><li><code>coerce?: boolean</code> — Zod-only; enable schema coercion (default: false)</li><li><code>onValidationError?: (error, context) =&gt; void</code> — Custom error hook (optional; defaults to router.onError)</li></ul></li><li><p><strong>Inbound validation</strong>: Always validates incoming payloads (unless schema missing)</p></li><li><p><strong>Outbound validation</strong>: Validates outbound payloads when enabled (performance knob)</p></li><li><p><strong>Error routing</strong>: Routes validation errors to custom hook or <code>router.onError()</code></p></li></ol><h3 id="mirror-pattern" tabindex="-1">Mirror Pattern <a class="header-anchor" href="#mirror-pattern" aria-label="Permalink to “Mirror Pattern”">​</a></h3><p><code>withValibot()</code> mirrors <code>withZod()</code> API:</p><ul><li>Same option shape (minus Zod-specific <code>coerce</code>)</li><li>Same error handling semantics</li><li>Same capability flag: <code>{ validation: true }</code></li></ul><h2 id="alternatives-considered" tabindex="-1">Alternatives Considered <a class="header-anchor" href="#alternatives-considered" aria-label="Permalink to “Alternatives Considered”">​</a></h2><ol><li><p><strong>Baked-in validators</strong> (status quo)</p><ul><li>✅ Simpler entry point</li><li>❌ Tight coupling, hard to switch, inflexible</li></ul></li><li><p><strong>Multiple entry points per validator</strong></p><ul><li>✅ Customizable at factory time</li><li>❌ Verbose: <code>createRouter({ validator: &#39;zod&#39;, validateOutgoing: true })</code></li><li>❌ No clear capability gating at type level</li></ul></li><li><p><strong>Lazy validation with global config</strong></p><ul><li>✅ Preserves single entry point</li><li>❌ Config scattered, hard to track where validation happens</li><li>❌ Error hooks require global registry</li></ul></li></ol><h2 id="consequences" tabindex="-1">Consequences <a class="header-anchor" href="#consequences" aria-label="Permalink to “Consequences”">​</a></h2><h3 id="benefits" tabindex="-1">Benefits <a class="header-anchor" href="#benefits" aria-label="Permalink to “Benefits”">​</a></h3><ul><li><strong>Smaller core</strong>: Router no longer carries validator logic; stays focused on dispatch</li><li><strong>Flexible composition</strong>: Mix validators with pub/sub, rate limiting, observability plugins</li><li><strong>Performance control</strong>: Disable outbound validation for ultra-hot paths</li><li><strong>Better error handling</strong>: Custom hooks for validation errors (logging, telemetry, recovery)</li><li><strong>Type safety preserved</strong>: Plugin return type is <code>Router&lt;TContext, { validation: true }&gt;</code> ensuring full inference</li></ul><h3 id="risks-mitigations" tabindex="-1">Risks &amp; Mitigations <a class="header-anchor" href="#risks-mitigations" aria-label="Permalink to “Risks &amp; Mitigations”">​</a></h3><table tabindex="0"><thead><tr><th>Risk</th><th>Mitigation</th></tr></thead><tbody><tr><td><strong>Dual package hazard</strong> (types duplication)</td><td>Keep Zod/Valibot as peerDependencies in validator plugins; never re-bundle</td></tr><tr><td><strong>Plugin order sensitivity</strong></td><td>Validators are independent; <code>.on()</code> typing only requires capability flag—order stays flexible</td></tr><tr><td><strong>Runtime overhead</strong></td><td>Offer <code>validateOutgoing: false</code>; per-route opt-outs via middleware filters</td></tr><tr><td><strong>Migration from baked-in</strong></td><td>Provide deprecation period; short migration guide in docs; codemod if needed</td></tr></tbody></table><h3 id="maintenance" tabindex="-1">Maintenance <a class="header-anchor" href="#maintenance" aria-label="Permalink to “Maintenance”">​</a></h3><ul><li><strong>Test coverage</strong>: Both Zod and Valibot plugins mirror-tested (same test suite for adapter)</li><li><strong>Docs</strong>: Update specs with plugin configuration examples, error handling patterns</li><li><strong>Examples</strong>: Show <code>withZod()</code> / <code>withValibot()</code> usage in README and patterns</li></ul><h2 id="references" tabindex="-1">References <a class="header-anchor" href="#references" aria-label="Permalink to “References”">​</a></h2><ul><li><a href="./../specs/router#plugins">Router Spec</a> — Plugin API and capability gating</li><li><a href="./../specs/validation#plugins">Validation Spec</a> — Validation flow with plugins</li><li><a href="./../specs/error-handling#validation-errors">Error Handling</a> — Validation error patterns</li><li>Related: ADR-007 (Export-with-Helpers), ADR-023 (Schema-Driven Type Inference)</li></ul>`,27)])])}const k=a(n,[["render",l]]);export{c as __pageData,k as default};

<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Validation Architecture | ⚡ WS-Kit</title>
    <meta name="description" content="Schema-first WebSocket message router for Bun with TypeScript validation">
    <meta name="generator" content="VitePress v2.0.0-alpha.12">
    <link rel="preload stylesheet" href="/ws-kit/assets/style.DHvKUH02.css" as="style">
    <link rel="preload stylesheet" href="/ws-kit/vp-icons.css" as="style">
    
    <script type="module" src="/ws-kit/assets/app.CznejYud.js"></script>
    <link rel="preload" href="/ws-kit/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/theme.CjGUv2sA.js">
    <link rel="modulepreload" href="/ws-kit/assets/chunks/framework.Crjuurn2.js">
    <link rel="modulepreload" href="/ws-kit/assets/specs_validation.md.CR65mdBu.lean.js">
    <link rel="icon" href="/ws-kit/favicon.ico">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="Bun WebSocket Router | Schema-First WebSocket Routing">
    <meta property="og:site_name" content="Bun WebSocket Router">
    <meta property="og:url" content="https://kriasoft.com/ws-kit/">
    <meta property="og:image" content="https://kriasoft.com/ws-kit/og-image.webp">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-2af48894><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d39e68fc></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-d39e68fc>Skip to content</a><!--]--><!----><header class="VPNav" data-v-2af48894 data-v-2ff86824><div class="VPNavBar" data-v-2ff86824 data-v-94488af8><div class="wrapper" data-v-94488af8><div class="container" data-v-94488af8><div class="title" data-v-94488af8><div class="VPNavBarTitle has-sidebar" data-v-94488af8 data-v-8dd9d0e5><a class="title" href="/ws-kit/" data-v-8dd9d0e5><!--[--><!--]--><!----><span data-v-8dd9d0e5>⚡ WS-Kit</span><!--[--><!--]--></a></div></div><div class="content" data-v-94488af8><div class="content-body" data-v-94488af8><!--[--><!--]--><div class="VPNavBarSearch search" data-v-94488af8><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-94488af8 data-v-f18897e9><span id="main-nav-aria-label" class="visually-hidden" data-v-f18897e9> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/" tabindex="0" data-v-f18897e9 data-v-feb52cf1><!--[--><span data-v-feb52cf1>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/getting-started" tabindex="0" data-v-f18897e9 data-v-feb52cf1><!--[--><span data-v-feb52cf1>Docs</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/ws-kit/posts/" tabindex="0" data-v-f18897e9 data-v-feb52cf1><!--[--><span data-v-feb52cf1>Blog</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-94488af8 data-v-8ac0c769><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-8ac0c769 data-v-74ffed4a data-v-c89a6c8b><span class="check" data-v-c89a6c8b><span class="icon" data-v-c89a6c8b><!--[--><span class="vpi-sun sun" data-v-74ffed4a></span><span class="vpi-moon moon" data-v-74ffed4a></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-94488af8 data-v-f567a889 data-v-508a660e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-bluesky"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-94488af8 data-v-ca322dea data-v-52a27c26><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-52a27c26><span class="vpi-more-horizontal icon" data-v-52a27c26></span></button><div class="menu" data-v-52a27c26><div class="VPMenu" data-v-52a27c26 data-v-e73a4ed6><!----><!--[--><!--[--><!----><div class="group" data-v-ca322dea><div class="item appearance" data-v-ca322dea><p class="label" data-v-ca322dea>Appearance</p><div class="appearance-action" data-v-ca322dea><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-ca322dea data-v-74ffed4a data-v-c89a6c8b><span class="check" data-v-c89a6c8b><span class="icon" data-v-c89a6c8b><!--[--><span class="vpi-sun sun" data-v-74ffed4a></span><span class="vpi-moon moon" data-v-74ffed4a></span><!--]--></span></span></button></div></div></div><div class="group" data-v-ca322dea><div class="item social-links" data-v-ca322dea><div class="VPSocialLinks social-links-list" data-v-ca322dea data-v-508a660e><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kriasoft/ws-kit" aria-label="github" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://discord.gg/aW29wXyb7w" aria-label="discord" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-discord"></span></a><a class="VPSocialLink no-icon" href="https://x.com/kriasoft" aria-label="x" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-x"></span></a><a class="VPSocialLink no-icon" href="https://bsky.app/profile/kriasoft.com" aria-label="bluesky" target="_blank" rel="me noopener" data-v-508a660e data-v-4becd4be><span class="vpi-social-bluesky"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-94488af8 data-v-cd9c971b><span class="container" data-v-cd9c971b><span class="top" data-v-cd9c971b></span><span class="middle" data-v-cd9c971b></span><span class="bottom" data-v-cd9c971b></span></span></button></div></div></div></div><div class="divider" data-v-94488af8><div class="divider-line" data-v-94488af8></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-2af48894 data-v-72b1bb36><div class="container" data-v-72b1bb36><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-72b1bb36><span class="vpi-align-left menu-icon" data-v-72b1bb36></span><span class="menu-text" data-v-72b1bb36>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-72b1bb36 data-v-05f23bae><button data-v-05f23bae>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-2af48894 data-v-f9707c32><div class="curtain" data-v-f9707c32></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f9707c32><span class="visually-hidden" id="sidebar-aria-label" data-v-f9707c32> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-aaaaa457><section class="VPSidebarItem level-0" data-v-aaaaa457 data-v-5704f349><div class="item" role="button" tabindex="0" data-v-5704f349><div class="indicator" data-v-5704f349></div><h2 class="text" data-v-5704f349>Manual</h2><!----></div><div class="items" data-v-5704f349><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/getting-started" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Getting Started</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/core-concepts" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Core Concepts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/message-schemas" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Message Schemas</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/api-reference" data-v-5704f349><!--[--><p class="text" data-v-5704f349>API Reference</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/examples" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Examples</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/advanced-usage" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Advanced Usage</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/deployment" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Deployment</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-aaaaa457><section class="VPSidebarItem level-0" data-v-aaaaa457 data-v-5704f349><div class="item" role="button" tabindex="0" data-v-5704f349><div class="indicator" data-v-5704f349></div><h2 class="text" data-v-5704f349>Guides</h2><!----></div><div class="items" data-v-5704f349><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/guides/rate-limiting" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Rate Limiting</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/guides/on-vs-rpc" data-v-5704f349><!--[--><p class="text" data-v-5704f349>On vs RPC</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/guides/rpc-troubleshooting" data-v-5704f349><!--[--><p class="text" data-v-5704f349>RPC Troubleshooting</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/guides/advanced-multi-runtime" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Advanced Multi-Runtime</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-aaaaa457><section class="VPSidebarItem level-0" data-v-aaaaa457 data-v-5704f349><div class="item" role="button" tabindex="0" data-v-5704f349><div class="indicator" data-v-5704f349></div><h2 class="text" data-v-5704f349>Client</h2><!----></div><div class="items" data-v-5704f349><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/client-setup" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Setup</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/client-api" data-v-5704f349><!--[--><p class="text" data-v-5704f349>API Reference</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/client-auth" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Authentication</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/client-errors" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Error Handling</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link link" href="/ws-kit/client-advanced" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Advanced</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-aaaaa457><section class="VPSidebarItem level-0" data-v-aaaaa457 data-v-5704f349><div class="item" role="button" tabindex="0" data-v-5704f349><div class="indicator" data-v-5704f349></div><h2 class="text" data-v-5704f349>For Developers</h2><!----></div><div class="items" data-v-5704f349><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/ws-kit/tree/main/docs/specs" target="_blank" rel="noreferrer" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Specifications</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/ws-kit/blob/main/docs/adr" target="_blank" rel="noreferrer" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Architecture Decisions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/ws-kit/blob/main/.github/CONTRIBUTING.md" target="_blank" rel="noreferrer" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Contributing</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/kriasoft/ws-kit/blob/main/.github/SECURITY.md" target="_blank" rel="noreferrer" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Security Policy</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5704f349 data-v-5704f349><div class="item" data-v-5704f349><div class="indicator" data-v-5704f349></div><a class="VPLink link vp-external-link-icon link" href="https://github.com/sponsors/koistya" target="_blank" rel="noreferrer" data-v-5704f349><!--[--><p class="text" data-v-5704f349>Sponsor</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-2af48894 data-v-6c0fcb99><div class="VPDoc has-sidebar has-aside" data-v-6c0fcb99 data-v-84fb6ba5><!--[--><!--]--><div class="container" data-v-84fb6ba5><div class="aside" data-v-84fb6ba5><div class="aside-curtain" data-v-84fb6ba5></div><div class="aside-container" data-v-84fb6ba5><div class="aside-content" data-v-84fb6ba5><div class="VPDocAside" data-v-84fb6ba5 data-v-9e561210><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-9e561210 data-v-c4a5ce35><div class="content" data-v-c4a5ce35><div class="outline-marker" data-v-c4a5ce35></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-c4a5ce35>On this page</div><ul class="VPDocOutlineItem root" data-v-c4a5ce35 data-v-952654b8><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-9e561210></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-84fb6ba5><div class="content-container" data-v-84fb6ba5><!--[--><!--]--><main class="main" data-v-84fb6ba5><div style="position:relative;" class="vp-doc _ws-kit_specs_validation" data-v-84fb6ba5><div><h1 id="validation-architecture" tabindex="-1">Validation Architecture <a class="header-anchor" href="#validation-architecture" aria-label="Permalink to “Validation Architecture”">​</a></h1><p><strong>Status</strong>: ✅ Implemented</p><h2 id="validation-vs-application-errors" tabindex="-1">Validation vs Application Errors <a class="header-anchor" href="#validation-vs-application-errors" aria-label="Permalink to “Validation vs Application Errors”">​</a></h2><p><strong>This spec covers validation errors</strong> (router rejects malformed messages before handlers run).</p><p>For <strong>application errors</strong> (handlers send error messages to clients), see @error-handling.md.</p><table tabindex="0"><thead><tr><th>Error Type</th><th>Where Caught</th><th>Handler Invoked?</th><th>Spec</th></tr></thead><tbody><tr><td>Parse failures</td><td>Router (pre-handler)</td><td>❌ Never</td><td>@validation.md</td></tr><tr><td>Schema validation</td><td>Router (pre-handler)</td><td>❌ Never</td><td>@validation.md</td></tr><tr><td>Business logic failures</td><td>Handler (app code)</td><td>✅ Always</td><td>@error-handling.md</td></tr></tbody></table><p><strong>Key distinction</strong>: Validation errors are <strong>transport-layer</strong> concerns (malformed wire format); application errors are <strong>business-layer</strong> concerns (invalid state, unauthorized access, resource not found).</p><h2 id="Flow" tabindex="-1">Flow <a class="header-anchor" href="#Flow" aria-label="Permalink to “Flow”">​</a></h2><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Message → JSON Parse → Type Check → Handler Lookup → Normalize → Middleware → Schema Validation → Handler</span></span></code></pre></div><p><strong>Pipeline stages</strong>:</p><ol><li><strong>Parse</strong>: JSON.parse() the raw WebSocket message</li><li><strong>Type check</strong>: Ensure <code>type</code> field exists and is a string</li><li><strong>Handler lookup</strong>: Find registered handler for message type</li><li><strong>Normalize</strong>: Ensure <code>meta</code> exists, strip reserved keys (security boundary)</li><li><strong>Middleware</strong>: Execute global and per-route middleware (can skip handler)</li><li><strong>Validate</strong>: Schema validation on normalized message (strict mode - see below)</li><li><strong>Handler</strong>: Invoke handler with validated message + server context</li></ol><p>Adapters MUST receive normalized messages for validation.</p><p><strong>Strict mode validation</strong>: Schemas MUST reject unknown keys, including unexpected <code>payload</code> when schema defines none. See @schema.md#Strict-Schemas for rationale and #Strict-Mode-Enforcement below for adapter requirements.</p><h2 id="strict-mode-enforcement" tabindex="-1">Strict Mode Enforcement <a class="header-anchor" href="#strict-mode-enforcement" aria-label="Permalink to “Strict Mode Enforcement”">​</a></h2><p>Adapters MUST configure validators to reject unknown keys at all levels (root, meta, payload).</p><p><strong>Adapter Requirements:</strong></p><table tabindex="0"><thead><tr><th>Validator</th><th>Root Object</th><th>Nested Objects</th></tr></thead><tbody><tr><td>Zod</td><td><code>.strict()</code> on root object</td><td>Recursively applies to nested objects</td></tr><tr><td>Valibot</td><td><code>strictObject()</code></td><td>Use <code>strictObject()</code> for meta and payload</td></tr></tbody></table><p><strong>Validation Behavior:</strong></p><table tabindex="0"><thead><tr><th>Schema Definition</th><th>Wire Message</th><th>Result</th></tr></thead><tbody><tr><td>No <code>payload</code> field</td><td>Includes <code>payload</code> key (even <code>undefined</code> or <code>{}</code>)</td><td>❌ MUST fail validation</td></tr><tr><td>No <code>payload</code> field</td><td>Omits <code>payload</code> key</td><td>✅ MUST pass (if otherwise valid)</td></tr><tr><td>Has <code>payload</code> field</td><td>Omits <code>payload</code> key</td><td>❌ MUST fail validation</td></tr><tr><td>Has <code>payload</code> field</td><td>Includes <code>payload</code> with valid data</td><td>✅ MUST pass (if otherwise valid)</td></tr><tr><td>Any schema</td><td>Unknown keys at root/meta/payload</td><td>❌ MUST fail validation</td></tr></tbody></table><p><strong>Implementation (using export-with-helpers pattern from ADR-007):</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Zod adapter (@ws-kit/zod/src/index.ts)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Shape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ZodRawShape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Shape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ZodRawShape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Shape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ZodRawShape</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ZodSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseShape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    meta: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultMeta, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meta }).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> schema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payload</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseShape, payload: z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payload).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() })</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(baseShape);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schema.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strict</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// CRITICAL: Rejects unknown keys including unexpected &#39;payload&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Valibot adapter (@ws-kit/valibot/src/index.ts)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Shape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  payload</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Shape</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ValibotSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> baseShape</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type: v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    meta: v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strictObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">defaultMeta, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meta }), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Strict for meta</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payload</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strictObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baseShape, payload: v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strictObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(payload) }) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Strict at all levels</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strictObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(baseShape); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Strict at root - rejects unexpected &#39;payload&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Rationale:</strong> Strict validation prevents:</p><ul><li>DoS via unbounded unknown fields</li><li>Handler bugs from unexpected data</li><li>Schema drift between client/server</li><li>Wire protocol violations (e.g., sending <code>payload</code> when schema defines none)</li></ul><p>See @test-requirements.md#Runtime-Testing for test requirements.</p><h2 id="adapter-pattern" tabindex="-1">Adapter Pattern <a class="header-anchor" href="#adapter-pattern" aria-label="Permalink to “Adapter Pattern”">​</a></h2><p>Each validator library requires an adapter:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// zod/adapter.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zodAdapter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ValidatorAdapter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getMessageType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schema.shape.type.value,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schema.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  infer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> schema._type, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// TypeScript only</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p><strong>Adapters receive normalized messages</strong> - The base router MUST normalize before calling <code>safeParse()</code>.</p><h2 id="validation-contract" tabindex="-1">Validation Contract <a class="header-anchor" href="#validation-contract" aria-label="Permalink to “Validation Contract”">​</a></h2><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(schema, data): {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  success: boolean;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ValidatedData;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  error</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ValidationError;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>MUST return</strong>:</p><ul><li><code>success: true</code> + <code>data</code> on valid input</li><li><code>success: false</code> + <code>error</code> on invalid input</li></ul><h2 id="error-handling" tabindex="-1">Error Handling <a class="header-anchor" href="#error-handling" aria-label="Permalink to “Error Handling”">​</a></h2><table tabindex="0"><thead><tr><th>Stage</th><th>Error</th><th>Behavior</th></tr></thead><tbody><tr><td>JSON parse</td><td>Syntax error</td><td>Log + ignore message</td></tr><tr><td>Type check</td><td>Missing <code>type</code> field</td><td>Log + ignore message</td></tr><tr><td>Handler lookup</td><td>No handler found</td><td>Log + ignore message</td></tr><tr><td>Normalize</td><td>Invalid structure</td><td>Pass through (validation will fail)</td></tr><tr><td>Schema validation</td><td>Validation failed</td><td>Log + skip handler</td></tr><tr><td>Handler execution</td><td>Sync/async error</td><td>Log + keep connection open</td></tr></tbody></table><p><strong>Critical</strong>: All errors are logged. Connection stays open unless handler explicitly closes it.</p><h2 id="message-validation-pipeline" tabindex="-1">Message Validation Pipeline <a class="header-anchor" href="#message-validation-pipeline" aria-label="Permalink to “Message Validation Pipeline”">​</a></h2><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// shared/message.ts - MessageRouter.handleMessage()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Capture ingress timestamp FIRST for accuracy in time-sensitive operations</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> receivedAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 1. Parse JSON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> parsedMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 2. Type check</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">parsedMessage.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parsedMessage.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;string&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`[${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}] Invalid message format`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 3. Handler lookup</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> handler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> messageHandlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parsedMessage.type);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">handler) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      `[${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}] No handler for type: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">parsedMessage</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 4. Normalize (security: strip reserved keys, ensure meta exists)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> normalized</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeInboundMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parsedMessage);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 5. Schema validation (on normalized input)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> validator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handler.schema, normalized);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result.success) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`[${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}] Validation failed:`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result.error);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 6. Build context (add server-provided fields)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result.data, ws, receivedAt);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 7. Invoke handler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  handler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`[${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ws</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">clientId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}] Handler error:`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="normalization-rules" tabindex="-1">Normalization Rules <a class="header-anchor" href="#normalization-rules" aria-label="Permalink to “Normalization Rules”">​</a></h2><p><strong>Implementation location</strong>: <code>shared/message.ts</code> in <code>MessageRouter.handleMessage()</code> (see pipeline code below)</p><p><strong>Requirement:</strong> Handlers MUST NOT observe reserved server-only keys from inbound messages.</p><p>Routers MUST strip reserved keys <strong>before</strong> validation to:</p><ul><li>Close spoofing vectors (clients cannot inject server-only fields)</li><li>Keep schemas symmetric (client-side validation works)</li><li>Ensure consistent adapter behavior (all receive sanitized input)</li></ul><p><strong>CANONICAL IMPLEMENTATION</strong> (reference this in code reviews and implementations):</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// shared/normalize.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Reserved server-only meta keys (MUST be stripped before validation)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SOURCE: @rules.md#reserved-keys</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RESERVED_META_KEYS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;clientId&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;receivedAt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// To reserve additional keys in future, add them here AND update:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - @schema.md#Reserved-Server-Only-Meta-Keys</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - @rules.md#reserved-keys</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Schema Creation Enforcement</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Adapters MUST validate that extended meta schemas do not define reserved keys.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * This check occurs in message() helper to fail fast at design time.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validateMetaSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">meta) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> reservedInMeta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(meta).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">k</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    RESERVED_META_KEYS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(k),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (reservedInMeta.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      `Reserved meta keys not allowed in schema: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">reservedInMeta</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;, &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}. `</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        `Reserved keys: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Array</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">RESERVED_META_KEYS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;, &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Called in message() before creating schema:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// validateMetaSchema(meta);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Normalizes inbound message before validation (security boundary).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * MUST be called before schema validation to:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * - Strip reserved server-only keys (prevents spoofing)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * - Ensure meta exists (allows optional client meta)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Mutates in place for performance (hot path, every message).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * Safe: single-threaded per Bun worker (no concurrent access).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * O(k) complexity where k = RESERVED_META_KEYS.size (currently 2).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeInboundMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">raw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;object&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Will fail validation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> msg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> raw </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Ensure meta exists (default to empty object)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg.meta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.meta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;object&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Array.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg.meta)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    msg.meta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Strip reserved server-only keys (security: client cannot set these)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> meta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg.meta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> RESERVED_META_KEYS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> meta[key];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // O(k) where k = RESERVED_META_KEYS.size (currently 2)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Faster than iterating all meta keys: O(n)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> msg;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Unknown key handling:</strong></p><p>Normalization strips <strong>only</strong> reserved server-only keys (<code>clientId</code>, <code>receivedAt</code>).</p><p>Schema validation <strong>MUST</strong> reject messages with unknown keys (strict mode). This ensures:</p><ol><li>Handlers only observe schema-defined fields</li><li>Client-side validation symmetry (same strictness rules)</li><li>Fast failure on malformed/malicious inputs</li></ol><p>See @schema.md#Strict-Schemas for implementation requirements.</p><p><strong>Reserved Server-Only Meta Keys</strong>:</p><ul><li><code>clientId</code>: Connection identity (access via <code>ctx.ws.data.clientId</code>)</li><li><code>receivedAt</code>: Server receive timestamp (access via <code>ctx.receivedAt</code>)</li></ul><p><strong>Rationale</strong>:</p><ul><li>Clients MUST NOT send reserved server-only keys</li><li>Client-provided fields (<code>correlationId</code>, <code>timestamp</code>, extended meta) are preserved</li><li>Normalization is transport-layer security boundary</li></ul><h2 id="context-building" tabindex="-1">Context Building <a class="header-anchor" href="#context-building" aria-label="Permalink to “Context Building”">​</a></h2><p><strong>After validation</strong>, router builds handler context with server-provided fields:</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// shared/context.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buildContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  validated</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  ws</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServerWebSocket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WebSocketData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  receivedAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Captured at message ingress (before parsing)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;...&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ws,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type: validated.type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    meta: validated.meta,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    payload: validated.payload,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Only exists if schema defines it</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    receivedAt,                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Server receive timestamp (ingress time)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    send: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createSendFunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ws),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Server-provided context fields</strong>:</p><ul><li><code>ctx.ws.data.clientId</code>: Connection identity (UUID v7, set during upgrade)</li><li><code>ctx.receivedAt</code>: Server receive timestamp (milliseconds since epoch)</li></ul><p><strong>Why not inject into <code>meta</code></strong>:</p><ul><li><code>clientId</code> is connection state, not message state (already in <code>ctx.ws.data</code>)</li><li><code>receivedAt</code> is server ingress time; separate from optional <code>ctx.meta.timestamp</code> (producer time)</li><li>Keeps message schema clean and client-side validatable</li></ul><p><strong>Which timestamp to use</strong>: <code>ctx.receivedAt</code> is captured at ingress before parsing (server clock, authoritative); <code>meta.timestamp</code> is producer time and may be missing or skewed (client&#39;s clock, untrusted). <strong>Never</strong> base server decisions on <code>meta.timestamp</code>. See @schema.md#Which-timestamp-to-use for detailed guidance.</p><h2 id="key-constraints" tabindex="-1">Key Constraints <a class="header-anchor" href="#key-constraints" aria-label="Permalink to “Key Constraints”">​</a></h2><blockquote><p>See @rules.md for complete rules. Critical for validation:</p></blockquote><ol><li><strong>Normalize before validate</strong> — Strip reserved keys BEFORE schema validation (see @validation.md#normalization-rules)</li><li><strong>Strict mode required</strong> — Schemas MUST reject unknown keys (see @schema.md#Strict-Schemas and #Strict-Mode-Enforcement)</li><li><strong>Validation flow</strong> — Follow exact order: Parse → Type Check → Handler Lookup → Normalize → Validate → Handler (see @rules.md#validation-flow)</li><li><strong>Trust validation</strong> — Handlers MUST NOT re-validate; trust schema (see @rules.md#validation-flow)</li><li><strong>Error handling</strong> — Log validation failures with <code>clientId</code>; keep connections open (see @rules.md#error-handling)</li></ol></div></div></main><footer class="VPDocFooter" data-v-84fb6ba5 data-v-da5da550><!--[--><!--]--><div class="edit-info" data-v-da5da550><div class="edit-link" data-v-da5da550><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kriasoft/ws-kit/edit/main/docs/specs/validation.md" target="_blank" rel="noreferrer" data-v-da5da550><!--[--><span class="vpi-square-pen edit-link-icon" data-v-da5da550></span> Edit this page on GitHub<!--]--></a></div><div class="last-updated" data-v-da5da550><p class="VPLastUpdated" data-v-da5da550 data-v-e8d4d4fd>Last updated: <time datetime="2025-10-30T23:51:20.000Z" data-v-e8d4d4fd></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-da5da550><span class="visually-hidden" id="doc-footer-aria-label" data-v-da5da550>Pager</span><div class="pager" data-v-da5da550><!----></div><div class="pager" data-v-da5da550><a class="VPLink link pager-link next" href="/ws-kit/getting-started" data-v-da5da550><!--[--><span class="desc" data-v-da5da550>Next page</span><span class="title" data-v-da5da550>Getting Started</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-2af48894 data-v-5381ed81><div class="container" data-v-5381ed81><p class="message" data-v-5381ed81>Released under the <a href="https://github.com/kriasoft/ws-kit/blob/main/LICENSE">MIT License</a>.</p><p class="copyright" data-v-5381ed81>Copyright © 2025-present <a href="https://kriasoft.com" target="_self">Kriasoft</a> · Created by <a href="https://github.com/koistya">Konstantin Tarkus</a></p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"adr_000-template.md\":\"BOsX3jhA\",\"adr_001-message-context-conditional-payload-typing.md\":\"CORU7mkC\",\"adr_002-typed-client-adapters.md\":\"-ra-Ulek\",\"adr_003-example-imports.md\":\"B1mFV6yb\",\"adr_005-builder-pattern-and-symbol-escape-hatch.md\":\"CqdVHFYb\",\"adr_006-multi-runtime-serve-with-explicit-selection.md\":\"kOdvq8Me\",\"adr_007-export-with-helpers-pattern.md\":\"DYYan0lJ\",\"adr_008-middleware-support.md\":\"y9lF6lnu\",\"adr_009-error-handling-and-lifecycle-hooks.md\":\"BSaWMZjs\",\"adr_010-throttled-broadcast-pattern.md\":\"CrxKHrAD\",\"adr_011-structured-logging-adapter.md\":\"CG36A77k\",\"adr_012-rpc-minimal-reliable.md\":\"BKXn1l9T\",\"adr_013-rpc-reconnect-idempotency.md\":\"BzgFWIst\",\"adr_014-rpc-dx-safety-improvements.md\":\"djBsBRJh\",\"adr_015-unified-rpc-api-design.md\":\"BcbNLhk_\",\"adr_016-connection-data-api-naming.md\":\"Bkwx8knD\",\"adr_017-message-api-parameter-naming.md\":\"R6Ps1dgq\",\"adr_018-broadcast-method-naming.md\":\"gLgNj_HF\",\"adr_019-ctx-publish-convenience-method.md\":\"3WceOSZH\",\"adr_020-send-method-naming.md\":\"C9qN2qn8\",\"adr_021-adapter-first-architecture.md\":\"C4_nJVMp\",\"adr_archive_004-typed-router-factory.md\":\"CJD7w9QT\",\"adr_readme.md\":\"eQVV7meS\",\"advanced-usage.md\":\"xz6PhoF1\",\"api-reference.md\":\"YwX9fDpd\",\"bun.md\":\"Cv1dG1iq\",\"client-advanced.md\":\"gKtiANAS\",\"client-api.md\":\"BXlVFP_u\",\"client-auth.md\":\"CHv0h6BC\",\"client-errors.md\":\"D47P5Wmc\",\"client-setup.md\":\"BXuzM_rv\",\"core-concepts.md\":\"Dz5uuObE\",\"deployment.md\":\"Dnik1-qD\",\"eslint-config.md\":\"jwdCJYIz\",\"examples.md\":\"QP9v7B9Y\",\"getting-started.md\":\"BjolYCaL\",\"guides_advanced-multi-runtime.md\":\"Dbcgcunw\",\"guides_on-vs-rpc.md\":\"B3UAMrNn\",\"guides_rate-limiting.md\":\"Cx0JkWK4\",\"guides_rpc-troubleshooting.md\":\"Cs5qUCYH\",\"index.md\":\"tTEZmYsl\",\"invariants.md\":\"CsorbGDl\",\"message-schemas.md\":\"CSLP89CH\",\"middleware.md\":\"BnFt-1E4\",\"patterns_delta-sync.md\":\"P97D_k6d\",\"patterns_flow-control.md\":\"wou0tZ-A\",\"patterns_readme.md\":\"D5nNPGSu\",\"patterns_state-channels.md\":\"DWiOjZIp\",\"posts_building-websocket-router.md\":\"B-CB54TM\",\"posts_index.md\":\"DiRV0UMx\",\"posts_token-bucket-policies.md\":\"DO-uhL1M\",\"posts_two-timestamps-one-message.md\":\"Aq9xDzNx\",\"proposals_problems.local.md\":\"DLFL-wPe\",\"proposals_publish-issues.local.md\":\"C-erOXNx\",\"proposals_rate-limiting.md\":\"fxR0x3Ym\",\"rpc.md\":\"HzgMHX0F\",\"specs_adapters.md\":\"COyf9LCf\",\"specs_broadcasting.md\":\"C_jYk6T3\",\"specs_client.md\":\"JJmUDR-x\",\"specs_error-handling.md\":\"BLOmA0AP\",\"specs_patterns.md\":\"CMXA_q3o\",\"specs_readme.md\":\"DW-QsSUx\",\"specs_router.md\":\"DKTNfji0\",\"specs_rules.md\":\"Dq7O_Ag-\",\"specs_schema.md\":\"Dn_g2g0q\",\"specs_test-requirements.md\":\"DMv2ahvv\",\"specs_validation.md\":\"CR65mdBu\",\"valibot-integration.md\":\"NFXRt_c0\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"⚡ WS-Kit\",\"description\":\"Schema-first WebSocket message router for Bun with TypeScript validation\",\"base\":\"/ws-kit/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Docs\",\"link\":\"/getting-started\"},{\"text\":\"Blog\",\"link\":\"/posts/\"}],\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/kriasoft/ws-kit/edit/main/docs/:path\",\"text\":\"Edit this page on GitHub\"},\"sidebar\":[{\"text\":\"Manual\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/getting-started\"},{\"text\":\"Core Concepts\",\"link\":\"/core-concepts\"},{\"text\":\"Message Schemas\",\"link\":\"/message-schemas\"},{\"text\":\"API Reference\",\"link\":\"/api-reference\"},{\"text\":\"Examples\",\"link\":\"/examples\"},{\"text\":\"Advanced Usage\",\"link\":\"/advanced-usage\"},{\"text\":\"Deployment\",\"link\":\"/deployment\"}]},{\"text\":\"Guides\",\"items\":[{\"text\":\"Rate Limiting\",\"link\":\"/guides/rate-limiting\"},{\"text\":\"On vs RPC\",\"link\":\"/guides/on-vs-rpc\"},{\"text\":\"RPC Troubleshooting\",\"link\":\"/guides/rpc-troubleshooting\"},{\"text\":\"Advanced Multi-Runtime\",\"link\":\"/guides/advanced-multi-runtime\"}]},{\"text\":\"Client\",\"items\":[{\"text\":\"Setup\",\"link\":\"/client-setup\"},{\"text\":\"API Reference\",\"link\":\"/client-api\"},{\"text\":\"Authentication\",\"link\":\"/client-auth\"},{\"text\":\"Error Handling\",\"link\":\"/client-errors\"},{\"text\":\"Advanced\",\"link\":\"/client-advanced\"}]},{\"text\":\"For Developers\",\"items\":[{\"text\":\"Specifications\",\"link\":\"https://github.com/kriasoft/ws-kit/tree/main/docs/specs\"},{\"text\":\"Architecture Decisions\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/docs/adr\"},{\"text\":\"Contributing\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/CONTRIBUTING.md\"},{\"text\":\"Security Policy\",\"link\":\"https://github.com/kriasoft/ws-kit/blob/main/.github/SECURITY.md\"},{\"text\":\"Sponsor\",\"link\":\"https://github.com/sponsors/koistya\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/kriasoft/ws-kit\"},{\"icon\":\"discord\",\"link\":\"https://discord.gg/aW29wXyb7w\"},{\"icon\":\"x\",\"link\":\"https://x.com/kriasoft\"},{\"icon\":\"bluesky\",\"link\":\"https://bsky.app/profile/kriasoft.com\"}],\"footer\":{\"message\":\"Released under the <a href=\\\"https://github.com/kriasoft/ws-kit/blob/main/LICENSE\\\">MIT License</a>.\",\"copyright\":\"Copyright © 2025-present <a href=\\\"https://kriasoft.com\\\" target=\\\"_self\\\">Kriasoft</a> · Created by <a href=\\\"https://github.com/koistya\\\">Konstantin Tarkus</a>\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true,\"additionalConfig\":{}}");</script>
    
  </body>
</html>